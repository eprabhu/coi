DELIMITER //
CREATE PROCEDURE `MARK_DISCLOSURES_AS_EXPIRED`()
BEGIN
DECLARE LS_OPA_LOG_DESCRIPTION VARCHAR(200);
DECLARE LS_COI_LOG_DESCRIPTION VARCHAR(200);

    -- GET OPA LOG DESCRIPTION
    SELECT MESSAGE INTO LS_OPA_LOG_DESCRIPTION 
    FROM OPA_ACTION_LOG_TYPE 
    WHERE ACTION_TYPE_CODE = 22;

    -- GET COI LOG DESCRIPTION 
    SELECT MESSAGE INTO LS_COI_LOG_DESCRIPTION 
    FROM DISCLOSURE_ACTION_TYPE 
    WHERE ACTION_TYPE_CODE = 12;

    -- DISABLE SAFE UPDATES TEMPORARILY
    SET SQL_SAFE_UPDATES = 0;
    START TRANSACTION;
	
        -- DROP TEMP TABLE IF EXISTS
    DROP TEMPORARY TABLE IF EXISTS TEMP_EXPIRED_DISCLOSURES_TO_NOTIFY;
    
	 -- CREATE TEMP TABLE TO STORE COMBINED DISCLOSURES
    CREATE TEMPORARY TABLE TEMP_EXPIRED_DISCLOSURES_TO_NOTIFY (
        DISCLOSURE_ID INT,
        DISCLOSURE_NUMBER VARCHAR(100),
        DISCLOSURE_TYPE VARCHAR(50)
    );

    -- INSERT EXPIRED OPA DISCLOSURES
    INSERT INTO TEMP_EXPIRED_DISCLOSURES_TO_NOTIFY (DISCLOSURE_ID, DISCLOSURE_NUMBER, DISCLOSURE_TYPE)
    SELECT 
        D.OPA_DISCLOSURE_ID,        
        D.OPA_DISCLOSURE_NUMBER,
        'OPA'
    FROM OPA_DISCLOSURE D
    WHERE D.OPA_DISCLOSURE_ID = (
        SELECT MAX(OPA_DISCLOSURE_ID)
        FROM OPA_DISCLOSURE D2
        WHERE D2.OPA_DISCLOSURE_NUMBER = D.OPA_DISCLOSURE_NUMBER
    )
    AND D.OPA_DISCLOSURE_NUMBER IN (
        SELECT DISTINCT OPA_DISCLOSURE_NUMBER
        FROM OPA_DISCLOSURE
        WHERE DISPOSITION_STATUS_CODE = '3'
          AND VERSION_STATUS = 'ACTIVE'
          AND EXPIRATION_DATE < DATE(UTC_TIMESTAMP())
    )
    AND (
        D.EXPIRATION_DATE < DATE(UTC_TIMESTAMP())
        OR D.REVIEW_STATUS_CODE IN (1, 5, 6)
    );

    -- INSERT EXPIRED COI DISCLOSURES
    INSERT INTO TEMP_EXPIRED_DISCLOSURES_TO_NOTIFY (DISCLOSURE_ID, DISCLOSURE_NUMBER, DISCLOSURE_TYPE)
    SELECT 
        CD.DISCLOSURE_ID,
        CD.DISCLOSURE_NUMBER,
        CASE CD.FCOI_TYPE_CODE
            WHEN '2' THEN 'PROJECT'
            ELSE 'FCOI'
        END
    FROM COI_DISCLOSURE CD
    WHERE CD.DISCLOSURE_ID = (
        SELECT MAX(DISCLOSURE_ID)
        FROM COI_DISCLOSURE CD2
        WHERE CD2.DISCLOSURE_NUMBER = CD.DISCLOSURE_NUMBER
    )
    AND CD.DISCLOSURE_NUMBER IN (
        SELECT DISTINCT DISCLOSURE_NUMBER
        FROM COI_DISCLOSURE
        WHERE DISPOSITION_STATUS_CODE = '3'
          AND VERSION_STATUS = 'ACTIVE'
          AND EXPIRATION_DATE < DATE(UTC_TIMESTAMP())
    )
    AND (
        CD.EXPIRATION_DATE < DATE(UTC_TIMESTAMP())
        OR CD.REVIEW_STATUS_CODE IN (1, 5, 6)
    );

    -- INSERT ACTION LOGS FOR OPA
    INSERT INTO OPA_ACTION_LOG (
        OPA_DISCLOSURE_ID,
        OPA_DISCLOSURE_NUMBER,
        ACTION_TYPE_CODE,
        DESCRIPTION,
        UPDATE_TIMESTAMP
    )
    SELECT 
        D.OPA_DISCLOSURE_ID,
        D.OPA_DISCLOSURE_NUMBER,
        22,
        LS_OPA_LOG_DESCRIPTION,
        UTC_TIMESTAMP()
    FROM OPA_DISCLOSURE D
    WHERE D.DISPOSITION_STATUS_CODE = '3'
      AND D.VERSION_STATUS = 'ACTIVE'
      AND D.EXPIRATION_DATE < DATE(UTC_TIMESTAMP());

    -- INSERT ACTION LOGS FOR COI
    INSERT INTO DISCLOSURE_ACTION_LOG (
        DISCLOSURE_ID,
        DISCLOSURE_NUMBER,
        ACTION_TYPE_CODE,
        DESCRIPTION,
        UPDATE_TIMESTAMP
    )
    SELECT 
        CD.DISCLOSURE_ID,
        CD.DISCLOSURE_NUMBER,
        12,
        REPLACE(
            LS_COI_LOG_DESCRIPTION,
            '{FCOI /PROJECT /TRAVEL}',
            (SELECT DESCRIPTION FROM COI_DISCLOSURE_FCOI_TYPE WHERE FCOI_TYPE_CODE = CD.FCOI_TYPE_CODE)
        ) AS DESCRIPTION,
        UTC_TIMESTAMP()
    FROM COI_DISCLOSURE CD
    WHERE CD.DISPOSITION_STATUS_CODE = '3'
      AND CD.VERSION_STATUS = 'ACTIVE'
      AND CD.EXPIRATION_DATE < DATE(UTC_TIMESTAMP());

    -- UPDATE OPA DISCLOSURES
    UPDATE OPA_DISCLOSURE D
    SET D.DISPOSITION_STATUS_CODE = 4
    WHERE D.DISPOSITION_STATUS_CODE = '3'
      AND D.VERSION_STATUS = 'ACTIVE'
      AND D.EXPIRATION_DATE < DATE(UTC_TIMESTAMP());

    -- UPDATE COI DISCLOSURES
    UPDATE COI_DISCLOSURE CD
    SET CD.DISPOSITION_STATUS_CODE = 4
    WHERE CD.DISPOSITION_STATUS_CODE = '3'
      AND CD.VERSION_STATUS = 'ACTIVE'
      AND CD.EXPIRATION_DATE < DATE(UTC_TIMESTAMP());
    COMMIT;

    -- RE-ENABLE SAFE UPDATES
    SET SQL_SAFE_UPDATES = 1;

    -- RETURN FINAL RESULT FROM TEMP TABLE
    SELECT * FROM TEMP_EXPIRED_DISCLOSURES_TO_NOTIFY;
    
        -- DROP TEMP TABLE IF EXISTS
    DROP TEMPORARY TABLE IF EXISTS TEMP_EXPIRED_DISCLOSURES_TO_NOTIFY;
END
//
