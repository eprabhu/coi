DELIMITER //
CREATE FUNCTION `FN_IS_SABB_FILLED_IN_DISCL_ENG`(
    AV_OPA_DISCLOSURE_ID VARCHAR(100)
) RETURNS TINYINT(1)
    DETERMINISTIC
BEGIN

    DECLARE LS_IS_VALID BOOLEAN DEFAULT TRUE;

    SELECT
      CASE
        WHEN (D.IS_FALL_SABATICAL = 'Y' AND NOT EXISTS (
            SELECT 1
            FROM OPA_DISCL_PERSON_ENTITY_REL R
            INNER JOIN PERSON_ENTITY t2 ON t2.PERSON_ENTITY_ID = R.PERSON_ENTITY_ID
            INNER JOIN PER_ENT_DISCL_TYPE_SELECTION t3 ON t3.PERSON_ENTITY_ID = t2.PERSON_ENTITY_ID AND t3.DISCLOSURE_TYPE_CODE = 2
            WHERE R.DISCLOSURE_ID = D.OPA_DISCLOSURE_ID
              AND R.IS_FALL_SABATICAL = 'Y'
              AND t2.VERSION_STATUS = 'ACTIVE'
        )) THEN FALSE
        WHEN (D.IS_SPRING_SABATICAL = 'Y' AND NOT EXISTS (
            SELECT 1
            FROM OPA_DISCL_PERSON_ENTITY_REL R
            INNER JOIN PERSON_ENTITY t2 ON t2.PERSON_ENTITY_ID = R.PERSON_ENTITY_ID
            INNER JOIN PER_ENT_DISCL_TYPE_SELECTION t3 ON t3.PERSON_ENTITY_ID = t2.PERSON_ENTITY_ID AND t3.DISCLOSURE_TYPE_CODE = 2
            WHERE R.DISCLOSURE_ID = D.OPA_DISCLOSURE_ID
              AND R.IS_SPRING_SABATICAL = 'Y'
              AND t2.VERSION_STATUS = 'ACTIVE'
        )) THEN FALSE
        ELSE TRUE
      END AS IS_VALID into LS_IS_VALID
    FROM OPA_DISCLOSURE D
    WHERE D.OPA_DISCLOSURE_ID = AV_OPA_DISCLOSURE_ID;

   RETURN LS_IS_VALID;
END
//
