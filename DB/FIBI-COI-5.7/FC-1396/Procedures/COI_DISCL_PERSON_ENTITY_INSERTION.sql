DELIMITER //
CREATE PROCEDURE `COI_DISCL_PERSON_ENTITY_INSERTION`(
	AV_DISCLOSURE_ID 					INT,
	AV_UPDATED_BY        				VARCHAR(60),
	AV_SFI_JSON_ARRAY      				JSON
)
BEGIN

	DECLARE i INT DEFAULT 0;
    DECLARE array_length INT DEFAULT JSON_LENGTH(AV_SFI_JSON_ARRAY);
    DECLARE LI_ENTITY_ID INT;
	DECLARE LI_PERSON_ENTITY_ID INT;
    DECLARE LI_PERSON_ENTITY_NUMBER VARCHAR(50);
    
    WHILE i < array_length DO
        SET @json_obj = JSON_EXTRACT(AV_SFI_JSON_ARRAY, CONCAT('$[', i, ']'));
        SET LI_ENTITY_ID = JSON_UNQUOTE(JSON_EXTRACT(@json_obj, '$.ENTITY_ID'));
        SET LI_PERSON_ENTITY_ID = JSON_UNQUOTE(JSON_EXTRACT(@json_obj, '$.PERSON_ENTITY_ID'));
        SET LI_PERSON_ENTITY_NUMBER = JSON_UNQUOTE(JSON_EXTRACT(@json_obj, '$.PERSON_ENTITY_NUMBER'));
        
        INSERT INTO COI_DISCL_PERSON_ENTITY_REL (
                DISCLOSURE_ID, PERSON_ENTITY_ID, PERSON_ENTITY_NUMBER, ENTITY_ID, UPDATED_BY, UPDATE_TIMESTAMP)
            VALUES (
                AV_DISCLOSURE_ID, LI_PERSON_ENTITY_ID, LI_PERSON_ENTITY_NUMBER, LI_ENTITY_ID, AV_UPDATED_BY, UTC_TIMESTAMP());

	SET i = i + 1;
    END WHILE;

END
//
