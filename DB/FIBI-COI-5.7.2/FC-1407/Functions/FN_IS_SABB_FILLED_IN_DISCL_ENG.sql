DELIMITER //
CREATE FUNCTION `FN_IS_SABB_FILLED_IN_DISCL_ENG`(
    AV_OPA_DISCLOSURE_ID VARCHAR(100)
) RETURNS TINYINT(1)
    DETERMINISTIC
BEGIN
    DECLARE LS_PERSON_ID VARCHAR(100);
    DECLARE LS_SABBATICAL VARCHAR(100);
    DECLARE LI_MATCH_COUNT INT DEFAULT 0;
    DECLARE LI_TOTAL_PARTS INT DEFAULT 0;

    SELECT PERSON_ID
    INTO LS_PERSON_ID
    FROM OPA_DISCLOSURE
    WHERE OPA_DISCLOSURE_ID = AV_OPA_DISCLOSURE_ID;

    SELECT PAYROLL_RANK
    INTO LS_SABBATICAL
    FROM OPA_PERSON
    WHERE PERSON_ID = LS_PERSON_ID;

    SET LI_MATCH_COUNT = (
        SELECT COUNT(DISTINCT SAB.SAB_PART)
        FROM (
            SELECT TRIM(SUBSTRING_INDEX(SUBSTRING_INDEX(LS_SABBATICAL, ',', NUMBERS.N), ',', -1)) AS SAB_PART
            FROM (
                SELECT 1 AS N UNION SELECT 2 UNION SELECT 3 UNION SELECT 4
            ) NUMBERS
            WHERE N <= 1 + LENGTH(LS_SABBATICAL) - LENGTH(REPLACE(LS_SABBATICAL, ',', ''))
        ) SAB
        WHERE EXISTS (
            SELECT 1
            FROM OPA_DISCL_PERSON_ENTITY_REL REL
            JOIN PERSON_ENTITY PE ON REL.PERSON_ENTITY_ID = PE.PERSON_ENTITY_ID
            WHERE REL.DISCLOSURE_ID = AV_OPA_DISCLOSURE_ID
              AND PE.VERSION_STATUS = 'ACTIVE'
              AND (
                  SABBATICAL_TYPE LIKE CONCAT('%', SAB.SAB_PART, '%')
              )
        )
    );

    SET LI_TOTAL_PARTS = 1 + LENGTH(LS_SABBATICAL) - LENGTH(REPLACE(LS_SABBATICAL, ',', ''));

   RETURN LI_MATCH_COUNT = LI_TOTAL_PARTS;
END
//
