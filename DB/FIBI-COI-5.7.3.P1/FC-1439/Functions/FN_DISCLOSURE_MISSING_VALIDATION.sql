DELIMITER //
CREATE FUNCTION `FN_DISCLOSURE_MISSING_VALIDATION`(AV_PROPOSAL_ID INT) RETURNS varchar(10)
    READS SQL DATA
    DETERMINISTIC
BEGIN
    DECLARE MISSING_COUNT INT;
    -- Count number of persons who either have no disclosure or disclosure older than 3 months
    SELECT COUNT(*) INTO MISSING_COUNT
    FROM EPS_PROPOSAL_PERSONS epp
    LEFT JOIN (
        SELECT PERSON_ID, MAX(CERTIFIED_AT) AS LAST_CERTIFIED_AT
        FROM COI_DISCLOSURE
        WHERE VERSION_STATUS IN ('ACTIVE', 'PENDING')
        AND REVIEW_STATUS_CODE NOT IN ('1', '5', '6')
        GROUP BY PERSON_ID
    ) cd ON epp.PERSON_ID = cd.PERSON_ID
    WHERE epp.PROPOSAL_ID = AV_PROPOSAL_ID
		AND epp.PERSON_ID IS NOT NULL
		AND (cd.LAST_CERTIFIED_AT IS NULL OR cd.LAST_CERTIFIED_AT < DATE_SUB(NOW(), INTERVAL 3 MONTH));
    IF MISSING_COUNT > 0 THEN
        RETURN 'FALSE';
    ELSE
        RETURN 'TRUE';
    END IF;
END
//
