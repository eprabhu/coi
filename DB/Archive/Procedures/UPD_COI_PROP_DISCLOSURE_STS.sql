DELIMITER //
CREATE PROCEDURE `UPD_COI_PROP_DISCLOSURE_STS`(AV_PROPOSAL_NUMBER VARCHAR(20),
										 	AV_PERSON_ID  VARCHAR(500)
											)
BEGIN
	DECLARE LS_DYN_SQL					LONGTEXT;											


	SET LS_DYN_SQL ='';
	
	SET SQL_SAFE_UPDATES = 0;
	IF AV_PERSON_ID IS NOT NULL THEN
	SET  LS_DYN_SQL = CONCAT('UPDATE COI_INT_STAGE_DEV_PROPOSAL_PERSON  CPP
					SET CPP.DISCLOSURE_STATUS =
					CASE
						WHEN CPP.DISCLOSURE_REQUIRED_FLAG = ''REQUIRED''
							THEN (SELECT CASE
								WHEN CDI.REVIEW_STATUS_CODE IN (2,3,4,7,8)
									THEN ''DISCLOSURE_COMPLETED''
							   ELSE ''DISCLOSURE_PENDING''
							END
							FROM  COI_DISCLOSURE CDI
							WHERE CDI.DISCLOSURE_ID = (SELECT MAX(CD1.DISCLOSURE_ID)
														FROM COI_DISCLOSURE CD1,
														     COI_DISCL_PROJECTS CDP
														WHERE CDP.MODULE_CODE = ''3''
														  AND CDP.MODULE_ITEM_KEY = CPP.PROPOSAL_NUMBER 														  
														  AND CD1.DISCLOSURE_ID = CDP.DISCLOSURE_ID 	
														  AND CD1.PERSON_ID = CPP.KEY_PERSON_ID )
									)					  
						WHEN CPP.DISCLOSURE_REQUIRED_FLAG = ''NOT_REQUIRED''
							THEN ''DISCLOSURE_NOT_REQUIRED''
						ELSE ''DISCLOSURE_TO_BE_DETERMINED''
					END ,
					 CPP.DISCLOSURE_REVIEW_STATUS = CASE
						WHEN CPP.DISCLOSURE_REQUIRED_FLAG = ''REQUIRED''
							THEN (SELECT CRS.DESCRIPTION
							       FROM COI_REVIEW_STATUS_TYPE CRS,
									    COI_DISCLOSURE CDI
							WHERE CRS.REVIEW_STATUS_CODE = CDI.REVIEW_STATUS_CODE
							  AND CDI.DISCLOSURE_ID = (SELECT MAX(CD1.DISCLOSURE_ID)
														FROM COI_DISCLOSURE CD1,
														     COI_DISCL_PROJECTS CDP
														WHERE CDP.MODULE_CODE = ''3''
														  AND CDP.MODULE_ITEM_KEY = CPP.PROPOSAL_NUMBER 														  
														  AND CD1.DISCLOSURE_ID = CDP.DISCLOSURE_ID 	
														  AND CD1.PERSON_ID = CPP.KEY_PERSON_ID )
									)				
						WHEN CPP.DISCLOSURE_REQUIRED_FLAG = ''NOT_REQUIRED''
							THEN ''DISCLOSURE_REVIEW_NA''
						ELSE NULL
					END
				WHERE CPP.KEY_PERSON_ID IN (',AV_PERSON_ID,')
				  AND CPP.STATUS = ''A''
				  AND CPP.PROPOSAL_NUMBER = ''', AV_PROPOSAL_NUMBER,'''');
				 
			 SELECT LS_DYN_SQL;
			
			SET @QUERY_STATEMENT = LS_DYN_SQL;
			PREPARE EXECUTABLE_STAEMENT FROM @QUERY_STATEMENT;
			EXECUTE EXECUTABLE_STAEMENT;
		
			   
		END IF;
		
		
		
		 UPDATE COI_INT_STAGE_DEV_PROPOSAL  CIP 
		   SET CIP.OVERALL_DISCLOSURE_STATUS = CASE 
												WHEN  EXISTS (
																SELECT 1
																FROM COI_INT_STAGE_DEV_PROPOSAL_PERSON
																WHERE PROPOSAL_NUMBER = CIP.PROPOSAL_NUMBER
																   AND (DISCLOSURE_STATUS = 'DISCLOSURE_TO_BE_DETERMINED' 
                                                                   OR DISCLOSURE_STATUS IS NULL) 
																  AND STATUS = 'A'
															) THEN 'DISCLOSURE_TO_BE_DETERMINED'
												WHEN EXISTS (
																SELECT 1
																FROM COI_INT_STAGE_DEV_PROPOSAL_PERSON
																WHERE PROPOSAL_NUMBER = CIP.PROPOSAL_NUMBER
																  AND DISCLOSURE_STATUS = 'DISCLOSURE_PENDING' 
																  AND STATUS = 'A'
															) THEN 'DISCLOSURE_PENDING'	
												WHEN NOT EXISTS (
																SELECT 1
																FROM COI_INT_STAGE_DEV_PROPOSAL_PERSON
																WHERE PROPOSAL_NUMBER = CIP.PROPOSAL_NUMBER
																  AND DISCLOSURE_STATUS NOT IN ('DISCLOSURE_NOT_REQUIRED')
																  AND STATUS = 'A'
															) THEN 'DISCLOSURE_NOT_REQUIRED'
		   
												WHEN NOT EXISTS (
																	SELECT 1
																	FROM COI_INT_STAGE_DEV_PROPOSAL_PERSON
																	WHERE PROPOSAL_NUMBER = CIP.PROPOSAL_NUMBER
																	  AND DISCLOSURE_STATUS NOT IN ('DISCLOSURE_COMPLETED','DISCLOSURE_NOT_REQUIRED')
																	  AND STATUS = 'A'
													            ) THEN 'DISCLOSURE_COMPLETED'
												END
		 WHERE  CIP.PROPOSAL_NUMBER = AV_PROPOSAL_NUMBER;
									  
									  
		UPDATE COI_INT_STAGE_DEV_PROPOSAL  CIP
		   SET CIP.OVERALL_DISCL_REVIEW_STATUS = CASE 
												WHEN OVERALL_DISCLOSURE_STATUS = 'DISCLOSURE_NOT_REQUIRED' THEN 'N/A'																														
												WHEN OVERALL_DISCLOSURE_STATUS = 'DISCLOSURE_TO_BE_DETERMINED' THEN '--'
												WHEN NOT EXISTS (
																	SELECT 1
																	FROM COI_INT_STAGE_DEV_PROPOSAL_PERSON
																	WHERE PROPOSAL_NUMBER = CIP.PROPOSAL_NUMBER
                                                                    AND STATUS = 'A'
																	  AND DISCLOSURE_REVIEW_STATUS NOT IN ('Completed','DISCLOSURE_REVIEW_NA')
													            ) THEN 'Completed'
												ELSE 'Pending'
												END
		 WHERE  CIP.PROPOSAL_NUMBER = AV_PROPOSAL_NUMBER;										   

		SET SQL_SAFE_UPDATES = 1; 
END
//
