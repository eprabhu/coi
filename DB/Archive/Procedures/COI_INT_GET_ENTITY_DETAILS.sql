DELIMITER //
CREATE PROCEDURE COI_INT_GET_ENTITY_DETAILS(IN AV_ENTITY_ID INT)
BEGIN
   
   IF AV_ENTITY_ID IS NOT NULL OR AV_ENTITY_ID <> '' THEN 
      SELECT 
        ETY.ENTITY_ID,
        ETY.CERTIFIED_EMAIL,
        ETY.CREATED_BY,
        ETY.UPDATED_BY,
        ETY.UEI_NUMBER,
        ETY.CAGE_NUMBER,
        ETY.DUNS_NUMBER,
        ETY.ENTITY_ID,
        (SELECT SUBSTR(CONVERT(ET.TELEPHONE_NUMBER , CHAR),1,20)
         FROM ENTITY_TELEPHONE ET
         WHERE ET.ENTITY_ID = ETY.ENTITY_ID
         LIMIT 1
        ) AS TELEPHONE_NUMBER
    FROM ENTITY ETY
    LEFT JOIN ENTITY_SPONSOR_INFO ESI ON ESI.ENTITY_ID = ETY.ENTITY_ID
    LEFT JOIN ENTITY_SUB_ORG_INFO ESOI ON ESOI.ENTITY_ID = ETY.ENTITY_ID
    WHERE ETY.ENTITY_ID = AV_ENTITY_ID
	AND (ESI.FEED_STATUS_CODE IN ('2', '4')
    OR ESOI.FEED_STATUS_CODE IN ('2', '4'));

    ELSE

          SELECT
        ETY.ENTITY_ID,
        ETY.CERTIFIED_EMAIL,
        ETY.CREATED_BY,
        ETY.UPDATED_BY,
        ETY.UEI_NUMBER,
        ETY.CAGE_NUMBER,
        ETY.DUNS_NUMBER,
        ETY.ENTITY_ID,
        SUBSTR(ETY.HUMAN_SUB_ASSURANCE,1,30) AS HUMAN_SUB_ASSURANCE,
        SUBSTR(ETY.ANIMAL_WELFARE_ASSURANCE,1,20) AS ANIMAL_WELFARE_ASSURANCE,
        (SELECT SUBSTR(CONVERT(ET.TELEPHONE_NUMBER , CHAR),1,20)
         FROM ENTITY_TELEPHONE ET
         WHERE ET.ENTITY_ID = ETY.ENTITY_ID
         LIMIT 1
        ) AS TELEPHONE_NUMBER
    FROM ENTITY ETY
    LEFT JOIN ENTITY_SPONSOR_INFO ESI ON ESI.ENTITY_ID = ETY.ENTITY_ID
    LEFT JOIN ENTITY_SUB_ORG_INFO ESOI ON ESOI.ENTITY_ID = ETY.ENTITY_ID
    WHERE (ESI.FEED_STATUS_CODE IN ('2', '4')
    OR ESOI.FEED_STATUS_CODE IN ('2', '4'));
    
    END IF;

END
//
