DELIMITER //
CREATE PROCEDURE `FCOI_DISCLOSRE_RENEWAL_REMINDER`(AV_DAYS INT)
BEGIN
	SELECT DISTINCT t1.DISCLOSURE_ID AS MODULE_ITEM_KEY, 0 AS SUB_MODULE_ITEM_KEY, 8 AS MODULE_CODE, 0 AS SUB_MODULE_CODE
	FROM COI_DISCLOSURE t1
	INNER JOIN COI_DISCL_PROJECTS t4 ON t4.DISCLOSURE_ID = t1.DISCLOSURE_ID
	WHERE t1.FCOI_TYPE_CODE != 2
	AND t1.VERSION_STATUS = 'ACTIVE'
	AND DATE(EXPIRATION_DATE) = DATE_ADD(UTC_DATE(), INTERVAL AV_DAYS DAY))
	AND t1.DISCLOSURE_ID = (
        SELECT MAX(DISCLOSURE_ID)
            FROM COI_DISCLOSURE CD
            WHERE CD.DISCLOSURE_NUMBER = t1.DISCLOSURE_NUMBER
            AND CD.REVIEW_STATUS_CODE NOT IN (1, 5, 6)
    )
    AND FN_FCOI_DISCLOSURE_REQUIRED(t1.PERSON_ID) = TRUE;
END
//
