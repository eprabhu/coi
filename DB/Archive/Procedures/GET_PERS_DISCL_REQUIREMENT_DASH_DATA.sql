DELIMITER //
CREATE PROCEDURE `GET_PERS_DISCL_REQUIREMENT_DASH_DATA`(
    AV_LOGIN_PERSON_ID VARCHAR(40),
    JSON_INPUT JSON
)
BEGIN

    DECLARE LS_DYN_SQL              LONGTEXT DEFAULT '';
    DECLARE LS_FILTER_CONDITION     LONGTEXT DEFAULT '';
    DECLARE LS_OFFSET_CONDITION     LONGTEXT DEFAULT '';
    DECLARE LS_JOIN_CONDITION       LONGTEXT DEFAULT '';
    DECLARE LS_OFFSET               INT;
    DECLARE SELECTED_FIELD_LIST     LONGTEXT DEFAULT '';

    DECLARE AV_IS_COUNT              BOOLEAN;
    DECLARE AV_TAB_TYPE              VARCHAR(30);
    DECLARE AV_SORT_TYPE             LONGTEXT;
    DECLARE AV_LIMIT                 INT;
    DECLARE AV_PAGED                 INT;
    DECLARE AV_UNLIMITED             BOOLEAN;
    DECLARE AV_HOME_UNIT             VARCHAR(500);
    DECLARE AV_PERSON                VARCHAR(40);
    DECLARE LS_DYN_CTE_SQL           LONGTEXT;
    DECLARE AV_INCLUDE_CHILD_UNITS   BOOLEAN;
    
    SET LS_FILTER_CONDITION         = '';
    SET SELECTED_FIELD_LIST         = '';
    SET LS_DYN_CTE_SQL              = '';

    SET AV_LIMIT                    = JSON_UNQUOTE(JSON_EXTRACT(JSON_INPUT,'$.LIMIT'));
    SET AV_PAGED                    = JSON_UNQUOTE(JSON_EXTRACT(JSON_INPUT,'$.PAGED'));
    SET AV_UNLIMITED                = JSON_EXTRACT(JSON_INPUT,'$.IS_UNLIMITED');
    SET AV_TAB_TYPE                 = JSON_UNQUOTE(JSON_EXTRACT(JSON_INPUT,'$.TAB_TYPE'));
    SET AV_IS_COUNT                 = JSON_EXTRACT(JSON_INPUT,'$.IS_COUNT');
    SET AV_HOME_UNIT                = JSON_UNQUOTE(JSON_EXTRACT(JSON_INPUT, '$.HOME_UNIT'));
    SET AV_SORT_TYPE                = JSON_UNQUOTE(JSON_EXTRACT(JSON_INPUT,'$.SORT_TYPE'));
    SET AV_PERSON                   = JSON_UNQUOTE(JSON_EXTRACT(JSON_INPUT, '$.PERSON'));
    SET AV_INCLUDE_CHILD_UNITS      = JSON_EXTRACT(JSON_INPUT, '$.INCLUDE_CHILD_UNITS');

    IF AV_TAB_TYPE IS NOT NULL AND AV_TAB_TYPE <> '' THEN

        IF AV_TAB_TYPE = 'EXEMPT' THEN
            SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION, ' AND (T1.OPA_EXEMPT_FROM_DATE IS NOT NULL ) ');
        ELSEIF AV_TAB_TYPE = 'ADMIN_OVERRIDE' THEN
             SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION, ' AND T1.CREATE_OPA_ADMIN_FORCE_ALLOWED = ''Y''');
        ELSEIF AV_TAB_TYPE = 'ELIGIBLE_PERSONS' THEN
            SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION, ' AND (T1.CAN_CREATE_OPA = ''Y'' OR T1.CREATE_OPA_ADMIN_FORCE_ALLOWED = ''Y'') ');
        ELSEIF AV_TAB_TYPE = 'DELINQUENT' THEN
             SET LS_JOIN_CONDITION = ' LEFT JOIN (SELECT DISTINCT OD.PERSON_ID
                    FROM OPA_DISCLOSURE OD
                    WHERE OD.VERSION_STATUS <> ''ARCHIVE''
                    AND OD.REVIEW_STATUS_CODE NOT IN (''1'',''5'',''6'')
                    AND NOT EXISTS (SELECT 1
                             FROM OPA_DISCLOSURE OD2
                             WHERE OD2.OPA_DISCLOSURE_NUMBER = OD.OPA_DISCLOSURE_NUMBER
                              AND OD2.REVIEW_STATUS_CODE IN (''1'',''5'',''6''))
                    ) PENDING ON PENDING.PERSON_ID = T1.PERSON_ID ';
                    SET LS_FILTER_CONDITION = CONCAT('AND (T1.CAN_CREATE_OPA = ''Y'' OR T1.CREATE_OPA_ADMIN_FORCE_ALLOWED = ''Y'') AND
                        (T1.OPA_EXEMPT_FROM_DATE IS NULL OR (UTC_TIMESTAMP() NOT BETWEEN T1.OPA_EXEMPT_FROM_DATE AND T1.OPA_EXEMPT_TO_DATE))
             AND PENDING.PERSON_ID IS NULL ');
        END IF;
    END IF;


    SET LS_DYN_CTE_SQL = CONCAT('WITH ELIGIBILITY_UNITS AS (SELECT DISTINCT
                      CASE
                          WHEN PR.DESCEND_FLAG = ''Y'' THEN UC.CHILD_UNIT_NUMBER
                          ELSE PR.UNIT_NUMBER
                      END AS UNIT_NUMBER,
                      case when R.RIGHT_NAME = ''MAINTAIN_OPA_ELIGIBILITY'' then true else false end as CAN_EDIT
                  FROM PERSON_ROLES PR
                  INNER JOIN ROLE_RIGHTS RR ON PR.ROLE_ID = RR.ROLE_ID
                  INNER JOIN RIGHTS R ON RR.RIGHT_ID = R.RIGHT_ID
                  LEFT JOIN UNIT_WITH_CHILDREN UC ON UC.UNIT_NUMBER = PR.UNIT_NUMBER AND PR.DESCEND_FLAG = ''Y''
                  WHERE PR.PERSON_ID = ''', AV_LOGIN_PERSON_ID, '''
                    AND R.RIGHT_NAME IN (''VIEW_OPA_ELIGIBILITY'', ''MAINTAIN_OPA_ELIGIBILITY''))');

    SET LS_JOIN_CONDITION = CONCAT(LS_JOIN_CONDITION, ' INNER JOIN ELIGIBILITY_UNITS EU ON EU.UNIT_NUMBER = T3.HOME_UNIT ');

    SET SELECTED_FIELD_LIST = ' EU.CAN_EDIT, ';

    IF AV_TAB_TYPE = 'DELINQUENT' THEN

        SET LS_JOIN_CONDITION = CONCAT(LS_JOIN_CONDITION,
                 'LEFT JOIN (SELECT DISTINCT
                      CASE
                        WHEN PR.DESCEND_FLAG = ''N'' THEN PR.UNIT_NUMBER
                        ELSE UC.CHILD_UNIT_NUMBER
                      END AS ALLOWED_UNIT
                 FROM PERSON_ROLES PR
                 INNER JOIN ROLE_RIGHTS RR ON PR.ROLE_ID = RR.ROLE_ID
                 INNER JOIN RIGHTS R ON RR.RIGHT_ID = R.RIGHT_ID
                 LEFT JOIN UNIT_WITH_CHILDREN UC
                      ON PR.DESCEND_FLAG = ''Y''
                      AND UC.UNIT_NUMBER = PR.UNIT_NUMBER
                 WHERE PR.PERSON_ID = ''', AV_LOGIN_PERSON_ID, '''
                 AND R.RIGHT_NAME IN (''MANAGE_OPA_DISCLOSURE'',''VIEW_OPA_DISCLOSURE'')
             ) AU ON AU.ALLOWED_UNIT = T3.HOME_UNIT');

        SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION, ' AND AU.ALLOWED_UNIT IS NOT NULL ');

    END IF;

    IF AV_HOME_UNIT IS NOT NULL AND AV_HOME_UNIT <> '' AND AV_HOME_UNIT <> 'ALL' AND (AV_INCLUDE_CHILD_UNITS IS NULL OR AV_INCLUDE_CHILD_UNITS = FALSE)THEN
        SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION, ' AND T2.UNIT_NUMBER = ''', AV_HOME_UNIT, ''' ');
    ELSEIF AV_INCLUDE_CHILD_UNITS = TRUE THEN
        SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' AND T2.UNIT_NUMBER IN (SELECT CHILD_UNIT_NUMBER FROM UNIT_WITH_CHILDREN WHERE UNIT_NUMBER =''',AV_HOME_UNIT,''') ');
    END IF;

    IF AV_PERSON IS NOT NULL AND AV_PERSON <> '' THEN
        SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' AND T1.PERSON_ID = ''',AV_PERSON,''' ');
    END IF;

    IF AV_IS_COUNT IS NOT NULL AND AV_IS_COUNT = TRUE THEN
        SET SELECTED_FIELD_LIST = ' COUNT(DISTINCT T1.PERSON_ID) AS TOTAL_COUNT ';
        SET AV_SORT_TYPE = '';
        SET LS_OFFSET_CONDITION = '';
    ELSE
        SET SELECTED_FIELD_LIST = CONCAT(SELECTED_FIELD_LIST,' T1.PERSON_DISCL_REQUIREMENT_ID,
                T1.PERSON_ID,
                T3.FULL_NAME AS PERSON_FULL_NAME,
                T2.UNIT_NUMBER AS HOME_UNIT,
                T2.UNIT_NAME AS HOME_UNIT_NAME,
                T2.DISPLAY_NAME,
                T4.JOB_TITLE AS APPOINTMENT_TITLE,
                T4.IS_FACULTY,
                T3.EMAIL_ADDRESS AS PERSON_EMAIL,
                T1.CAN_CREATE_OPA,
                T1.CREATE_OPA_ADMIN_FORCE_ALLOWED,
                T6.DESCRIPTION AS OPA_EXEMPT_JUSTIFICATION,
                T1.IS_EXEMPT_FROM_OPA,
                T1.OPA_EXEMPT_FROM_DATE,
                T1.OPA_EXEMPT_TO_DATE,
                T1.UPDATE_TIMESTAMP,
                T5.FULL_NAME AS UPDATE_USER_FULL_NAME,
                 EXISTS (
                     SELECT 1 FROM OPA_DISCLOSURE OD
                     WHERE OD.PERSON_ID = T1.PERSON_ID
                     AND OD.VERSION_STATUS <> ''ARCHIVE''
                     AND OD.REVIEW_STATUS_CODE IN (1,5,6) AND NOT EXISTS (
                         SELECT 1 FROM OPA_DISCLOSURE OD2
                         WHERE OD2.OPA_DISCLOSURE_NUMBER = OD.OPA_DISCLOSURE_NUMBER
                         AND OD2.REVIEW_STATUS_CODE NOT IN (1,5,6)
                     )
                 ) AS HAS_PENDING_DISCLOSURE,
                 T1.OPA_EXEMPT_JUSTIFICATION_ID
            ');

        -- Pagination logic
        IF AV_UNLIMITED IS NULL OR  AV_UNLIMITED != TRUE THEN
            SET LS_OFFSET = (AV_LIMIT * AV_PAGED);
            SET LS_OFFSET_CONDITION = CONCAT(' LIMIT ',AV_LIMIT,' OFFSET ',LS_OFFSET);
        ELSE
            SET LS_OFFSET_CONDITION = '';
        END IF;

        IF AV_SORT_TYPE IS NOT NULL OR AV_SORT_TYPE <> '' THEN
            SET AV_SORT_TYPE = CONCAT(' ORDER BY ', AV_SORT_TYPE);
        ELSE
            SET AV_SORT_TYPE =  CONCAT(' ORDER BY UPDATE_TIMESTAMP DESC ');
        END IF;
    END IF;


    SET LS_DYN_SQL = CONCAT(LS_DYN_CTE_SQL,' SELECT * FROM (SELECT ', SELECTED_FIELD_LIST,'
            FROM PERSON_DISCL_REQUIREMENT T1
            INNER JOIN PERSON T3 ON T3.PERSON_ID = T1.PERSON_ID
            INNER JOIN UNIT T2 ON T2.UNIT_NUMBER = T3.HOME_UNIT
            INNER JOIN OPA_PERSON T4 ON T4.PERSON_ID = T1.PERSON_ID
            LEFT JOIN PERSON T5 ON T5.PERSON_ID = T1.UPDATED_BY
            LEFT JOIN OPA_EXEMPT_JUSTIFICATIONS T6 ON T6.OPA_EXEMPT_JUSTIFICATION_ID = T1.OPA_EXEMPT_JUSTIFICATION_ID ', LS_JOIN_CONDITION, '
            WHERE T1.VERSION_STATUS = ''ACTIVE'' ', LS_FILTER_CONDITION, AV_SORT_TYPE, LS_OFFSET_CONDITION, ') T ');

SET @QUERY_STATEMENT = LS_DYN_SQL;
PREPARE EXECUTABLE_STAEMENT FROM @QUERY_STATEMENT;
EXECUTE EXECUTABLE_STAEMENT;

END
//
