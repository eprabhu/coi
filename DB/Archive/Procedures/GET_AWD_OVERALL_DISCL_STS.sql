DELIMITER //
CREATE PROCEDURE `GET_AWD_OVERALL_DISCL_STS`(AV_DISCLOSURE_ID INT)
BEGIN

	DECLARE LS_OVERALL_DISCL_STS VARCHAR(50);
	DECLARE LS_OVERALL_DISCL_RVW_STS VARCHAR(50);
	DECLARE LS_DISCLOSURE_REQUIRED_FLAG VARCHAR(20);
	DECLARE LS_DISCLOSURE_VALIDATION_FLAG VARCHAR(20);


	DECLARE LS_AWARD_NUMBER VARCHAR(45);
	DECLARE LS_PERSON_ID VARCHAR(45);
	
	SET SQL_SAFE_UPDATES = 0;
		
 
	
    UPDATE COI_INT_STAGE_AWARD_PERSON CAP,
			COI_DISCL_PROJECTS CD,
			COI_INT_STAGE_AWARD CIA
	SET MAX_DISCLOSURE_ID = (SELECT MAX(T1.DISCLOSURE_ID) 																				
				  FROM COI_DISCL_PROJECTS T1,																	
					   COI_DISCLOSURE T2 
				  WHERE  T1.MODULE_CODE = 1
					AND  T1.MODULE_ITEM_KEY = CAP.PROJECT_NUMBER													
					AND  T1.DISCLOSURE_ID = T2.DISCLOSURE_ID
					AND  T2.DISPOSITION_STATUS_CODE <> 2
					AND  T2.VERSION_STATUS <> 'ARCHIVE'
					AND  T2.PERSON_ID = CAP.KEY_PERSON_ID),
	
		CAP.DISCLOSURE_STATUS =(CASE 
								/*WHEN CAP.NEW_DISCLOSURE_REQUIRED = 'Y'
									THEN 'NOT_YET_DISCLOSED'		*/									
								WHEN CAP.DISCLOSURE_REQUIRED_FLAG = 'REQUIRED'
								 AND (CIA.DISCLOSURE_VALIDATION_FLAG IS NULL OR CIA.DISCLOSURE_VALIDATION_FLAG = 'HIERARCHY')	
								 /*AND NOT EXISTS (SELECT 1
												  FROM COI_DISCL_PROJECTS D1,																	
													   COI_DISCLOSURE D2
												 WHERE D1.MODULE_CODE = 1
												   AND D1.MODULE_ITEM_KEY = CAP.PROJECT_NUMBER
												   AND D2.DISCLOSURE_ID = D1.DISCLOSURE_ID
												   AND D2.PERSON_ID = CAP.KEY_PERSON_ID
												) */
										
									THEN  IFNULL((SELECT CASE WHEN C1.REVIEW_STATUS_CODE IN  (2,3,4,7,8) THEN 'DISCLOSURE_COMPLETED' 
									                   WHEN C1.REVIEW_STATUS_CODE IN  (1,5,6) THEN 'DISCLOSURE_PENDING'  
													   ELSE  'NOT_YET_DISCLOSED'
													END
									        FROM COI_DISCLOSURE C1
											WHERE C1.DISCLOSURE_ID = (SELECT MAX(T1.DISCLOSURE_ID) 																				
																	  FROM COI_DISCL_PROJECTS T1,																	
																		   COI_DISCLOSURE T2 
																	  WHERE  T1.MODULE_CODE = 1
																	   -- AND  T1.MODULE_ITEM_KEY <> CAP.PROJECT_NUMBER
																		AND SUBSTRING_INDEX(T1.MODULE_ITEM_KEY,'-',1) = SUBSTRING_INDEX(CAP.PROJECT_NUMBER,'-',1)
																		AND  T1.DISCLOSURE_ID = T2.DISCLOSURE_ID
																		AND  T2.DISPOSITION_STATUS_CODE <> 2
																		AND  T2.VERSION_STATUS <> 'ARCHIVE'
																		AND  T2.PERSON_ID = CAP.KEY_PERSON_ID)
											),'NOT_YET_DISCLOSED')
								WHEN CAP.DISCLOSURE_REQUIRED_FLAG IN ( 'REQUIRED','NOT_REQUIRED')
								 AND CIA.DISCLOSURE_VALIDATION_FLAG = 'SELF'	
									THEN IFNULL((SELECT CASE WHEN C1.REVIEW_STATUS_CODE IN  (2,3,4,7,8) THEN 'DISCLOSURE_COMPLETED' 
									                   WHEN C1.REVIEW_STATUS_CODE IN  (1,5,6) THEN 'DISCLOSURE_PENDING'  
													   ELSE  'NOT_YET_DISCLOSED'
													END
									        FROM COI_DISCLOSURE C1
											WHERE C1.DISCLOSURE_ID = (SELECT MAX(T1.DISCLOSURE_ID) 																				
																	  FROM COI_DISCL_PROJECTS T1,																	
																		   COI_DISCLOSURE T2 
																	  WHERE  T1.MODULE_CODE = 1
																	    AND  T1.MODULE_ITEM_KEY = CAP.PROJECT_NUMBER													
																		AND  T1.DISCLOSURE_ID = T2.DISCLOSURE_ID
																		AND  T2.DISPOSITION_STATUS_CODE <> 2
																		AND  T2.VERSION_STATUS <> 'ARCHIVE'
																		AND  T2.PERSON_ID = CAP.KEY_PERSON_ID)
											),'NOT_YET_DISCLOSED')
								 
								WHEN CAP.DISCLOSURE_REQUIRED_FLAG = 'NOT_REQUIRED'  AND IFNULL(CIA.DISCLOSURE_VALIDATION_FLAG,'x') <> 'SELF'
									THEN 'DISCLOSURE_NOT_REQUIRED'
								END 
								),
            	DISCLOSURE_REVIEW_STATUS = (CASE 
										WHEN CAP.DISCLOSURE_REQUIRED_FLAG = 'REQUIRED' OR (CIA.DISCLOSURE_VALIDATION_FLAG = 'SELF' AND CAP.DISCLOSURE_REQUIRED_FLAG = 'NOT_REQUIRED')
											THEN (SELECT CR.DESCRIPTION										  
									        FROM COI_DISCLOSURE C1,
											     COI_REVIEW_STATUS_TYPE CR
											WHERE C1.DISCLOSURE_ID = (SELECT MAX(T1.DISCLOSURE_ID) 																				
																	  FROM COI_DISCL_PROJECTS T1,																	
																		   COI_DISCLOSURE T2 
																	  WHERE  T1.MODULE_CODE = 1
																	    AND  T1.MODULE_ITEM_KEY = CAP.PROJECT_NUMBER													
																		AND  T1.DISCLOSURE_ID = T2.DISCLOSURE_ID
																		AND  T2.DISPOSITION_STATUS_CODE <> 2
																		AND  T2.VERSION_STATUS <> 'ARCHIVE'
																		AND  T2.PERSON_ID = CAP.KEY_PERSON_ID)
											 AND CR.REVIEW_STATUS_CODE = C1.REVIEW_STATUS_CODE
											)
										WHEN CAP.DISCLOSURE_REQUIRED_FLAG = 'NOT_REQUIRED' AND IFNULL(CIA.DISCLOSURE_VALIDATION_FLAG,'x') <> 'SELF'
											THEN 'DISCLOSURE_REVIEW_NA'
										ELSE NULL
										END )								
	   WHERE CD.MODULE_CODE = '1' 
	     AND CD.DISCLOSURE_ID = AV_DISCLOSURE_ID
	     AND CIA.PROJECT_NUMBER = CD.MODULE_ITEM_KEY
		 AND CAP.PROJECT_NUMBER =  CIA.PROJECT_NUMBER
	     AND CAP.STATUS = 'A';

		UPDATE COI_INT_STAGE_AWARD_PERSON T1,
		COI_DISCL_PROJECTS T2,
		COI_DISCLOSURE T5
		SET MAX_DISCLOSURE_ID = (SELECT MAX(T3.DISCLOSURE_ID)
								FROM COI_DISCL_PROJECTS T3
								JOIN COI_DISCLOSURE T4 ON T3.DISCLOSURE_ID AND T4.DISCLOSURE_ID
								WHERE T3.MODULE_CODE = 1
								AND SUBSTRING_INDEX(T3.MODULE_ITEM_KEY,'-',1) = SUBSTRING_INDEX(T1.PROJECT_NUMBER,'-',1)
								AND T4.DISPOSITION_STATUS_CODE <> 2
								AND T4.VERSION_STATUS <> 'ARCHIVE'
								AND T4.PERSON_ID = T1.KEY_PERSON_ID
								)
		WHERE SUBSTRING_INDEX(T2.MODULE_ITEM_KEY,'-',1) = SUBSTRING_INDEX(T1.PROJECT_NUMBER,'-',1)
		AND T2.DISCLOSURE_ID = T5.DISCLOSURE_ID
		AND T5.PERSON_ID = T1.KEY_PERSON_ID
		AND T2.MODULE_CODE = 1
		AND T2.DISCLOSURE_ID = AV_DISCLOSURE_ID
		AND (T1.MAX_DISCLOSURE_ID IS NULL
			OR (T1.MAX_DISCLOSURE_ID IS NOT NULL
				AND NOT EXISTS (SELECT 1
								FROM COI_DISCL_PROJECTS T5
								WHERE T5.MODULE_ITEM_KEY = T1.PROJECT_NUMBER
								)
				)
			);

		-- Overall Disclosure Status
		/*
		SET LS_OVERALL_DISCL_STS := NULL;
	    IF NOT EXISTS (
			SELECT 1
			FROM COI_INT_STAGE_AWARD_PERSON
			WHERE PROJECT_NUMBER = LS_AWARD_NUMBER
			  AND DISCLOSURE_STATUS NOT IN ('DISCLOSURE_COMPLETED','DISCLOSURE_NOT_REQUIRED')
					) THEN
			SET LS_OVERALL_DISCL_STS := 'DISCLOSURE_COMPLETED';
    
		
		ELSEIF NOT EXISTS (
			SELECT 1
			FROM COI_INT_STAGE_AWARD_PERSON
			WHERE PROJECT_NUMBER = LS_AWARD_NUMBER
			  AND DISCLOSURE_STATUS NOT IN ('DISCLOSURE_NOT_REQUIRED')
					) THEN
			 SET LS_OVERALL_DISCL_STS := 'DISCLOSURE_NOT_REQUIRED';
    
        ELSEIF  EXISTS (
			SELECT 1
			FROM COI_INT_STAGE_AWARD_PERSON
			WHERE PROJECT_NUMBER = LS_AWARD_NUMBER
			  AND DISCLOSURE_STATUS = 'NOT_YET_DISCLOSED'  
					) THEN
			SET LS_OVERALL_DISCL_STS := 'NOT_YET_DISCLOSED' ;

		ELSEIF  EXISTS (
			SELECT 1
			FROM COI_INT_STAGE_AWARD_PERSON
			WHERE PROJECT_NUMBER = LS_AWARD_NUMBER
			  AND DISCLOSURE_STATUS = 'DISCLOSURE_PENDING'  
					) THEN
			SET LS_OVERALL_DISCL_STS := 'DISCLOSURE_PENDING';
		
    
		END IF;  */
		
		
		UPDATE COI_INT_STAGE_AWARD  CIA 
		   SET OVERALL_DISCLOSURE_STATUS = CASE WHEN NOT EXISTS (
																SELECT 1
																FROM COI_INT_STAGE_AWARD_PERSON
																WHERE PROJECT_NUMBER = CIA.PROJECT_NUMBER
																  AND DISCLOSURE_STATUS NOT IN ('DISCLOSURE_NOT_REQUIRED')
																  AND STATUS = 'A'
															) THEN 'DISCLOSURE_NOT_REQUIRED'
		   
												WHEN NOT EXISTS (
																	SELECT 1
																	FROM COI_INT_STAGE_AWARD_PERSON
																	WHERE PROJECT_NUMBER = CIA.PROJECT_NUMBER
																	  AND DISCLOSURE_STATUS NOT IN ('DISCLOSURE_COMPLETED','DISCLOSURE_NOT_REQUIRED')
																	  AND STATUS = 'A'
													            ) THEN 'DISCLOSURE_COMPLETED'
												WHEN  EXISTS (
																SELECT 1
																FROM COI_INT_STAGE_AWARD_PERSON
																WHERE PROJECT_NUMBER = CIA.PROJECT_NUMBER
																  AND DISCLOSURE_STATUS = 'NOT_YET_DISCLOSED'  
																  AND STATUS = 'A'
															) THEN 'NOT_YET_DISCLOSED'
												WHEN EXISTS (
																SELECT 1
																FROM COI_INT_STAGE_AWARD_PERSON
																WHERE PROJECT_NUMBER = CIA.PROJECT_NUMBER
																  AND DISCLOSURE_STATUS = 'DISCLOSURE_PENDING' 
																  AND STATUS = 'A'
															) THEN 'DISCLOSURE_PENDING'	
												END
		 WHERE  PROJECT_NUMBER IN   ( SELECT MODULE_ITEM_KEY 
		                              FROM COI_DISCL_PROJECTS 
									  WHERE MODULE_CODE = 1 
									  AND DISCLOSURE_ID = AV_DISCLOSURE_ID);
							  
		UPDATE COI_INT_STAGE_AWARD  CIA 
		   SET OVERALL_DISCL_REVIEW_STATUS = CASE 
												WHEN OVERALL_DISCLOSURE_STATUS = 'DISCLOSURE_NOT_REQUIRED' THEN 'N/A'																														
												WHEN OVERALL_DISCLOSURE_STATUS = 'NOT_YET_DISCLOSED' THEN '--'
												WHEN NOT EXISTS (
																	SELECT 1
																	FROM COI_INT_STAGE_AWARD_PERSON
																	WHERE PROJECT_NUMBER = CIA.PROJECT_NUMBER
																	  AND DISCLOSURE_REVIEW_STATUS NOT IN ('Completed','DISCLOSURE_REVIEW_NA')
													            ) THEN 'Completed'
												ELSE 'Pending'
												END
		 WHERE  PROJECT_NUMBER IN   ( SELECT MODULE_ITEM_KEY 
		                              FROM COI_DISCL_PROJECTS 
									  WHERE MODULE_CODE = 1 
									  AND DISCLOSURE_ID = AV_DISCLOSURE_ID);	
		
		WITH tmp AS 
			(SELECT PROJECT_NUMBER,KEY_PERSON_ID,DISCLOSURE_STATUS, DISCLOSURE_REVIEW_STATUS
			   FROM COI_INT_STAGE_AWARD_PERSON CA 
				WHERE  EXISTS (SELECT 1
							   FROM COI_DISCL_PROJECTS CDP
							  WHERE CDP.MODULE_CODE = 1 
								AND CDP.DISCLOSURE_ID = AV_DISCLOSURE_ID
								AND CDP.MODULE_ITEM_KEY = CA.PROJECT_NUMBER)
			)
		UPDATE COI_INT_STAGE_AWARD_PERSON  CIA 
		   SET CIA.DISCLOSURE_STATUS = (SELECT DISCLOSURE_STATUS 
										  FROM TMP T1
										 WHERE SUBSTRING_INDEX(T1.PROJECT_NUMBER,'-',1) = SUBSTRING_INDEX(CIA.PROJECT_NUMBER,'-',1)
										   AND T1.KEY_PERSON_ID =  CIA.KEY_PERSON_ID
                                           LIMIT 1)	,		
			   CIA.DISCLOSURE_REVIEW_STATUS = (SELECT DISCLOSURE_REVIEW_STATUS 
												 FROM TMP T1
											    WHERE SUBSTRING_INDEX(T1.PROJECT_NUMBER,'-',1) = SUBSTRING_INDEX(CIA.PROJECT_NUMBER,'-',1)
												  AND T1.KEY_PERSON_ID =  CIA.KEY_PERSON_ID
												 LIMIT 1)			
		 WHERE SUBSTRING_INDEX(CIA.PROJECT_NUMBER,'-',1) IN (SELECT DISTINCT SUBSTRING_INDEX(T1.PROJECT_NUMBER,'-',1) FROM TMP T1)
       	   AND CIA.PROJECT_NUMBER NOT IN   ( SELECT MODULE_ITEM_KEY
											   FROM COI_DISCL_PROJECTS 
											  WHERE MODULE_CODE = 1 
											  AND DISCLOSURE_ID = AV_DISCLOSURE_ID)
			AND EXISTS ( SELECT 1 
						  FROM COI_INT_STAGE_AWARD
						  WHERE PROJECT_NUMBER = CIA.PROJECT_NUMBER 
						  AND IFNULL(DISCLOSURE_VALIDATION_FLAG,'x') <> 'SELF');
			   		
		
		WITH tmp AS 
			(SELECT PROJECT_NUMBER,OVERALL_DISCLOSURE_STATUS, OVERALL_DISCL_REVIEW_STATUS
			   FROM COI_INT_STAGE_AWARD CA 
				WHERE  EXISTS (SELECT 1
							   FROM COI_DISCL_PROJECTS CDP
							  WHERE CDP.MODULE_CODE = 1 
								AND CDP.DISCLOSURE_ID = AV_DISCLOSURE_ID
								AND CDP.MODULE_ITEM_KEY = CA.PROJECT_NUMBER)
			)
		UPDATE COI_INT_STAGE_AWARD  CIA 
		   SET CIA.OVERALL_DISCLOSURE_STATUS =  (SELECT OVERALL_DISCLOSURE_STATUS 
												  FROM TMP T1
												 WHERE SUBSTRING_INDEX(T1.PROJECT_NUMBER,'-',1) = SUBSTRING_INDEX(CIA.PROJECT_NUMBER,'-',1)												  
												   LIMIT 1)	,		
			   CIA.OVERALL_DISCL_REVIEW_STATUS = (SELECT OVERALL_DISCL_REVIEW_STATUS 
												    FROM TMP T1
												   WHERE SUBSTRING_INDEX(T1.PROJECT_NUMBER,'-',1) = SUBSTRING_INDEX(CIA.PROJECT_NUMBER,'-',1)												   
												    LIMIT 1)				
		 WHERE SUBSTRING_INDEX(CIA.PROJECT_NUMBER,'-',1)  IN (SELECT DISTINCT SUBSTRING_INDEX(T1.PROJECT_NUMBER,'-',1) FROM TMP T1)
       	   AND CIA.PROJECT_NUMBER NOT IN   ( SELECT MODULE_ITEM_KEY
											   FROM COI_DISCL_PROJECTS 
											  WHERE MODULE_CODE = 1 
											  AND DISCLOSURE_ID = AV_DISCLOSURE_ID)
			AND IFNULL(CIA.DISCLOSURE_VALIDATION_FLAG,'x') <> 'SELF';
			   
										   

		SET SQL_SAFE_UPDATES = 1; 
END
//
