DELIMITER //
CREATE PROCEDURE COI_INT_PROP_PERSON_DISCL_STATUS(
    IN AV_PROPOSAL_NUMBER  VARCHAR(20),
    IN AV_KEY_PERSON_ID    VARCHAR(40)
)
SP_BLOCK:BEGIN
    DECLARE LI_COUNT                     INT DEFAULT 0;
    DECLARE LS_DISCLOSURE_REQUIRED_FLAG  VARCHAR(20);
    DECLARE LS_CERTIFICATION_FLAG        VARCHAR(20);
    DECLARE LS_REVIEW_STATUS             VARCHAR(10);
	DECLARE LI_DISCLOSURE_ID             INT DEFAULT NULL;


    SELECT COUNT(1) INTO LI_COUNT
    FROM COI_INT_STAGE_DEV_PROPOSAL_PERSON 
    WHERE PROPOSAL_NUMBER = AV_PROPOSAL_NUMBER
    AND KEY_PERSON_ID = AV_KEY_PERSON_ID;

    IF LI_COUNT = 0 THEN
        SELECT NULL AS DISCLOSURE_ID,NULL AS DISCLOSURE_STATUS;
        LEAVE SP_BLOCK;
    END IF;


    SELECT DISCLOSURE_REQUIRED_FLAG, CERTIFICATION_FLAG 
    INTO LS_DISCLOSURE_REQUIRED_FLAG, LS_CERTIFICATION_FLAG
    FROM COI_INT_STAGE_DEV_PROPOSAL_PERSON 
    WHERE PROPOSAL_NUMBER = AV_PROPOSAL_NUMBER
    AND KEY_PERSON_ID = AV_KEY_PERSON_ID;

    IF LS_DISCLOSURE_REQUIRED_FLAG IS NULL THEN
        SELECT NULL AS DISCLOSURE_ID,'Pending.' AS DISCLOSURE_STATUS;
        LEAVE SP_BLOCK;
    END IF;

    IF LS_DISCLOSURE_REQUIRED_FLAG = 'NOT_REQUIRED' THEN
        SELECT NULL AS DISCLOSURE_ID,'Not Required.' AS DISCLOSURE_STATUS;
        LEAVE SP_BLOCK;
    END IF;


    IF LS_CERTIFICATION_FLAG = 'INCOMPLETE' THEN
        SELECT NULL AS DISCLOSURE_ID,'Not Disclosed.' AS DISCLOSURE_STATUS;
        LEAVE SP_BLOCK;
    END IF;

  
			SELECT CD.DISCLOSURE_ID, CD.REVIEW_STATUS_CODE
			INTO LI_DISCLOSURE_ID,LS_REVIEW_STATUS  
			FROM COI_DISCL_PROJECTS CDP
			INNER JOIN COI_DISCLOSURE CD ON CD.DISCLOSURE_ID = CDP.DISCLOSURE_ID
			WHERE CDP.MODULE_CODE = '3'
			  AND CD.FCOI_TYPE_CODE = '2' 
			  AND CDP.MODULE_ITEM_KEY = AV_PROPOSAL_NUMBER
			  AND CD.PERSON_ID =  AV_KEY_PERSON_ID
			  AND CD.DISPOSITION_STATUS_CODE <> 2
			  AND CD.DISCLOSURE_ID = (SELECT MAX(CD2.DISCLOSURE_ID)
									  FROM COI_DISCLOSURE CD2
									  INNER JOIN COI_DISCL_PROJECTS CDP2 ON CDP2.DISCLOSURE_ID = CD2.DISCLOSURE_ID
									  WHERE CDP2.MODULE_CODE = '3'
										AND CD2.FCOI_TYPE_CODE = '2'
										AND CDP2.MODULE_ITEM_KEY = CDP.MODULE_ITEM_KEY
										AND CD2.PERSON_ID = CD.PERSON_ID
										AND CD2.DISPOSITION_STATUS_CODE <> 2);
    -- If no disclosure found, check legacy disclosures
	IF LI_DISCLOSURE_ID IS NULL THEN
        SELECT DISTINCT CD.LEGACY_DISCLOSURE_ID, 
			CASE
				WHEN CD.REVIEW_STATUS_CODE = 9 THEN '5'
                WHEN CD.REVIEW_STATUS_CODE = 10 THEN '6'
				WHEN CD.REVIEW_STATUS_CODE = 5 THEN '8'
                WHEN CD.REVIEW_STATUS_CODE = 6 OR CD.REVIEW_STATUS_CODE= 7 OR CD.REVIEW_STATUS_CODE = 8 THEN '2'
                ELSE CAST(CD.REVIEW_STATUS_CODE AS CHAR)
			END AS REVIEW_STATUS_CODE
			INTO LI_DISCLOSURE_ID,LS_REVIEW_STATUS
			FROM LEGACY_COI_DISC_DETAILS CDP
			INNER JOIN LEGACY_COI_DISCLOSURE CD ON CD.LEGACY_DISCLOSURE_ID = CDP.LEGACY_DISCLOSURE_ID
			WHERE CDP.MODULE_CODE = 3
			  -- AND CD.EVENT_TYPE_CODE IN (1, 2) -- Proposal or Award
			  AND CDP.MODULE_ITEM_KEY = AV_PROPOSAL_NUMBER
			  AND CD.PERSON_ID =  AV_KEY_PERSON_ID
			  AND (CD.REVIEW_STATUS_CODE = 2 					 -- Submitted for review
					OR CD.DISCLOSURE_DISPOSITION_CODE IN (1, 5)) -- Approved or Expired
			  AND CD.SEQUENCE_NUMBER = (SELECT MAX(CD2.SEQUENCE_NUMBER)
									  FROM LEGACY_COI_DISCLOSURE CD2
									  INNER JOIN LEGACY_COI_DISC_DETAILS CDP2 ON CDP2.LEGACY_DISCLOSURE_ID = CD2.LEGACY_DISCLOSURE_ID
									  WHERE CDP2.MODULE_CODE = 3
										-- AND CD2.EVENT_TYPE_CODE IN (1, 2)
										AND CDP2.MODULE_ITEM_KEY = CDP.MODULE_ITEM_KEY
										AND CD2.PERSON_ID = CD.PERSON_ID
										AND (CD2.REVIEW_STATUS_CODE = 2
											OR CD2.DISCLOSURE_DISPOSITION_CODE IN (1, 5)));
    END IF;

	IF LS_REVIEW_STATUS IS NULL THEN 
		SELECT NULL AS DISCLOSURE_ID,'Not Disclosed.' AS DISCLOSURE_STATUS;
		LEAVE SP_BLOCK;			
	END IF;
	
    IF LS_REVIEW_STATUS = '1' THEN
		SELECT LI_DISCLOSURE_ID AS DISCLOSURE_ID,'Pending.' AS DISCLOSURE_STATUS;
		LEAVE SP_BLOCK;
	ELSE
       IF LS_REVIEW_STATUS IN ('5','6') THEN 
       SELECT LI_DISCLOSURE_ID AS DISCLOSURE_ID,'Pending.' AS DISCLOSURE_STATUS;
		ELSE
		SELECT LI_DISCLOSURE_ID AS DISCLOSURE_ID,'Completed.' AS DISCLOSURE_STATUS;
		LEAVE SP_BLOCK;
        END IF;
    END IF;

END SP_BLOCK
//
