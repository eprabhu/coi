DELIMITER //
CREATE PROCEDURE UPDATE_OPA_ENG_REL (
AV_OPA_DISCL_ID            INT
)
BEGIN

    UPDATE OPA_DISCL_PERSON_ENTITY_REL t1
        INNER JOIN PERSON_ENTITY t2 ON t2.PERSON_ENTITY_ID = t1.PERSON_ENTITY_ID
        INNER JOIN PER_ENT_DISCL_TYPE_SELECTION t3 ON t3.PERSON_ENTITY_ID = t2.PERSON_ENTITY_ID
    SET t1.INCLUDE_IN_OPA_DISCLOSURE = 'Y', t1.UPDATE_TIMESTAMP = UTC_TIMESTAMP()
        WHERE DISCLOSURE_ID = AV_OPA_DISCL_ID
            AND t2.VERSION_STATUS = 'ACTIVE'
            AND t2.IS_FORM_COMPLETED = 'Y'
            AND t3.DISCLOSURE_TYPE_CODE = 2;
    commit;

   DELETE DC, T1 FROM OPA_DISCL_PERSON_ENTITY_REL T1
        INNER JOIN PERSON_ENTITY T2 ON T2.PERSON_ENTITY_ID = T1.PERSON_ENTITY_ID
        LEFT JOIN DISCL_COMMENT DC ON 
            DC.MODULE_ITEM_KEY = T1.DISCLOSURE_ID 
            AND DC.SUB_MODULE_ITEM_NUMBER = T1.PERSON_ENTITY_NUMBER
        WHERE T1.DISCLOSURE_ID = AV_OPA_DISCL_ID AND (
            T2.VERSION_STATUS <> 'ACTIVE'
            OR T2.IS_FORM_COMPLETED <> 'Y'
            OR NOT EXISTS (
                SELECT 1
                    FROM PER_ENT_DISCL_TYPE_SELECTION TS
                    WHERE TS.PERSON_ENTITY_ID = T2.PERSON_ENTITY_ID
                    AND TS.DISCLOSURE_TYPE_CODE = 2
            )
        );

END
//