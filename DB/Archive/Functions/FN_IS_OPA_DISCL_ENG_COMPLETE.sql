DELIMITER //
CREATE FUNCTION `FN_IS_OPA_DISCL_ENG_COMPLETE`(
    AV_OPA_DISCLOSURE_ID INT) RETURNS TINYINT(1)
    READS SQL DATA
    DETERMINISTIC
BEGIN
    IF EXISTS (SELECT 1
            FROM OPA_DISCL_PERSON_ENTITY_REL t1
            INNER JOIN PERSON_ENTITY t2 ON t2.PERSON_ENTITY_ID = t1.PERSON_ENTITY_ID
            INNER JOIN PER_ENT_DISCL_TYPE_SELECTION t3 ON t3.PERSON_ENTITY_ID = t2.PERSON_ENTITY_ID AND t3.DISCLOSURE_TYPE_CODE = 2
            WHERE t1.DISCLOSURE_ID = AV_OPA_DISCLOSURE_ID AND t2.VERSION_STATUS = 'ACTIVE'  AND t2.IS_FORM_COMPLETED <> 'Y'
        ) THEN
        RETURN FALSE;
    END IF;
    -- If all relevant engagements were completed, return TRUE
    RETURN TRUE;
END
//
