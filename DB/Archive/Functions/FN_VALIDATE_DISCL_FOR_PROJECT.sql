DELIMITER //
CREATE FUNCTION `FN_VALIDATE_DISCL_FOR_PROJECT`(AV_AWARD_NUMBER VARCHAR(50)) RETURNS varchar(10)
    DETERMINISTIC
BEGIN
    DECLARE LI_DONE INT DEFAULT FALSE;
    DECLARE LS_KP_PERSON_ID VARCHAR(50);
    DECLARE LI_HAS_DISCLOSURE_AND_PROJECT INT DEFAULT 0;
    DECLARE LI_VALID_AWARD_COUNT INT DEFAULT 0;
    DECLARE CUR CURSOR FOR
        SELECT T1.PERSON_ID
        FROM AWARD_PERSONS T1
        JOIN AWARD T2 ON T1.AWARD_ID = T2.AWARD_ID
        WHERE T2.AWARD_NUMBER = AV_AWARD_NUMBER
          AND T1.PERSON_ID IS NOT NULL
          AND T2.SEQUENCE_NUMBER = (
              SELECT MAX(T3.SEQUENCE_NUMBER)
              FROM AWARD T3
              WHERE T3.AWARD_NUMBER = T2.AWARD_NUMBER
                AND T3.AWARD_SEQUENCE_STATUS IN ('PENDING')
          );
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET LI_DONE = TRUE;
    OPEN CUR;
    READ_LOOP: LOOP
        FETCH CUR INTO LS_KP_PERSON_ID;
        IF LI_DONE THEN
            LEAVE READ_LOOP;
        END IF;
      -- DISCLOSURE + COI_DISCL_PROJECTS + HIERARCHY MATCH + NOT EXPIRED
	  SELECT COUNT(*) INTO LI_HAS_DISCLOSURE_AND_PROJECT
	  FROM COI_DISCLOSURE CD
	  JOIN COI_DISCL_PROJECTS CDP ON CD.DISCLOSURE_ID = CDP.DISCLOSURE_ID
	  JOIN (
	   SELECT AH.AWARD_NUMBER
	   FROM AWARD_HIERARCHY AH
	   INNER JOIN AWARD_PERSONS AP ON AP.AWARD_NUMBER = AH.AWARD_NUMBER
	   WHERE AP.PERSON_ID = LS_KP_PERSON_ID
		 AND AH.ROOT_AWARD_NUMBER = (
				 SELECT ROOT_AWARD_NUMBER
				 FROM AWARD_HIERARCHY
				 WHERE AWARD_NUMBER = AV_AWARD_NUMBER)
		 AND AP.SEQUENCE_NUMBER = (
				 SELECT MAX(A.SEQUENCE_NUMBER)
				 FROM AWARD A
				 WHERE A.AWARD_NUMBER = AP.AWARD_NUMBER
				 AND A.AWARD_SEQUENCE_STATUS IN ('PENDING'))
	  ) AS VALID_AWARDS ON CDP.MODULE_ITEM_KEY = VALID_AWARDS.AWARD_NUMBER
	  WHERE CD.PERSON_ID = LS_KP_PERSON_ID
		AND CD.VERSION_STATUS IN ('ACTIVE', 'PENDING')
		AND CD.REVIEW_STATUS_CODE NOT IN ('1', '5', '6')
		AND (CD.EXPIRATION_DATE IS NULL OR CD.EXPIRATION_DATE >= CURRENT_DATE)
		AND CDP.MODULE_CODE = '1';
        IF LI_HAS_DISCLOSURE_AND_PROJECT = 0 THEN
            CLOSE CUR;
            RETURN 'FALSE';
        END IF;
    END LOOP;
    CLOSE CUR;
    RETURN 'TRUE';
END
//
