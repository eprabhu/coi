DELIMITER //
CREATE FUNCTION `FN_IS_COMMITMENT_QN_ANSWERED`(
    AV_PERSON_ENTITY_ID INT
) RETURNS tinyint(1)
    READS SQL DATA
    DETERMINISTIC
BEGIN
    DECLARE LI_IS_COMMITMENT TINYINT(1);
    DECLARE LI_ANS_HEADER_ID INT;
 
    SET LI_IS_COMMITMENT = FN_IS_ENG_HAS_COMMITMENT(AV_PERSON_ENTITY_ID);
 
    IF LI_IS_COMMITMENT = 1 THEN
 
        SELECT QUESTIONNAIRE_ANS_HEADER_ID
        INTO LI_ANS_HEADER_ID
        FROM FB_QUEST_ANSWER_HEADER
        WHERE MODULE_ITEM_CODE = 8
          AND MODULE_SUB_ITEM_CODE = 801
          AND MODULE_ITEM_KEY = AV_PERSON_ENTITY_ID;
 
        IF LI_ANS_HEADER_ID IS NOT NULL AND 
           EXISTS (
               SELECT 1
               FROM FB_QUEST_ANSWER FQA
               INNER JOIN QUEST_QUESTION QQ ON FQA.QUESTION_ID = QQ.QUESTION_ID
               WHERE FQA.QUESTIONNAIRE_ANS_HEADER_ID = LI_ANS_HEADER_ID
                 AND QQ.QUESTION = 'Have you reviewed this engagement with your DLC head or supervisor?'
           ) THEN
            RETURN 1;
        END IF;
 ELSE
  RETURN 1;
    END IF;
 
    RETURN 0;
END
//
