DELIMITER //
CREATE FUNCTION `FN_DISCLOSURE_TOTAL_COMMENT_COUNT`(
    AV_DISCLOSURE_ID INT,
    AV_PERSON_ID VARCHAR(40),
    AV_MODULE_CODE INT
) RETURNS int
    DETERMINISTIC
BEGIN
    DECLARE LI_PROJ_TOTAL_COMMENT_COUNT INT DEFAULT 0;
    DECLARE LI_REVIEW_TOTAL_COMMENT_COUNT INT DEFAULT 0;
    DECLARE LI_CAN_VIEW_PRIVATE_COMMENT INT DEFAULT 0;
    DECLARE LI_CAN_VIEW_PROJ_COMMENT INT DEFAULT 0;
    DECLARE LI_AWARD_MODULE_CODE INT DEFAULT 0;
    DECLARE LI_DEV_PROP_MODULE_CODE INT DEFAULT 0;
    DECLARE LS_ALL_COMMENT_RIGHTS TEXT;
    DECLARE LS_ALL_PRIVATE_COMMENT_RIGHTS TEXT;
 
    IF (AV_MODULE_CODE = 8) THEN
        SELECT COUNT(1) INTO LI_CAN_VIEW_PROJ_COMMENT 
        FROM COI_DISCLOSURE 
        WHERE DISCLOSURE_ID = AV_DISCLOSURE_ID AND PERSON_ID = AV_PERSON_ID;
 
        SET LS_ALL_COMMENT_RIGHTS = 'VIEW_COI_COMMENTS,MAINTAIN_COI_COMMENTS,VIEW_COI_PRIVATE_COMMENTS,MAINTAIN_COI_PRIVATE_COMMENTS';
        SET LS_ALL_PRIVATE_COMMENT_RIGHTS = 'VIEW_COI_PRIVATE_COMMENTS,MAINTAIN_COI_PRIVATE_COMMENTS';
 
    ELSEIF (AV_MODULE_CODE = 23) THEN
        SELECT COUNT(1) INTO LI_CAN_VIEW_PROJ_COMMENT 
        FROM OPA_DISCLOSURE 
        WHERE OPA_DISCLOSURE_ID = AV_DISCLOSURE_ID AND PERSON_ID = AV_PERSON_ID;
 
        SET LS_ALL_COMMENT_RIGHTS = 'VIEW_OPA_COMMENTS,MAINTAIN_OPA_COMMENTS,VIEW_OPA_PRIVATE_COMMENTS,MAINTAIN_OPA_PRIVATE_COMMENTS';
        SET LS_ALL_PRIVATE_COMMENT_RIGHTS = 'VIEW_OPA_PRIVATE_COMMENTS,MAINTAIN_OPA_PRIVATE_COMMENTS';
 
    ELSEIF (AV_MODULE_CODE = 24) THEN
        SELECT COUNT(1) INTO LI_CAN_VIEW_PROJ_COMMENT 
        FROM COI_TRAVEL_DISCLOSURE 
        WHERE TRAVEL_DISCLOSURE_ID = AV_DISCLOSURE_ID AND PERSON_ID = AV_PERSON_ID;
 
        SET LS_ALL_COMMENT_RIGHTS = 'VIEW_TRAVEL_COMMENTS,MAINTAIN_TRAVEL_COMMENTS,VIEW_TRAVEL_PRIVATE_COMMENTS,MAINTAIN_TRAVEL_PRIVATE_COMMENTS';
        SET LS_ALL_PRIVATE_COMMENT_RIGHTS = 'VIEW_TRAVEL_PRIVATE_COMMENTS,MAINTAIN_TRAVEL_PRIVATE_COMMENTS';
 
    ELSE
        SET LI_CAN_VIEW_PROJ_COMMENT = 0;
    END IF;
 
 IF (LI_CAN_VIEW_PROJ_COMMENT = 0) THEN
        SELECT COUNT(*) INTO LI_CAN_VIEW_PROJ_COMMENT
        FROM (
            SELECT UNIT_NUMBER
            FROM PERSON_ROLES T1
            INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
            INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
            WHERE T1.DESCEND_FLAG = 'N' AND T1.PERSON_ID = AV_PERSON_ID
            AND FIND_IN_SET(T3.RIGHT_NAME, LS_ALL_COMMENT_RIGHTS)                            
            UNION
            SELECT CHILD_UNIT_NUMBER FROM UNIT_WITH_CHILDREN 
            WHERE UNIT_NUMBER IN (
                SELECT UNIT_NUMBER
                FROM PERSON_ROLES T1
                INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
                INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
                WHERE T1.DESCEND_FLAG = 'Y' AND T1.PERSON_ID = AV_PERSON_ID
                AND FIND_IN_SET(T3.RIGHT_NAME, LS_ALL_COMMENT_RIGHTS)
            )
        ) AS T;
    END IF;
 
    IF AV_MODULE_CODE = 8 AND LI_CAN_VIEW_PROJ_COMMENT > 0 THEN
        WITH DISCLOSURE_PROJECTS AS (
            SELECT MODULE_CODE, MODULE_ITEM_KEY
            FROM COI_DISCL_PROJECTS
            WHERE DISCLOSURE_ID = AV_DISCLOSURE_ID
        )
        SELECT 
            (SELECT COUNT(CPD.COMMENT_ID)
             FROM COI_PROJECT_COMMENT CPD
             JOIN DISCLOSURE_PROJECTS DP ON DP.MODULE_ITEM_KEY = CPD.MODULE_ITEM_KEY
             WHERE CPD.MODULE_CODE = 1
               AND DP.MODULE_CODE = 1
               AND CPD.COMMENT_TYPE_CODE = 1
               AND CPD.PARENT_COMMENT_ID IS NULL) +
               
            (SELECT COUNT(CPD.COMMENT_ID)
             FROM COI_PROJECT_COMMENT CPD
             JOIN DISCLOSURE_PROJECTS DP ON DP.MODULE_ITEM_KEY = CPD.MODULE_ITEM_KEY
             WHERE CPD.MODULE_CODE = 3
               AND DP.MODULE_CODE = 3
               AND CPD.COMMENT_TYPE_CODE = 1
               AND CPD.PARENT_COMMENT_ID IS NULL)
        INTO LI_PROJ_TOTAL_COMMENT_COUNT;
    END IF;
 
     SELECT COUNT(*) INTO LI_CAN_VIEW_PRIVATE_COMMENT
        FROM (
            SELECT UNIT_NUMBER
            FROM PERSON_ROLES T1
            INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
            INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
            WHERE T1.DESCEND_FLAG = 'N' AND T1.PERSON_ID = AV_PERSON_ID
            AND FIND_IN_SET(T3.RIGHT_NAME, LS_ALL_PRIVATE_COMMENT_RIGHTS)                            
            UNION
            SELECT CHILD_UNIT_NUMBER FROM UNIT_WITH_CHILDREN 
            WHERE UNIT_NUMBER IN (
                SELECT UNIT_NUMBER
                FROM PERSON_ROLES T1
                INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
                INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
                WHERE T1.DESCEND_FLAG = 'Y' AND T1.PERSON_ID = AV_PERSON_ID
                AND FIND_IN_SET(T3.RIGHT_NAME, LS_ALL_PRIVATE_COMMENT_RIGHTS)
            )
            UNION
            SELECT 'COI_REVIEW_ASSIGNEE'
			WHERE EXISTS (
				SELECT 1 
				FROM COI_REVIEW CR 
				WHERE CR.ASSIGNEE_PERSON_ID = AV_PERSON_ID
                AND CR.DISCLOSURE_ID = AV_DISCLOSURE_ID
			)
        ) AS T;
 
    IF LI_CAN_VIEW_PRIVATE_COMMENT > 0 THEN
        SELECT COUNT(DC.COMMENT_ID)
        INTO LI_REVIEW_TOTAL_COMMENT_COUNT
        FROM DISCL_COMMENT DC
        WHERE DC.MODULE_CODE = AV_MODULE_CODE
          AND DC.MODULE_ITEM_KEY = AV_DISCLOSURE_ID
          AND DC.COMPONENT_TYPE_CODE IN ('3','4','5','6','8','9','2','10','11','12','13','14')
          AND DC.PARENT_COMMENT_ID IS NULL;
    ELSE
        SELECT COUNT(DC.COMMENT_ID)
        INTO LI_REVIEW_TOTAL_COMMENT_COUNT
        FROM DISCL_COMMENT DC
        WHERE DC.MODULE_CODE = AV_MODULE_CODE
          AND DC.MODULE_ITEM_KEY = AV_DISCLOSURE_ID
          AND DC.COMPONENT_TYPE_CODE IN ('3','4','5','6','8','9','2','10','11','12','13','14')
          AND DC.PARENT_COMMENT_ID IS NULL
          AND (
              DC.IS_PRIVATE = 'N'
              OR (DC.IS_PRIVATE = 'Y' AND DC.COMMENT_BY_PERSON_ID = AV_PERSON_ID)
          );
    END IF;
 
    RETURN LI_PROJ_TOTAL_COMMENT_COUNT + LI_REVIEW_TOTAL_COMMENT_COUNT;
END
//
