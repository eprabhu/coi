DELIMITER //
CREATE FUNCTION `FN_CHK_IS_HOME_UNIT_SUBMISSION`(
    AV_DISCLOSURE_ID INT,
    AV_PERSON_ID VARCHAR(60),
    AV_MODULE_CODE INT
) RETURNS tinyint
    READS SQL DATA
    DETERMINISTIC
BEGIN
    DECLARE LS_HOME_UNIT VARCHAR(50);
    DECLARE LI_HAS_ACCESS TINYINT DEFAULT 0;
    
    CASE AV_MODULE_CODE
        WHEN 8 THEN
            SELECT HOME_UNIT INTO LS_HOME_UNIT
            FROM COI_DISCLOSURE
            WHERE DISCLOSURE_ID = AV_DISCLOSURE_ID;
            
        WHEN 23 THEN
            SELECT HOME_UNIT INTO LS_HOME_UNIT
            FROM OPA_DISCLOSURE
            WHERE OPA_DISCLOSURE_ID = AV_DISCLOSURE_ID;
            
        WHEN 24 THEN
            SELECT HOME_UNIT INTO LS_HOME_UNIT
            FROM COI_TRAVEL_DISCLOSURE
            WHERE TRAVEL_DISCLOSURE_ID = AV_DISCLOSURE_ID;
            
        WHEN 28 THEN
            SELECT P.HOME_UNIT INTO LS_HOME_UNIT
            FROM COI_DECLARATION CD
            INNER JOIN PERSON P ON CD.PERSON_ID = P.PERSON_ID
            WHERE CD.DECLARATION_ID = AV_DISCLOSURE_ID;
            
        ELSE
            RETURN 0;
    END CASE;
    
    IF LS_HOME_UNIT IS NULL THEN
        RETURN 0;
    END IF;
    
    SET @rights_list = CASE AV_MODULE_CODE
        WHEN 8 THEN
            CASE (SELECT FCOI_TYPE_CODE FROM COI_DISCLOSURE WHERE DISCLOSURE_ID = AV_DISCLOSURE_ID)
                WHEN 2 THEN 'MANAGE_PROJECT_DISCLOSURE,VIEW_PROJECT_DISCLOSURE,VIEW_ADMIN_GROUP_COI'
                ELSE 'MANAGE_FCOI_DISCLOSURE,VIEW_FCOI_DISCLOSURE,VIEW_ADMIN_GROUP_COI'
            END
        WHEN 23 THEN 'MANAGE_OPA_DISCLOSURE,VIEW_OPA_DISCLOSURE'
        WHEN 24 THEN 'MANAGE_TRAVEL_DISCLOSURE,VIEW_TRAVEL_DISCLOSURE'
        WHEN 28 THEN 'MANAGE_MFTRP_DECLARATION,VIEW_MFTRP_DECLARATION'
    END;
    
    SELECT 1 INTO LI_HAS_ACCESS
    FROM PERSON_ROLES PR
    INNER JOIN ROLE_RIGHTS RR ON PR.ROLE_ID = RR.ROLE_ID
    INNER JOIN RIGHTS R ON RR.RIGHT_ID = R.RIGHT_ID
    WHERE PR.PERSON_ID = AV_PERSON_ID
      AND FIND_IN_SET(R.RIGHT_NAME, @rights_list) > 0
      AND (
          (PR.DESCEND_FLAG = 'N' AND PR.UNIT_NUMBER = LS_HOME_UNIT)
          OR
          (PR.DESCEND_FLAG = 'Y' AND EXISTS (
              SELECT 1 
              FROM UNIT_WITH_CHILDREN U
              WHERE U.UNIT_NUMBER = PR.UNIT_NUMBER
                AND U.CHILD_UNIT_NUMBER = LS_HOME_UNIT
          ))
      )
    LIMIT 1;
    RETURN COALESCE(LI_HAS_ACCESS, 0);
END
//
