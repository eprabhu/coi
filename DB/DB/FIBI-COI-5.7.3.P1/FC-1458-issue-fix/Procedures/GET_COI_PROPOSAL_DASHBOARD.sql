DELIMITER //
CREATE PROCEDURE `GET_COI_PROPOSAL_DASHBOARD`(
	AV_PERSON_ID              VARCHAR(40),
    AV_SEARCHWORD		      VARCHAR(40),
    AV_PAGED                  INT,
    AV_LIMIT                  INT,
    AV_IS_COUNT               BOOLEAN,
    AV_IS_UNLIMITED           BOOLEAN
)
BEGIN

    DECLARE LS_FILTER_CONDITION LONGTEXT;
    DECLARE LS_JOIN_CONDITION   LONGTEXT;
    DECLARE LS_DYN_SQL          LONGTEXT;
    DECLARE LI_OFFSET_CONDITION VARCHAR(600);
    DECLARE LI_OFFSET           INT;
	DECLARE SEARCH_CONDITION    LONGTEXT;

    -- Initialize variables
    SET LS_DYN_SQL = '';
    SET LS_FILTER_CONDITION = '';
    SET LS_JOIN_CONDITION = '';
	SET SEARCH_CONDITION = '';
    SET LI_OFFSET = COALESCE(AV_LIMIT * AV_PAGED, 0);


    IF AV_SEARCHWORD IS NOT NULL THEN
        SET AV_SEARCHWORD = CONCAT('''%',AV_SEARCHWORD, '%''');
        SET SEARCH_CONDITION = CONCAT(' AND (LOWER(T1.EXTERNAL_SYSTEM_REF_ID) LIKE CONCAT(', AV_SEARCHWORD,')
                                        OR LOWER(T1.TITLE) LIKE CONCAT(', AV_SEARCHWORD, ')
                                       	OR LOWER(T1.LEAD_UNIT_NUMBER) LIKE CONCAT(', AV_SEARCHWORD, ')
                                       	OR LOWER(T1.LEAD_UNIT_NAME) LIKE CONCAT(', AV_SEARCHWORD, ')
                                       	OR LOWER(T1.SPONSOR_NAME) LIKE CONCAT(', AV_SEARCHWORD, ')
                                       	OR LOWER(T1.PRIME_SPONSOR_NAME) LIKE CONCAT(', AV_SEARCHWORD, ')
                                       	OR LOWER(T1.PI_NAME) LIKE CONCAT(', AV_SEARCHWORD, ')
                                       	OR LOWER(T1.KEY_PERSON_NAME) LIKE CONCAT(', AV_SEARCHWORD, ')
                                       	OR LOWER(T1.KEY_PERSON_ID) LIKE CONCAT(', AV_SEARCHWORD,'))');
    END IF;

    IF AV_IS_COUNT = TRUE THEN
        SET LI_OFFSET_CONDITION = '';
        SET LS_DYN_SQL = CONCAT(LS_DYN_SQL, ' SELECT COUNT(*) AS COUNT');
    ELSE
        IF AV_LIMIT = 0 OR (AV_IS_UNLIMITED IS NOT NULL AND AV_IS_UNLIMITED = TRUE) THEN
            SET LI_OFFSET_CONDITION = '';
        ELSE
            SET LI_OFFSET_CONDITION = CONCAT(' LIMIT ', AV_LIMIT, ' OFFSET ', LI_OFFSET);
        END IF;
        SET LS_DYN_SQL = CONCAT(LS_DYN_SQL, ' SELECT * ');
    END IF;

			SET LS_DYN_SQL = CONCAT(LS_DYN_SQL,' FROM (SELECT DISTINCT T1.EXTERNAL_SYSTEM_REF_ID AS PROPOSAL_ID, T1.TITLE, T1.PROPOSAL_STATUS AS STATUS, T1.PROPOSAL_START_DATE AS START_DATE,
                T1.PROPOSAL_END_DATE AS END_DATE, T1.LEAD_UNIT_NUMBER AS HOME_UNIT_NUMBER, T1.LEAD_UNIT_NAME AS HOME_UNIT_NAME,
                T1.SPONSOR_CODE, T1.PRIME_SPONSOR_CODE, T1.SPONSOR_NAME,
                T1.PRIME_SPONSOR_NAME, T1.PI_NAME AS PI, T1.KEY_PERSON_NAME AS KEY_PERSON, T1.KEY_PERSON_ID, T1.KEY_PERSON_ROLE_NAME,
                T2.COI_PROJECT_TYPE_CODE AS PROJECT_TYPE_CODE, T2.DESCRIPTION AS PROJECT_TYPE,T2.BADGE_COLOR, T2.PROJECT_ICON
                FROM COI_PROJECT_PROPOSAL_V T1
                INNER JOIN COI_PROJECT_TYPE T2 ON T2.COI_PROJECT_TYPE_CODE = T1.COI_PROJECT_TYPE_CODE
                LEFT JOIN coi_discl_projects T3 ON T3.MODULE_ITEM_KEY = T1.EXTERNAL_SYSTEM_REF_ID AND T3.MODULE_CODE = T2.COI_PROJECT_TYPE_CODE
                LEFT JOIN coi_disclosure T4 ON T4.DISCLOSURE_ID = T3.DISCLOSURE_ID AND T4.PERSON_ID = ', AV_PERSON_ID, '
                WHERE T1.PROPOSAL_STATUS_CODE IN (1,3)
                AND (T3.MODULE_ITEM_KEY IS NULL OR T1.EXTERNAL_SYSTEM_REF_ID != T3.MODULE_ITEM_KEY)  ', SEARCH_CONDITION ,
                'AND T1.KEY_PERSON_ID =', AV_PERSON_ID,
            ') T ',LI_OFFSET_CONDITION);

    -- Execute dynamic SQL
    SET @QUERY_STATEMENT = LS_DYN_SQL;
    PREPARE EXECUTABLE_STATEMENT FROM @QUERY_STATEMENT;
    EXECUTE EXECUTABLE_STATEMENT;
    DEALLOCATE PREPARE EXECUTABLE_STATEMENT;

END
//
