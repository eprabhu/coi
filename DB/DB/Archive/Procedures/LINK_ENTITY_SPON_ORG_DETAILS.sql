DELIMITER //
CREATE PROCEDURE LINK_ENTITY_SPON_ORG_DETAILS(
    AV_BATCH_ID INT
)
BEGIN

    DECLARE LI_ROLODEX_ID               INT;
    DECLARE LI_ENTITY_STAGE_DETAIL_ID   INT;
    DECLARE LI_ENTITY_ID                INT;
    DECLARE LI_ENTITY_NUMBER                INT;
    DECLARE LS_SRC_TYPE_CODE            VARCHAR(3);

    DECLARE LI_MIG_ENTITY_STAGE_DETAIL_ID   INT;
    DECLARE LS_SRC_DATA_TYPE_CODE       VARCHAR(3);
    DECLARE LS_SRC_DATA_CODE            VARCHAR(20);
    DECLARE LS_SRC_DATA_NAME            VARCHAR(300);
    DECLARE LS_SRC_ADDRESS_LINE_1       VARCHAR(200);
    DECLARE LS_SRC_ADDRESS_LINE_2       VARCHAR(200);
    DECLARE LS_SRC_POSTAL_CODE          VARCHAR(30);
    DECLARE LS_SRC_STATE                VARCHAR(30);
    DECLARE LS_SRC_COUNTRY_CODE         VARCHAR(3);
    DECLARE LS_SRC_COMMENTS             VARCHAR(300);
    DECLARE LS_SRC_ACRONYM              VARCHAR(10);
    DECLARE LI_ENTITY_SUB_ORG_INFO      BOOLEAN;
    DECLARE LI_ENTITY_SPONSOR_INFO      BOOLEAN;
    DECLARE LI_FEED_STATUS_CODE         VARCHAR(3);
    DECLARE LS_FEED_STATUS              VARCHAR(200);
    DECLARE LS_ACT_LOG_MESSAGE          VARCHAR(300);
    DECLARE LS_SRC_RISK_LEVEL_CODE      VARCHAR(30);

    DECLARE done INT DEFAULT FALSE;

    DECLARE BATCH_CUR CURSOR FOR select t1.SRC_ROLODEX_ID, t1.ENTITY_STAGE_DETAIL_ID, t2.SRC_TYPE_CODE, t1.SRC_DATA_CODE,
        t1.SRC_DATA_NAME, t1.SRC_RISK_LEVEL_CODE from entity_stage_details t1
        INNER JOIN entity_stage_batch t2 ON t2.batch_id = t1.batch_id
        where t1.batch_id = AV_BATCH_ID;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

    OPEN BATCH_CUR;

    read_loop: LOOP
        FETCH BATCH_CUR INTO LI_ROLODEX_ID, LI_ENTITY_STAGE_DETAIL_ID, LS_SRC_TYPE_CODE, LS_SRC_DATA_CODE, LS_SRC_DATA_NAME, LS_SRC_RISK_LEVEL_CODE;

        IF done THEN
            LEAVE read_loop;
        END IF;

        SELECT DISTINCT t1.ENTITY_ID, t1.ENTITY_STAGE_DETAIL_ID INTO LI_ENTITY_ID, LI_MIG_ENTITY_STAGE_DETAIL_ID
            FROM entity_stage_details t1
            WHERE t1.SRC_ROLODEX_ID = LI_ROLODEX_ID AND t1.ENTITY_STAGE_DETAIL_ID != LI_ENTITY_STAGE_DETAIL_ID
                AND ADMIN_REVIEW_STATUS_CODE = 2;

        IF LS_SRC_TYPE_CODE IS NOT NULL AND LS_SRC_TYPE_CODE = 1 THEN

            UPDATE entity_sponsor_info t1, entity_stage_details t2, country t3
                SET t1.SPONSOR_CODE = t2.SRC_DATA_CODE,
                    t1.SPONSOR_TYPE_CODE = t2.SRC_DATA_TYPE_CODE,
                    t1.SPONSOR_NAME = t2.SRC_DATA_NAME,
                    t1.PRIMARY_ADDRESS_LINE_1 = t2.SRC_ADDRESS_LINE_1,
                    t1.PRIMARY_ADDRESS_LINE_2 = t2.SRC_ADDRESS_LINE_2,
                    t1.POST_CODE = t2.SRC_POSTAL_CODE,
                    t1.COUNTRY_CODE = t3.COUNTRY_CODE,
                    t1.COMMENTS = t2.SRC_COMMENTS,
                    t1.ACRONYM = t2.SRC_ACRONYM,
                    t1.IS_COPY = 'N'
                WHERE t2.ENTITY_STAGE_DETAIL_ID = LI_ENTITY_STAGE_DETAIL_ID AND t1.ENTITY_ID = LI_ENTITY_ID
                AND t3.COUNTRY_CODE_ISO2 = t2.SRC_COUNTRY_CODE;

            INSERT INTO entity_external_id_mapping(ENTITY_ID,EXTERNAL_ID_TYPE_CODE,EXTERNAL_ID,DESCRIPTION,SPONSOR_CODE,UPDATED_BY,UPDATE_TIMESTAMP)
            VALUES(LI_ENTITY_ID, 1,LS_SRC_DATA_CODE,  LS_SRC_DATA_NAME, LS_SRC_DATA_CODE, 'admin', UTC_TIMESTAMP());


            UPDATE entity_sub_org_info t1, entity_stage_details t2, country t3
                SET t1.PRIMARY_ADDRESS_LINE_1 = t2.SRC_ADDRESS_LINE_1,
                    t1.PRIMARY_ADDRESS_LINE_2 = t2.SRC_ADDRESS_LINE_2,
                    t1.POST_CODE = t2.SRC_POSTAL_CODE,
                    t1.COUNTRY_CODE = t3.COUNTRY_CODE
                WHERE t2.ENTITY_STAGE_DETAIL_ID = LI_ENTITY_STAGE_DETAIL_ID AND t1.ENTITY_ID = LI_ENTITY_ID
                AND t3.COUNTRY_CODE_ISO2 = t2.SRC_COUNTRY_CODE;

        ELSE

            UPDATE entity_sub_org_info t1, entity_stage_details t2
                SET t1.ORGANIZATION_ID = t2.SRC_DATA_CODE,
                    t1.ORGANIZATION_TYPE_CODE = t2.SRC_DATA_TYPE_CODE,
                    t1.ORGANIZATION_NAME = t2.SRC_DATA_NAME
                WHERE t2.ENTITY_STAGE_DETAIL_ID = LI_ENTITY_STAGE_DETAIL_ID AND t1.ENTITY_ID = LI_ENTITY_ID;

            INSERT INTO entity_risk
            (ENTITY_ID,RISK_TYPE_CODE,RISK_LEVEL_CODE,DESCRIPTION,UPDATE_TIMESTAMP,UPDATED_BY)
            VALUES(LI_ENTITY_ID, 4, LS_SRC_RISK_LEVEL_CODE, '"Risk from Import Entity"', utc_timestamp(), 'admin');

            INSERT INTO entity_external_id_mapping(ENTITY_ID,EXTERNAL_ID_TYPE_CODE,EXTERNAL_ID,DESCRIPTION,ORGANIZATION_ID,UPDATED_BY,UPDATE_TIMESTAMP)
                        VALUES(LI_ENTITY_ID, 2,LS_SRC_DATA_CODE,  LS_SRC_DATA_NAME, LS_SRC_DATA_CODE, 'admin', UTC_TIMESTAMP());

        END IF;

        call GET_ENTITY_TAB_STATUS_FOR_MIG(LI_ENTITY_ID);

        select entity_sub_org_info, entity_sponsor_info into LI_ENTITY_SUB_ORG_INFO, LI_ENTITY_SPONSOR_INFO from TMP_ENTITY_TAB_STATUS;

        IF LI_ENTITY_SUB_ORG_INFO THEN

            SELECT t1.FEED_STATUS_CODE, t2.DESCRIPTION, t3.ENTITY_NUMBER INTO LI_FEED_STATUS_CODE, LS_FEED_STATUS, LI_ENTITY_NUMBER
                FROM entity_sub_org_info t1, entity_feed_status_type t2, entity t3
                where t1.ENTITY_ID = LI_ENTITY_ID AND t1.FEED_STATUS_CODE = t2.FEED_STATUS_CODE AND t3.ENTITY_ID = t1.ENTITY_ID;

            UPDATE entity_sub_org_info set FEED_STATUS_CODE = 2 where ENTITY_ID = LI_ENTITY_ID;

            IF LI_FEED_STATUS_CODE != 2 THEN

                SELECT MESSAGE INTO LS_ACT_LOG_MESSAGE FROM entity_action_type WHERE ACTION_TYPE_CODE = 11;

                SET LS_ACT_LOG_MESSAGE = REPLACE(
                REPLACE(LS_ACT_LOG_MESSAGE, '{OLD_STATUS}', LS_FEED_STATUS), '{NEW_STATUS}', (SELECT DESCRIPTION FROM entity_feed_status_type WHERE FEED_STATUS_CODE = 2) );

                insert into entity_action_log(ENTITY_ID, ENTITY_NUMBER, ACTION_TYPE_CODE, DESCRIPTION, UPDATE_TIMESTAMP, UPDATE_USER)
                values(LI_ENTITY_ID, LI_ENTITY_NUMBER, 11, LS_ACT_LOG_MESSAGE, UTC_TIMESTAMP(), 'admin');

            END IF;

        END IF;

        IF LI_ENTITY_SPONSOR_INFO THEN
            SELECT t1.FEED_STATUS_CODE, t2.DESCRIPTION, t3.ENTITY_NUMBER INTO LI_FEED_STATUS_CODE, LS_FEED_STATUS, LI_ENTITY_NUMBER
                FROM entity_sponsor_info t1, entity_feed_status_type t2, entity t3
                where t1.ENTITY_ID = LI_ENTITY_ID AND t1.FEED_STATUS_CODE = t2.FEED_STATUS_CODE AND t3.ENTITY_ID = t1.ENTITY_ID;

            UPDATE entity_sponsor_info set FEED_STATUS_CODE = 2 where ENTITY_ID = LI_ENTITY_ID;

            IF LI_FEED_STATUS_CODE != 2 THEN

                SELECT MESSAGE INTO LS_ACT_LOG_MESSAGE FROM entity_action_type WHERE ACTION_TYPE_CODE = 10;

                SET LS_ACT_LOG_MESSAGE = REPLACE(
                REPLACE(LS_ACT_LOG_MESSAGE, '{OLD_STATUS}', LS_FEED_STATUS), '{NEW_STATUS}', (SELECT DESCRIPTION FROM entity_feed_status_type WHERE FEED_STATUS_CODE = 2) );

                insert into entity_action_log(ENTITY_ID, ENTITY_NUMBER, ACTION_TYPE_CODE, DESCRIPTION, UPDATE_TIMESTAMP, UPDATE_USER)
                values(LI_ENTITY_ID, LI_ENTITY_NUMBER, 10, LS_ACT_LOG_MESSAGE, UTC_TIMESTAMP(), 'admin');

            END IF;

        END IF;

        UPDATE entity_stage_details set ADMIN_REVIEW_STATUS_CODE = 2, ADMIN_ACTION_CODE = 7 where ENTITY_STAGE_DETAIL_ID = LI_ENTITY_STAGE_DETAIL_ID;

    END LOOP;

    CLOSE BATCH_CUR;
END
//
