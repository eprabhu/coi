DELIMITER //
CREATE PROCEDURE `GET_COI_DECLARATION_DETAIL_INTEG`(
AV_DECLARATION_ID		  INT
)
BEGIN

    SELECT d.DECLARATION_ID,
        d.DECLARATION_NUMBER,
        d.PERSON_ID,
        d.DECLARATION_TYPE_CODE,
        dt.DESCRIPTION AS DECLARATION_TYPE,
        d.DECLARATION_STATUS_CODE,
        ds.DESCRIPTION AS DECLARATION_STATUS,
        d.SUBMISSION_DATE,
        d.EXPIRATION_DATE,
        d.VERSION_NUMBER,
        d.VERSION_STATUS,
        d.CREATED_BY,
        d.CREATE_TIMESTAMP,
        d.UPDATED_BY,
        d.UPDATE_TIMESTAMP,
        ce.VALUE AS DECLARATION_QUE_ANS,
        d.REVIEW_STATUS_CODE,
        r.DESCRIPTION as REVIEW_STATUS,
        CASE
            WHEN ce.VALUE = 'Yes' THEN TRUE
            ELSE FALSE
        END AS REVIEW_REQUIRED
    FROM COI_DECLARATION d
    JOIN COI_DECLARATION_TYPE dt ON dt.DECLARATION_TYPE_CODE = d.DECLARATION_TYPE_CODE
    JOIN COI_DECLARATION_STATUS ds ON ds.DECLARATION_STATUS_CODE = d.DECLARATION_STATUS_CODE
    LEFT JOIN DECLARATION_REVIEW_STATUS_TYPE r ON r.REVIEW_STATUS_CODE = d.REVIEW_STATUS_CODE
    LEFT JOIN (
        SELECT VALUE, MODULE_ITEM_KEY
            FROM (
                SELECT
                   VALUE,
                   MODULE_ITEM_KEY,
                   ROW_NUMBER() OVER (PARTITION BY MODULE_ITEM_KEY ORDER BY UPDATE_TIMESTAMP DESC) rn
                FROM fb_comp_custom_element_answer
                WHERE CUSTOM_DATA_ELEMENTS_ID = 552
                    AND MODULE_ITEM_CODE = 28
                    AND MODULE_ITEM_KEY = AV_DECLARATION_ID
                    AND TRIM(IFNULL(VALUE, '')) <> ''
           ) t
           WHERE rn = 1
    ) ce ON ce.MODULE_ITEM_KEY = d.DECLARATION_ID
    WHERE d.DECLARATION_ID = AV_DECLARATION_ID;
END
//
