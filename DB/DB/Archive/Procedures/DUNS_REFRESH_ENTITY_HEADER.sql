DELIMITER //
CREATE PROCEDURE `DUNS_REFRESH_ENTITY_HEADER`(
	IN AV_ENTITY_ID INT,
	IN AV_PRIMARY_NAME VARCHAR(500),
	IN AV_FOREIGN_NAME VARCHAR(500),
	IN AV_PRIOR_NAME VARCHAR(200),
	IN AV_SHORT_NAME VARCHAR(200),
	IN AV_DUNS_NUMBER VARCHAR(20),
	IN AV_UEI_NUMBER VARCHAR(20),
	IN AV_CAGE_NUMBER VARCHAR(20),
	IN AV_FEDERAL_EMPLOYER_ID VARCHAR(50),
	IN AV_ENTITY_OWNERSHIP_TYPE_CODE VARCHAR(10),
	IN AV_OPERATING_STATUS_TYPE_CODE VARCHAR(10),
	IN AV_BUSINESS_TYPE_CODE VARCHAR(10),
	IN AV_WEBSITE_ADDRESS VARCHAR(500),
	IN AV_START_DATE VARCHAR(10),
	IN AV_INCORPORATION_DATE VARCHAR(10),
	IN AV_NUMBER_OF_EMPLOYEES INT,
	IN AV_CERTIFIED_EMAIL VARCHAR(200),
	IN AV_ACTIVITY_TEXT VARCHAR(1000),
	IN AV_CURRENCY_CODE VARCHAR(3),
	IN AV_PHONE_NUMBER VARCHAR(15),
	IN AV_PRIMARY_ADDRESS_LINE_1 VARCHAR(500),
	IN AV_PRIMARY_ADDRESS_LINE_2 VARCHAR(500),
	IN AV_CITY VARCHAR(30),
	IN AV_STATE VARCHAR(30),
	IN AV_POST_CODE VARCHAR(15),
	IN ALS_COUNTRY_CODE VARCHAR(3),
	IN AV_HUMAN_SUB_ASSURANCE VARCHAR(50),
	IN AV_ANIMAL_WELFARE_ASSURANCE VARCHAR(50),
	IN AV_ANIMAL_ACCREDITATION VARCHAR(50),
	IN AV_PERSON_ID VARCHAR(40)
)
DETERMINISTIC
BEGIN
	DECLARE DYN_QUERY TEXT DEFAULT 'UPDATE entity SET ';
	DECLARE LS_COUNTRY_CODE VARCHAR(3);
	DECLARE CLAUSE_LIST TEXT DEFAULT '';
	DECLARE STMT TEXT;

	-- Prepare update clause
	SET CLAUSE_LIST = CONCAT_WS(', ',
	    CONCAT(' UPDATED_BY = ', QUOTE(AV_PERSON_ID), ', UPDATE_TIMESTAMP = NOW() '),
		IF(AV_PRIMARY_NAME IS NOT NULL, CONCAT('PRIMARY_NAME = ', IF(AV_PRIMARY_NAME = '', 'NULL', QUOTE(AV_PRIMARY_NAME)), ''), NULL),
		IF(AV_FOREIGN_NAME IS NOT NULL, CONCAT('FOREIGN_NAME = ', IF(AV_FOREIGN_NAME = '', 'NULL', QUOTE(AV_FOREIGN_NAME)), ''), NULL),
		IF(AV_PRIOR_NAME IS NOT NULL, CONCAT('PRIOR_NAME = ', IF(AV_PRIOR_NAME = '', 'NULL', QUOTE(AV_PRIOR_NAME)), ''), NULL),
		IF(AV_SHORT_NAME IS NOT NULL, CONCAT('SHORT_NAME = ', IF(AV_SHORT_NAME = '', 'NULL', QUOTE(AV_SHORT_NAME)), ''), NULL),
		IF(AV_DUNS_NUMBER IS NOT NULL, CONCAT('DUNS_NUMBER = ', IF(AV_DUNS_NUMBER = '', 'NULL', QUOTE(AV_DUNS_NUMBER)), ''), NULL),
		IF(AV_UEI_NUMBER IS NOT NULL, CONCAT('UEI_NUMBER = ', IF(AV_UEI_NUMBER = '', 'NULL', QUOTE(AV_UEI_NUMBER)), ''), NULL),
		IF(AV_CAGE_NUMBER IS NOT NULL, CONCAT('CAGE_NUMBER = ', IF(AV_CAGE_NUMBER = '', 'NULL', QUOTE(AV_CAGE_NUMBER)), ''), NULL),
		IF(AV_FEDERAL_EMPLOYER_ID IS NOT NULL, CONCAT('FEDERAL_EMPLOYER_ID = ', IF(AV_FEDERAL_EMPLOYER_ID = '', 'NULL', QUOTE(AV_FEDERAL_EMPLOYER_ID)), ''), NULL),
		IF(AV_ENTITY_OWNERSHIP_TYPE_CODE IS NOT NULL, CONCAT('ENTITY_OWNERSHIP_TYPE_CODE = ', IF(AV_ENTITY_OWNERSHIP_TYPE_CODE = '', 'NULL', QUOTE(AV_ENTITY_OWNERSHIP_TYPE_CODE)), ''), NULL),
		IF(AV_OPERATING_STATUS_TYPE_CODE IS NOT NULL, CONCAT('OPERATING_STATUS_TYPE_CODE = ', IF(AV_OPERATING_STATUS_TYPE_CODE = '', 'NULL', QUOTE(AV_OPERATING_STATUS_TYPE_CODE)), ''), NULL),
		IF(AV_BUSINESS_TYPE_CODE IS NOT NULL, CONCAT('BUSINESS_TYPE_CODE = ', IF(AV_BUSINESS_TYPE_CODE = '', 'NULL', QUOTE(AV_BUSINESS_TYPE_CODE)), ''), NULL),
		IF(AV_WEBSITE_ADDRESS IS NOT NULL, CONCAT('WEBSITE_ADDRESS = ', IF(AV_WEBSITE_ADDRESS = '', 'NULL', QUOTE(AV_WEBSITE_ADDRESS)), ''), NULL),
		IF(AV_START_DATE IS NOT NULL, CONCAT('START_DATE = ', IF(AV_START_DATE = '', 'NULL', QUOTE(AV_START_DATE)), ''), NULL),
		IF(AV_INCORPORATION_DATE IS NOT NULL, CONCAT('INCORPORATION_DATE = ', IF(AV_INCORPORATION_DATE = '', 'NULL', QUOTE(AV_INCORPORATION_DATE)), ''), NULL),
		IF(AV_NUMBER_OF_EMPLOYEES IS NOT NULL, CONCAT('NUMBER_OF_EMPLOYEES = ', AV_NUMBER_OF_EMPLOYEES), NULL),
		IF(AV_CERTIFIED_EMAIL IS NOT NULL, CONCAT('CERTIFIED_EMAIL = ', IF(AV_CERTIFIED_EMAIL = '', 'NULL', QUOTE(AV_CERTIFIED_EMAIL)), ''), NULL),
		IF(AV_ACTIVITY_TEXT IS NOT NULL, CONCAT('ACTIVITY_TEXT = ', IF(AV_ACTIVITY_TEXT = '', 'NULL', QUOTE(AV_ACTIVITY_TEXT)), ''), NULL),
		IF(AV_CURRENCY_CODE IS NOT NULL, CONCAT('CURRENCY_CODE = ', IF(AV_CURRENCY_CODE = '', 'NULL', QUOTE(AV_CURRENCY_CODE)), ''), NULL),
		IF(AV_PHONE_NUMBER IS NOT NULL, CONCAT('PHONE_NUMBER = ', IF(AV_PHONE_NUMBER = '', 'NULL', QUOTE(AV_PHONE_NUMBER)), ''), NULL),
		IF(AV_PRIMARY_ADDRESS_LINE_1 IS NOT NULL, CONCAT('PRIMARY_ADDRESS_LINE_1 = ', IF(AV_PRIMARY_ADDRESS_LINE_1 = '', 'NULL', QUOTE(AV_PRIMARY_ADDRESS_LINE_1)), ''), NULL),
		IF(AV_PRIMARY_ADDRESS_LINE_2 IS NOT NULL, CONCAT('PRIMARY_ADDRESS_LINE_2 = ', IF(AV_PRIMARY_ADDRESS_LINE_2 = '', 'NULL', QUOTE(AV_PRIMARY_ADDRESS_LINE_2)), ''), NULL),
		IF(AV_CITY IS NOT NULL, CONCAT('CITY = ', IF(AV_CITY = '', 'NULL', QUOTE(AV_CITY)), ''), NULL),
		IF(AV_STATE IS NOT NULL, CONCAT('STATE = ', IF(AV_STATE = '', 'NULL', QUOTE(AV_STATE)), ''), NULL),
		IF(AV_POST_CODE IS NOT NULL, CONCAT('POST_CODE = ', IF(AV_POST_CODE = '', 'NULL', QUOTE(AV_POST_CODE)), ''), NULL),
		IF(AV_HUMAN_SUB_ASSURANCE IS NOT NULL, CONCAT('HUMAN_SUB_ASSURANCE = ', IF(AV_HUMAN_SUB_ASSURANCE = '', 'NULL', QUOTE(AV_HUMAN_SUB_ASSURANCE)), ''), NULL),
		IF(AV_ANIMAL_WELFARE_ASSURANCE IS NOT NULL, CONCAT('ANIMAL_WELFARE_ASSURANCE = ', IF(AV_ANIMAL_WELFARE_ASSURANCE = '', 'NULL', QUOTE(AV_ANIMAL_WELFARE_ASSURANCE)), ''), NULL),
		IF(AV_ANIMAL_ACCREDITATION IS NOT NULL, CONCAT('ANIMAL_ACCREDITATION = ', IF(AV_ANIMAL_ACCREDITATION = '', 'NULL', QUOTE(AV_ANIMAL_ACCREDITATION)), ''), NULL)
	);

	-- Fetch country_code if given
	IF ALS_COUNTRY_CODE IS NOT NULL THEN
		SELECT COUNTRY_CODE INTO LS_COUNTRY_CODE
		FROM country
		WHERE ISO_COUNTRY_CODE = ALS_COUNTRY_CODE
		LIMIT 1;

		IF LS_COUNTRY_CODE IS NOT NULL THEN
			SET CLAUSE_LIST = CONCAT(CLAUSE_LIST, ', COUNTRY_CODE = ', QUOTE(LS_COUNTRY_CODE));
		END IF;
	END IF;

	-- Finalize dynamic query
	SET DYN_QUERY = CONCAT(DYN_QUERY, CLAUSE_LIST, ' WHERE ENTITY_ID = ', AV_ENTITY_ID, ';');

	SET @dyn_sql = DYN_QUERY;

    -- Prepare and execute
    PREPARE stmt FROM @dyn_sql;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
END
//
