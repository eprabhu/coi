DELIMITER //
CREATE PROCEDURE `EVALUATE_FORM_RESPONSE`(
AV_MODULE_CODE           VARCHAR(200),
AV_SUBMODULE_CODE        VARCHAR(200),
AV_MODULE_ITEM_KEY       VARCHAR(200),
AV_SUB_MODULE_ITEM_KEY   VARCHAR(20)
)
BEGIN

DECLARE LS_ANSWER VARCHAR(3) DEFAULT NULL;

SELECT FQA.ANSWER INTO LS_ANSWER
FROM FB_QUEST_ANSWER FQA 
INNER JOIN QUEST_QUESTION QQ ON FQA.QUESTION_ID = QQ.QUESTION_ID 
WHERE QQ.QUESTION = 'HAS THIS ENTITY REIMBURSED YOU DIRECTLY FOR ANY DOMESTIC OR FOREIGN TRAVEL?' 
AND
FQA.QUESTIONNAIRE_ANS_HEADER_ID in (SELECT FQAH.QUESTIONNAIRE_ANS_HEADER_ID FROM FB_QUEST_ANSWER_HEADER FQAH WHERE 
FQAH.MODULE_ITEM_CODE = AV_MODULE_CODE
AND FQAH.MODULE_SUB_ITEM_CODE = AV_SUBMODULE_CODE
AND FQAH.MODULE_ITEM_KEY = AV_MODULE_ITEM_KEY)
ORDER BY FQA.UPDATE_TIMESTAMP DESC LIMIT 1;


IF LS_ANSWER = 'Yes' THEN
    SELECT '{"IS_TRAVEL_DISCLOSURE_REQUIRED": true}' AS RESULT;
ELSE
    SELECT '{"IS_TRAVEL_DISCLOSURE_REQUIRED": false}' AS RESULT;
END IF;

END
//
