DELIMITER //
CREATE PROCEDURE `GENERATE_ATTACHMENT_NUMBER`(
    IN AV_ATTACHMENT_COUNTER_NAME VARCHAR(255)
)
BEGIN
    DECLARE LI_LOCK_ACQUIRED INT DEFAULT 0;
    DECLARE LI_NEXT_VALUE INT DEFAULT NULL;

    START TRANSACTION;

    SELECT GET_LOCK('LOCK_ON_ATTACHMENT_NUMBER_COUNTER', 30) INTO LI_LOCK_ACQUIRED;

    IF LI_LOCK_ACQUIRED = 1 THEN
        -- Ensure the row exists, otherwise this returns NULL
        SELECT COUNTER_VALUE 
        INTO LI_NEXT_VALUE 
        FROM ATTACHMENT_NUMBER_COUNTER 
        WHERE COUNTER_NAME = AV_ATTACHMENT_COUNTER_NAME 
        FOR UPDATE;

        -- Only update if row was found
        IF LI_NEXT_VALUE IS NOT NULL THEN
            UPDATE ATTACHMENT_NUMBER_COUNTER 
            SET COUNTER_VALUE = COUNTER_VALUE + 1 
            WHERE COUNTER_NAME = AV_ATTACHMENT_COUNTER_NAME;

            COMMIT;
        ELSE
            -- No matching row found
            ROLLBACK;
        END IF;

        DO RELEASE_LOCK('LOCK_ON_ATTACHMENT_NUMBER_COUNTER');
    ELSE
        ROLLBACK;
    END IF;

    SELECT LI_NEXT_VALUE;
END
//
