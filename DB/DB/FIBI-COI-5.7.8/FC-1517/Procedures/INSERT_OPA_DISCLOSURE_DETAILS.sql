DELIMITER //
CREATE PROCEDURE `INSERT_OPA_DISCLOSURE_DETAILS`(
AV_PERSON_ID                     	VARCHAR(40),
AV_HOME_UNIT         				VARCHAR(8),
AV_LOGGEDIN_USER					VARCHAR(60)
)
BEGIN
DECLARE LS_OPA_DISCLOSURE_NUMBER VARCHAR(20);
DECLARE LI_OPA_CYCLE_NUMBER int(11);
DECLARE LS_PERSON_NAME VARCHAR(90);
DECLARE LS_STATUS_FLAG VARCHAR(1);
DECLARE LS_IS_FACULTY VARCHAR(1);
DECLARE LS_IS_FALL_SABATICAL VARCHAR(1);
DECLARE LS_IS_SPRING_SABATICAL VARCHAR(1);
DECLARE LS_RECEIVED_SUMMER_COMP VARCHAR(1);
DECLARE LS_SUMMER_COMP_MONTHS decimal(5,2);
DECLARE LS_IS_FULL_TIME VARCHAR(1);
DECLARE LS_IS_PART_TIME VARCHAR(1);
DECLARE LS_APPOINTMENT_PERCENT decimal(5,2);
DECLARE LS_IS_COMPENSATED VARCHAR(1);
DECLARE LS_HAS_POTENTIAL_CONFLICT VARCHAR(1);
DECLARE LS_CONFLICT_DESCRIPTION VARCHAR(4000);
DECLARE LS_CREATE_TIMESTAMP DATETIME;
DECLARE LS_CREATE_USER VARCHAR(60);
DECLARE LS_SUBMISSION_TIMESTAMP DATETIME;
DECLARE LS_UPDATE_TIMESTAMP DATETIME;
DECLARE LS_UPDATE_USER VARCHAR(60);
DECLARE LI_OPA_DISCLOSURE_ID int(11);
DECLARE LS_PREFIX VARCHAR(60);
DECLARE LS_OPA_REVIEW_STATUS_CODE VARCHAR(1); 
DECLARE LS_DISPOSITION_STATUS_CODE VARCHAR(1);
DECLARE LS_VERSION_STATUS VARCHAR(45);
DECLARE LS_VERSION_NUMBER INT;

SET LS_PREFIX ='';
SET LS_OPA_REVIEW_STATUS_CODE = '1';
SET LS_DISPOSITION_STATUS_CODE = '1';
SET LS_VERSION_STATUS = 'PENDING';
SET LS_VERSION_NUMBER = 1;

SELECT PERSON_NAME, IS_FACULTY INTO LS_PERSON_NAME, LS_IS_FACULTY FROM OPA_PERSON WHERE PERSON_ID = AV_PERSON_ID;

CALL GENERATE_OPA_DISCLOSURE_NUMBER(LS_OPA_DISCLOSURE_NUMBER);

SELECT MAX(OPA_CYCLE_NUMBER) INTO LI_OPA_CYCLE_NUMBER FROM OPA_CYCLES;

INSERT INTO OPA_DISCLOSURE(OPA_DISCLOSURE_NUMBER, OPA_CYCLE_NUMBER, PERSON_ID, PERSON_NAME, HOME_UNIT, IS_FACULTY, CREATE_USER, CREATE_TIMESTAMP, UPDATED_BY, UPDATE_TIMESTAMP, REVIEW_STATUS_CODE, DISPOSITION_STATUS_CODE, VERSION_STATUS, VERSION_NUMBER) 
VALUES 
(CONCAT(LS_PREFIX, LS_OPA_DISCLOSURE_NUMBER), LI_OPA_CYCLE_NUMBER, AV_PERSON_ID, LS_PERSON_NAME, AV_HOME_UNIT, LS_IS_FACULTY, AV_LOGGEDIN_USER, UTC_TIMESTAMP(), AV_PERSON_ID, UTC_TIMESTAMP(), LS_OPA_REVIEW_STATUS_CODE, LS_DISPOSITION_STATUS_CODE, LS_VERSION_STATUS, LS_VERSION_NUMBER);

SELECT LAST_INSERT_ID() INTO LI_OPA_DISCLOSURE_ID;

INSERT INTO OPA_DISCL_PERSON_SNAP (OPA_DISCLOSURE_ID, PERSON_ID, JOB_TITLE, HR_ORG_UNIT_ID, HR_DEPARTMENT_NAME, ADMIN_EMPLOYEE_TYPE, ADMIN_ORG_UNIT_TITLE, ADMIN_POSITION_TITLE, EMPLOYMENT_PERCENT, IS_CONSULT_PRIV, IS_PAID_APPT, IS_SUMMER_SESSION_APPT, OPA_REQUIREMENT_REASON, IS_RULE_BASED, SABBATICAL_BEGIN_DATE, SABBATICAL_END_DATE, CREATE_TIMESTAMP, UPDATE_TIMESTAMP)
SELECT LI_OPA_DISCLOSURE_ID, PERSON_ID, JOB_TITLE, HR_ORG_UNIT_ID, HR_DEPARTMENT_NAME, ADMIN_EMPLOYEE_TYPE, ADMIN_ORG_UNIT_TITLE, ADMIN_POSITION_TITLE, EMPLOYMENT_PERCENT, IS_CONSULT_PRIV, IS_PAID_APPT, IS_SUMMER_SESSION_APPT, REQUIREMENT_REASON, IS_RULE_BASED, SABBATICAL_BEGIN_DATE, SABBATICAL_END_DATE, UTC_TIMESTAMP(), UTC_TIMESTAMP()
FROM OPA_PERSON WHERE PERSON_ID = AV_PERSON_ID;

SELECT LI_OPA_DISCLOSURE_ID, LS_OPA_DISCLOSURE_NUMBER;

END
//
