create or replace FUNCTION FIBI_COI_DEV_PER_IS_CERT_REQ (
  AV_PROPOSAL_NUMBER IN EPS_PROP_PERSON.PROPOSAL_NUMBER%TYPE,
  AV_PERSON_ID IN EPS_PROP_PERSON.PERSON_ID%TYPE,
  AV_PROP_PERSON_ROLE_ID IN EPS_PROP_PERSON.PROP_PERSON_ROLE_ID%TYPE,
  AV_PERSON_PROJ_ROLE IN EPS_PROP_PERSON.PROJECT_ROLE%TYPE
) RETURN NUMBER
IS
  
  IS_CERTIFICATION_REQUIRED NUMBER := 0;
  LI_COUNT NUMBER;
  
  
BEGIN


	IF AV_PROP_PERSON_ROLE_ID IN ('PI', 'COI', 'MPI') THEN
	
		RETURN 1;
	
	END IF;
	

	IF AV_PROP_PERSON_ROLE_ID = 'KP' AND AV_PERSON_PROJ_ROLE IN  ('Other Significant Contributor','Subaward Investigator','Consultant') THEN
	
		RETURN 0;
	
	END IF;




	WITH GET_SPONSORS_FROM_HIERARCHY AS (
	SELECT SPONSOR_CODE 
	FROM SPONSOR_HIERARCHY
	WHERE HIERARCHY_NAME = 'COI Disclosures' 
	AND LEVEL1 = 'COI Disclosures with KP Req'
	)
	SELECT COUNT(PROPOSAL_NUMBER) INTO LI_COUNT
	FROM EPS_PROPOSAL 
	WHERE PROPOSAL_NUMBER = AV_PROPOSAL_NUMBER
	AND (SPONSOR_CODE IN (SELECT SPONSOR_CODE FROM GET_SPONSORS_FROM_HIERARCHY) 
			OR 
		PRIME_SPONSOR_CODE IN (SELECT SPONSOR_CODE FROM GET_SPONSORS_FROM_HIERARCHY)
		);


	IF LI_COUNT = 1 THEN
	
		RETURN 1;
		
	END IF;	



	RETURN 0;
	

EXCEPTION
  WHEN OTHERS THEN    
    RETURN 0;
	
	
END FIBI_COI_DEV_PER_IS_CERT_REQ;