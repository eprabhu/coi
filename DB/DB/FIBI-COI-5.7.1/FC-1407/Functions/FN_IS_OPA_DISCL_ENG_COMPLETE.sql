DELIMITER //
CREATE FUNCTION `FN_IS_OPA_DISCL_ENG_COMPLETE`(
    AV_DISCLOSURE_ID INT) RETURNS TINYINT(1)
    READS SQL DATA
    DETERMINISTIC
BEGIN
    DECLARE LB_RESULT BOOLEAN DEFAULT FALSE;
    DECLARE LI_DONE INT DEFAULT FALSE;
    DECLARE LS_VERSION_STATUS VARCHAR(20);
    DECLARE LS_RELATIONSHIPS TEXT;
    DECLARE LS_IS_FORM_COMPLETED VARCHAR(10);
    
    DECLARE CUR CURSOR FOR
        SELECT 
            PE.VERSION_STATUS,
            A.RELATIONSHIPS,
            PE.IS_FORM_COMPLETED
        FROM 
            OPA_DISCL_PERSON_ENTITY_REL A
        LEFT JOIN 
            PERSON_ENTITY PE ON A.PERSON_ENTITY_ID = PE.PERSON_ENTITY_ID
        WHERE 
            A.DISCLOSURE_ID = AV_DISCLOSURE_ID;
    
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET LI_DONE = TRUE;
    
    OPEN CUR;
    
    READ_LOOP: LOOP
        FETCH CUR INTO LS_VERSION_STATUS, LS_RELATIONSHIPS, LS_IS_FORM_COMPLETED;
        IF LI_DONE THEN
            LEAVE READ_LOOP;
        END IF;
        
        IF LS_VERSION_STATUS = 'ACTIVE' 
           AND LS_RELATIONSHIPS LIKE '%COMMITMENT%' 
           AND LS_IS_FORM_COMPLETED = 'N' THEN
            -- If any relevant engagement is not completed, return FALSE immediately
            CLOSE CUR;
            RETURN FALSE;
        END IF;
    END LOOP;
    
    CLOSE CUR;
    
    -- If all relevant engagements were completed, return TRUE
    RETURN TRUE;
END
//
