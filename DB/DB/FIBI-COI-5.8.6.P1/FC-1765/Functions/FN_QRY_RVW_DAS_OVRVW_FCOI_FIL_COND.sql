DELIMITER //
CREATE FUNCTION FN_QRY_RVW_DAS_OVRVW_FCOI_FIL_COND(
    AV_PERSON_ID VARCHAR(40),
    JSON_INPUT JSON
)
RETURNS TEXT
DETERMINISTIC
BEGIN
        DECLARE LS_FILTER_CONDITION LONGTEXT DEFAULT '';

        -- Declare all expected JSON fields
        DECLARE AV_DISCLOSURE_NUMBER            VARCHAR(100);
        DECLARE AV_DISCLOSURE_PERSON            VARCHAR(100);
        DECLARE AV_HOME_UNIT                    VARCHAR(500);
        DECLARE AV_CONFLICT_STATUS_CODE         VARCHAR(100);
        DECLARE AV_DISPOSITION_STATUS_CODE      VARCHAR(100);
        DECLARE AV_REVIEW_STATUS_CODE           VARCHAR(100);
        DECLARE AV_DISCLOSURE_CATEOGORY_TYPE    VARCHAR(100);
        DECLARE AV_START_DATE                   VARCHAR(20);
        DECLARE AV_EXPIRATION_DATE                     VARCHAR(20);
        DECLARE AV_CERTIFICATION_DATE           VARCHAR(20);
        DECLARE AV_HAS_SFI_FLAG                 VARCHAR(5);
        DECLARE AV_ADMINISTRATOR                VARCHAR(200);
        DECLARE AV_FREE_TEXT_SEARCH_FIELDS      VARCHAR(200);
        DECLARE AV_TAB_TYPE                     VARCHAR(200);
        DECLARE AV_FETCH_TYPE                   VARCHAR(20);
        DECLARE AV_INCLUDE_CHILD_UNITS          BOOLEAN;
        DECLARE AV_PROJECT_TITLE                VARCHAR(300);
        DECLARE AV_PROJECT_NUMBER               VARCHAR(100);

        -- Extract from JSON input
        SET AV_DISCLOSURE_NUMBER =          JSON_UNQUOTE(JSON_EXTRACT(JSON_INPUT, '$.DISCLOSURE_NUMBER'));
        SET AV_DISCLOSURE_PERSON =          JSON_UNQUOTE(JSON_EXTRACT(JSON_INPUT, '$.PERSON'));
        SET AV_HOME_UNIT =                  JSON_UNQUOTE(JSON_EXTRACT(JSON_INPUT, '$.HOME_UNIT'));
        SET AV_CONFLICT_STATUS_CODE =       JSON_UNQUOTE(JSON_EXTRACT(JSON_INPUT, '$.CONFLICT_STATUS_CODE'));
        SET AV_DISPOSITION_STATUS_CODE =    JSON_UNQUOTE(JSON_EXTRACT(JSON_INPUT, '$.DISPOSITION_STATUS_CODE'));
        SET AV_REVIEW_STATUS_CODE =         JSON_UNQUOTE(JSON_EXTRACT(JSON_INPUT, '$.REVIEW_STATUS_CODE'));
        SET AV_DISCLOSURE_CATEOGORY_TYPE =  JSON_UNQUOTE(JSON_EXTRACT(JSON_INPUT, '$.DISCLOSURE_CATEGORY_TYPE'));
        SET AV_START_DATE =                 JSON_UNQUOTE(JSON_EXTRACT(JSON_INPUT, '$.START_DATE'));
        SET AV_EXPIRATION_DATE =            JSON_UNQUOTE(JSON_EXTRACT(JSON_INPUT, '$.EXPIRATION_DATE'));
        SET AV_CERTIFICATION_DATE =         JSON_UNQUOTE(JSON_EXTRACT(JSON_INPUT, '$.CERTIFIED_AT'));
        SET AV_HAS_SFI_FLAG =               JSON_UNQUOTE(JSON_EXTRACT(JSON_INPUT, '$.HAS_SFI_FLAG'));
        SET AV_ADMINISTRATOR =              JSON_UNQUOTE(JSON_EXTRACT(JSON_INPUT, '$.ADMINISTRATOR'));
        SET AV_FREE_TEXT_SEARCH_FIELDS =    JSON_UNQUOTE(JSON_EXTRACT(JSON_INPUT, '$.SEARCH_KEYWORD'));
        SET AV_TAB_TYPE =                   JSON_UNQUOTE(JSON_EXTRACT(JSON_INPUT, '$.TAB_TYPE'));
        SET AV_FETCH_TYPE =                 JSON_UNQUOTE(JSON_EXTRACT(JSON_INPUT, '$.FETCH_TYPE'));
        SET AV_INCLUDE_CHILD_UNITS =        JSON_EXTRACT(JSON_INPUT, '$.INCLUDE_CHILD_UNITS');
        SET AV_PROJECT_TITLE =              JSON_UNQUOTE(JSON_EXTRACT(JSON_INPUT, '$.PROJECT_TITLE'));
        SET AV_PROJECT_NUMBER =             JSON_UNQUOTE(JSON_EXTRACT(JSON_INPUT, '$.PROJECT_NUMBER'));

        IF AV_FETCH_TYPE = 'HEADER' THEN
            SET AV_TAB_TYPE = null;
        END IF;

        IF AV_TAB_TYPE IS NOT NULL AND AV_TAB_TYPE <> '' AND AV_TAB_TYPE <> 'ALL_DISCLOSURES' THEN
            SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION, ' (');

            -- REVIEW_PENDING
            IF FIND_IN_SET('REVIEW_PENDING', AV_TAB_TYPE) > 0 THEN
                SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,
                    ' T1.REVIEW_STATUS_CODE IN (2,3,7,8,9) ');
            END IF;

            -- EXPIRING
            IF FIND_IN_SET('EXPIRING', AV_TAB_TYPE) > 0 THEN
                IF RIGHT(LS_FILTER_CONDITION, 2) <> ' (' THEN
                    SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION, ' OR ');
                END IF;
                SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,
                    ' T1.EXPIRATION_DATE BETWEEN CURRENT_DATE() AND DATE_ADD(CURRENT_DATE(), INTERVAL 30 DAY) ');
            END IF;

            -- EXPIRED
            IF FIND_IN_SET('EXPIRED', AV_TAB_TYPE) > 0 THEN
                IF RIGHT(LS_FILTER_CONDITION, 2) <> ' (' THEN
                    SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION, ' OR ');
                END IF;
                SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,
                    ' T1.DISPOSITION_STATUS_CODE = 4 AND T1.EXPIRATION_DATE < CURRENT_DATE() ');
            END IF;

            IF FIND_IN_SET('APPROVED', AV_TAB_TYPE) > 0 THEN
                IF RIGHT(LS_FILTER_CONDITION, 2) <> ' (' THEN
                    SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION, ' OR ');
                END IF;
                SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,
                    ' T1.DISPOSITION_STATUS_CODE = 3 ');
            END IF;

            IF FIND_IN_SET('MY_REVIEWS_PENDING', AV_TAB_TYPE) > 0 THEN
                IF RIGHT(LS_FILTER_CONDITION, 2) <> ' (' THEN
                    SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION, ' OR ');
                END IF;
                SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,
                    ' T1.REVIEW_STATUS_CODE IN (3,7,8,9) AND ((T34.ASSIGNEE_PERSON_ID = ''', AV_PERSON_ID ,''' AND T34.REVIEW_STATUS_TYPE_CODE IN (1,2))
                     OR T1.ADMIN_PERSON_ID = ''', AV_PERSON_ID ,'''
                     OR exists  (SELECT 1 FROM WORKFLOW WF
                           INNER JOIN WORKFLOW_DETAIL WFD ON WF.WORKFLOW_ID = WFD.WORKFLOW_ID
                           WHERE WF.MODULE_ITEM_ID = T1.DISCLOSURE_ID
                           AND WFD.APPROVER_PERSON_ID = ''',AV_PERSON_ID,'''
                           AND WF.MODULE_CODE = 8 AND WF.IS_WORKFLOW_ACTIVE = ''Y''
                           AND WFD.APPROVAL_STATUS = ''W'' )
                     )');
            END IF;

            IF FIND_IN_SET('WITHOUT_ENGAGEMENTS', AV_TAB_TYPE) > 0 THEN
                IF RIGHT(LS_FILTER_CONDITION, 2) <> ' (' THEN
                    SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION, ' OR ');
                END IF;
                SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,
                    ' T1.CONFLICT_STATUS_CODE = 4 ');
            END IF;

            IF FIND_IN_SET('HAS_ENGAGEMENTS', AV_TAB_TYPE) > 0 THEN
                IF RIGHT(LS_FILTER_CONDITION, 2) <> ' (' THEN
                    SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION, ' OR ');
                END IF;
                SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,
                    ' T1.CONFLICT_STATUS_CODE != 4 ');
            END IF;

            IF FIND_IN_SET('FOREIGN_ENGAGEMENTS', AV_TAB_TYPE) > 0 THEN
                IF RIGHT(LS_FILTER_CONDITION, 2) <> ' (' THEN
                    SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION, ' OR ');
                END IF;
                SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,
                    ' T1.CONFLICT_STATUS_CODE != 4 AND T17.NO_OF_FOREIGN_ENTITIES IS NOT NULL AND T17.NO_OF_FOREIGN_ENTITIES > 0 ');
            END IF;

            IF FIND_IN_SET('FACULTY', AV_TAB_TYPE) > 0 THEN
                IF RIGHT(LS_FILTER_CONDITION, 2) <> ' (' THEN
                    SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION, ' OR ');
                END IF;
                SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,
                    ' T7.IS_FACULTY = ''Y'' ');
            END IF;

            SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION, ') AND ');
        END IF;


        IF AV_DISCLOSURE_NUMBER IS NOT NULL AND AV_DISCLOSURE_NUMBER <> '' THEN
            SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' T1.DISCLOSURE_NUMBER = ''',AV_DISCLOSURE_NUMBER,''' AND ');
        END IF;

        IF AV_DISCLOSURE_PERSON IS NOT NULL AND AV_DISCLOSURE_PERSON <> '' THEN
            IF FIND_IN_SET('PERSON', AV_FREE_TEXT_SEARCH_FIELDS) > 0 THEN
                IF INSTR(AV_DISCLOSURE_PERSON, '*') > 0 THEN
                    SET AV_DISCLOSURE_PERSON = REPLACE(AV_DISCLOSURE_PERSON, '*', '%');
                ELSE
                    SET AV_DISCLOSURE_PERSON = CONCAT('%', AV_DISCLOSURE_PERSON, '%');
                END IF;
                SET LS_FILTER_CONDITION = CONCAT(
                    LS_FILTER_CONDITION,
                    ' (T7.FULL_NAME LIKE ''', AV_DISCLOSURE_PERSON,
                    ''' OR T1.PERSON_ID LIKE ''', AV_DISCLOSURE_PERSON, ''') AND '
                );
            ELSE
                SET LS_FILTER_CONDITION = CONCAT(
                    LS_FILTER_CONDITION,
                    ' T1.PERSON_ID = ''', AV_DISCLOSURE_PERSON, ''' AND '
                );
            END IF;
        END IF;

        IF AV_HOME_UNIT IS NOT NULL AND AV_HOME_UNIT <> '' AND AV_HOME_UNIT <> 'ALL' AND (AV_INCLUDE_CHILD_UNITS IS NULL OR AV_INCLUDE_CHILD_UNITS = FALSE)THEN
            SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' T1.HOME_UNIT = ''',AV_HOME_UNIT,''' AND ');
        ELSEIF AV_INCLUDE_CHILD_UNITS = TRUE THEN
            SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' T1.HOME_UNIT IN (SELECT CHILD_UNIT_NUMBER FROM UNIT_WITH_CHILDREN WHERE UNIT_NUMBER =''',AV_HOME_UNIT,''') AND ');
        END IF;

        IF AV_CONFLICT_STATUS_CODE IS NOT NULL  AND AV_CONFLICT_STATUS_CODE <> '' THEN
            SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' T1.CONFLICT_STATUS_CODE IN (',AV_CONFLICT_STATUS_CODE,') AND ');
        END IF;

        IF AV_DISPOSITION_STATUS_CODE IS NOT NULL  AND AV_DISPOSITION_STATUS_CODE <> '' THEN
            SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' T1.DISPOSITION_STATUS_CODE IN (',AV_DISPOSITION_STATUS_CODE,') AND ');
        ELSE
            SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' T1.DISPOSITION_STATUS_CODE != ''2'' AND ');
        END IF;

        IF AV_REVIEW_STATUS_CODE IS NOT NULL  AND AV_REVIEW_STATUS_CODE <> '' THEN
            SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' T1.REVIEW_STATUS_CODE IN (',AV_REVIEW_STATUS_CODE,') AND ');
        END IF;

        IF AV_DISCLOSURE_CATEOGORY_TYPE IS NOT NULL  AND AV_DISCLOSURE_CATEOGORY_TYPE <> '' THEN
            SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' T1.FCOI_TYPE_CODE IN (',AV_DISCLOSURE_CATEOGORY_TYPE,') AND ');
        END IF;

         IF AV_START_DATE IS NOT NULL AND AV_START_DATE <> '' THEN
             SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' DATE(T1.CREATE_TIMESTAMP) > ''', STR_TO_DATE(AV_START_DATE,'%Y-%m-%d'),''' AND ');
         END IF;

         IF AV_EXPIRATION_DATE IS NOT NULL AND AV_EXPIRATION_DATE <> '' THEN
             SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' DATE(T1.EXPIRATION_DATE) = ''', STR_TO_DATE(AV_EXPIRATION_DATE,'%Y-%m-%d'),''' AND ');
         END IF;

        IF AV_CERTIFICATION_DATE IS NOT NULL AND AV_CERTIFICATION_DATE <> '' THEN
            SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' DATE(T1.CERTIFIED_AT) = ''', STR_TO_DATE(AV_CERTIFICATION_DATE,'%Y-%m-%d'),''' AND ');
        END IF;

        IF AV_HAS_SFI_FLAG IS NOT NULL AND AV_HAS_SFI_FLAG <> '' THEN
            SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' T1.HAS_SFI_FLAG = ''', AV_HAS_SFI_FLAG, ''' AND ');
        END IF;

        IF AV_ADMINISTRATOR IS NOT NULL AND AV_ADMINISTRATOR <> '' THEN
                SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' T1.ADMIN_PERSON_ID IN (''',
                REPLACE(AV_ADMINISTRATOR, ',', ''','''),''') AND ');
        END IF;

        IF AV_PROJECT_TITLE is NOT NULL AND AV_PROJECT_TITLE <> '' THEN
            IF FIND_IN_SET('PROJECT_TITLE', AV_FREE_TEXT_SEARCH_FIELDS) > 0 THEN
                IF INSTR(AV_PROJECT_TITLE, '*') > 0 THEN
                    SET AV_PROJECT_TITLE = REPLACE(AV_PROJECT_TITLE, '*', '%');
                ELSE
                    SET AV_PROJECT_TITLE = CONCAT('%', AV_PROJECT_TITLE, '%');
                END IF;
                SET LS_FILTER_CONDITION = CONCAT(
                    LS_FILTER_CONDITION,
                    ' (T14.TITLE LIKE ''', AV_PROJECT_TITLE,
                        ''' OR T21.TITLE LIKE ''', AV_PROJECT_TITLE,
                        ''' OR T15.TITLE LIKE ''', AV_PROJECT_TITLE,
                    ''') AND '
                );
            ELSE
                SET AV_PROJECT_TITLE = CONCAT('%', AV_PROJECT_TITLE, '%');
                SET LS_FILTER_CONDITION = CONCAT(
                    LS_FILTER_CONDITION,
                    ' (T14.TITLE LIKE ''', AV_PROJECT_TITLE,
                        ''' OR T21.TITLE LIKE ''', AV_PROJECT_TITLE,
                        ''' OR T15.TITLE LIKE ''', AV_PROJECT_TITLE,
                    ''') AND '
                );
            END IF;
        END IF;

        IF AV_PROJECT_NUMBER is NOT NULL AND AV_PROJECT_NUMBER <> '' THEN
            IF FIND_IN_SET('PROJECT_NUMBER', AV_FREE_TEXT_SEARCH_FIELDS) > 0 THEN
                IF INSTR(AV_PROJECT_NUMBER, '*') > 0 THEN
                    SET AV_PROJECT_NUMBER = REPLACE(AV_PROJECT_NUMBER, '*', '%');
                ELSE
                    SET AV_PROJECT_NUMBER = CONCAT('%', AV_PROJECT_NUMBER, '%');
                END IF;
                SET LS_FILTER_CONDITION = CONCAT(
                    LS_FILTER_CONDITION,
                    ' (T14.PROJECT_NUMBER LIKE ''', AV_PROJECT_NUMBER,
                        ''' OR T21.PROJECT_NUMBER LIKE ''', AV_PROJECT_NUMBER,
                        ''' OR T15.PROJECT_NUMBER LIKE ''', AV_PROJECT_NUMBER,
                    ''') AND '
                );
            ELSE
                SET AV_PROJECT_NUMBER = CONCAT('%', AV_PROJECT_NUMBER, '%');
                SET LS_FILTER_CONDITION = CONCAT(
                    LS_FILTER_CONDITION,
                    ' (T14.PROJECT_NUMBER LIKE ''', AV_PROJECT_NUMBER,
                        ''' OR T21.PROJECT_NUMBER LIKE ''', AV_PROJECT_NUMBER,
                        ''' OR T15.PROJECT_NUMBER LIKE ''', AV_PROJECT_NUMBER,
                    ''') AND '
                );
            END IF;
        END IF;

        IF RIGHT(LS_FILTER_CONDITION, 4) = 'AND ' THEN
            SET LS_FILTER_CONDITION = LEFT(LS_FILTER_CONDITION, LENGTH(LS_FILTER_CONDITION) - 4);
        END IF;

        RETURN LS_FILTER_CONDITION;
END
//
