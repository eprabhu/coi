DELIMITER //
CREATE FUNCTION FN_CHK_ACTV_SFI_NOT_SYNC(
    AV_DISCLOSURE_ID INT, 
	AV_PERSON_ID VARCHAR(45)
) RETURNS varchar(6) 
    DETERMINISTIC
BEGIN
	DECLARE LI_SFI_FLAG INT DEFAULT 0;
     SELECT COUNT(T2.PERSON_ENTITY_ID)  INTO LI_SFI_FLAG
  			FROM COI_DISCL_PROJECT_ENTITY_REL T1
  			INNER JOIN COI_DISCL_PROJECTS T4 ON T4.COI_DISCL_PROJECTS_ID = T1.COI_DISCL_PROJECTS_ID
             INNER JOIN COI_DISCLOSURE T0 ON T0.DISCLOSURE_ID = T4.DISCLOSURE_ID
             RIGHT JOIN (SELECT t1.PERSON_ENTITY_ID, t1.PERSON_ENTITY_NUMBER, t1.ENTITY_ID, t1.ENTITY_NUMBER FROM PERSON_ENTITY t1
             INNER JOIN PERSON_ENTITY_RELATIONSHIP t2 ON t2.PERSON_ENTITY_ID = t1.PERSON_ENTITY_ID
             INNER JOIN VALID_PERSON_ENTITY_REL_TYPE t3 ON t3.VALID_PERS_ENTITY_REL_TYP_CODE = t2.VALID_PERS_ENTITY_REL_TYP_CODE
             WHERE t1.PERSON_ENTITY_NUMBER NOT IN (
  				SELECT DISTINCT t5.PERSON_ENTITY_NUMBER FROM COI_DISCL_PROJECT_ENTITY_REL t5
  				INNER JOIN COI_DISCL_PROJECTS t6 ON t6.COI_DISCL_PROJECTS_ID = t5.COI_DISCL_PROJECTS_ID
  				WHERE t6.DISCLOSURE_ID = AV_DISCLOSURE_ID AND t5.PERSON_ENTITY_NUMBER IS NOT NULL)
             AND t1.VERSION_STATUS='ACTIVE' AND t3.DISCLOSURE_TYPE_CODE = '1' AND t1.PERSON_ID = AV_PERSON_ID) T2
             ON (T1.PERSON_ENTITY_NUMBER IS NULL OR T1.PERSON_ENTITY_NUMBER != T2.PERSON_ENTITY_NUMBER)
             INNER JOIN ENTITY T3 ON T3.ENTITY_ID = T2.ENTITY_ID
             WHERE T4.DISCLOSURE_ID = AV_DISCLOSURE_ID AND T0.REVIEW_STATUS_CODE IN (1,5,6) ;
			 
	  IF LI_SFI_FLAG > 0 THEN 
	  RETURN 'TRUE';
	  END IF;
    RETURN 'FALSE';
END;
//
