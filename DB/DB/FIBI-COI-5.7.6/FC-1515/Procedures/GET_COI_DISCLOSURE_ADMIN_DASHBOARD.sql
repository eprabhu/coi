DELIMITER //
CREATE PROCEDURE `GET_COI_DISCLOSURE_ADMIN_DASHBOARD`(
    AV_DISCLOSURE_NUMBER                VARCHAR(20),
    AV_DISCLOSURE_PERSON_ID         VARCHAR(40),
    AV_HOME_UNIT                    VARCHAR(8),
    AV_CONFLICT_STATUS_CODE       VARCHAR(30),
    AV_DISCLOSURE_CATEOGORY_TYPE    VARCHAR(30),
    AV_START_DATE                   VARCHAR(30),
    AV_END_DATE                     VARCHAR(30),
    AV_ENTITY_NAME                  VARCHAR(90),
    AV_ENTITY_COUNTRY               VARCHAR(3),
    AV_ADMINISTRATOR                 VARCHAR(200),
	AV_PROJECT_TITLE                VARCHAR(1000),
    AV_PROJECT_NUMBER			    VARCHAR(20),
    AV_PERSON_ID                    VARCHAR(200),
    AV_SORT_TYPE                    VARCHAR(500),
    AV_PAGED                        INT(10),
    AV_LIMIT                        INT(10),
    AV_TAB_TYPE                     VARCHAR(30),
    AV_UNLIMITED                    BOOLEAN,
    AV_TYPE                         VARCHAR(1),
    AV_PROJECT_TYPE                 VARCHAR(3),
    AV_HAS_SFI_FLAG   				VARCHAR(3),
    AV_DISPOSITION_STATUS_CODE      VARCHAR(30),
    AV_REVIEW_STATUS_CODE       	VARCHAR(30),
    AV_CERTIFICATION_DATE           VARCHAR(30),
    AV_IS_COUNT                     BOOLEAN,
    AV_FILTER_TYPE					VARCHAR(90)
)
BEGIN
        DECLARE LS_DYN_SQL LONGTEXT;
        DECLARE LS_FILTER_CONDITION LONGTEXT;
        DECLARE LS_OFFSET_CONDITION VARCHAR(600);
        DECLARE LS_OFFSET INT(11);
        DECLARE TAB_QUERY LONGTEXT;
        DECLARE JOIN_CONDITION LONGTEXT;
        DECLARE SELECTED_FIELD_LIST LONGTEXT;
        DECLARE LS_ADMIN_GROUP_FCOI_CONDITION LONGTEXT;
        DECLARE LS_ADMIN_GROUP_PROJECT_CONDITION LONGTEXT;
		DECLARE LS_PROP_PROJECT_FILTER_CONDITION LONGTEXT;
        DECLARE LS_AWARD_PROJECT_FILTER_CONDITION LONGTEXT;
        DECLARE LS_IP_PROJECT_FILTER_CONDITION LONGTEXT;

        SET LS_OFFSET = (AV_LIMIT * AV_PAGED);
        SET LS_FILTER_CONDITION ='';
        SET LS_DYN_SQL ='';
        SET JOIN_CONDITION = '';
        SET SELECTED_FIELD_LIST= '';
        SET TAB_QUERY = '';
        SET LS_ADMIN_GROUP_FCOI_CONDITION = '';
        SET LS_ADMIN_GROUP_PROJECT_CONDITION = '';


        SET JOIN_CONDITION =  CONCAT(JOIN_CONDITION,' LEFT JOIN (SELECT IFNULL(COUNT(DISTINCT T1.PERSON_ENTITY_ID),0) AS NO_OF_SFI,T1.DISCLOSURE_ID
        											FROM COI_DISCL_PERSON_ENTITY_REL T1
        											GROUP BY T1.DISCLOSURE_ID) T17 ON T17.DISCLOSURE_ID = T1.DISCLOSURE_ID
                                                LEFT JOIN (SELECT IFNULL(COUNT(DISTINCT T1.MODULE_ITEM_KEY),0) AS NO_OF_PROPOSAL,T1.DISCLOSURE_ID,
        											T2.DESCRIPTION AS COI_PROJECT_TYPE
        											FROM COI_DISCL_PROJECTS T1
        											INNER JOIN COI_PROJECT_TYPE T2 ON T2.COI_PROJECT_TYPE_CODE = 3
        											WHERE T1.MODULE_CODE = 3 GROUP BY T1.DISCLOSURE_ID) T18 ON T18.DISCLOSURE_ID = T1.DISCLOSURE_ID
        											AND T1.FCOI_TYPE_CODE != 2
                                                LEFT JOIN (SELECT IFNULL(COUNT(DISTINCT T1.MODULE_ITEM_KEY),0) AS NO_OF_AWARD,T1.DISCLOSURE_ID,
        											T2.DESCRIPTION AS COI_PROJECT_TYPE
        											FROM COI_DISCL_PROJECTS T1
        											INNER JOIN COI_PROJECT_TYPE T2 ON T2.COI_PROJECT_TYPE_CODE = 1
        											WHERE T1.MODULE_CODE = 1 GROUP BY T1.DISCLOSURE_ID) T19 ON T19.DISCLOSURE_ID = T1.DISCLOSURE_ID
        											AND T1.FCOI_TYPE_CODE != 2
        										LEFT JOIN (SELECT IFNULL(COUNT(DISTINCT T1.MODULE_ITEM_KEY),0) AS NO_OF_INSTITUTE_PROPOSALS,T1.DISCLOSURE_ID,
        											T2.DESCRIPTION AS COI_PROJECT_TYPE
        											FROM COI_DISCL_PROJECTS T1
        											INNER JOIN COI_PROJECT_TYPE T2 ON T2.COI_PROJECT_TYPE_CODE = 2
        											WHERE T1.MODULE_CODE = 2 GROUP BY T1.DISCLOSURE_ID) T20 ON T20.DISCLOSURE_ID = T1.DISCLOSURE_ID
        											AND T1.FCOI_TYPE_CODE != 2
        										LEFT JOIN COI_REVIEW T34 ON T34.DISCLOSURE_ID = T1.DISCLOSURE_ID
        										LEFT JOIN PERSON T33 ON T33.PERSON_ID = T34.ASSIGNEE_PERSON_ID
                                                LEFT JOIN coi_reviewer_status_type T35 ON T35.REVIEW_STATUS_CODE = T34.REVIEW_STATUS_TYPE_CODE
                                                LEFT JOIN coi_review_location_type T36 ON T36.LOCATION_TYPE_CODE = T34.LOCATION_TYPE_CODE');

        -- Temporary tables for right check for FCOI & project diclosure

        IF AV_TAB_TYPE = 'ALL_REVIEWS' THEN
        	SET LS_DYN_SQL = CONCAT('WITH ACCESS_TMP AS ( SELECT UNIT_NUMBER
							FROM PERSON_ROLES T1
							INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
							INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
							WHERE T1.DESCEND_FLAG = ''N'' AND T1.PERSON_ID = ''',AV_PERSON_ID,'''
							AND RIGHT_NAME IN (''VIEW_ADMIN_GROUP_COI'') 							
							UNION
							SELECT CHILD_UNIT_NUMBER FROM UNIT_WITH_CHILDREN 
							WHERE UNIT_NUMBER IN (
							SELECT UNIT_NUMBER
							FROM PERSON_ROLES T1
							INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
							INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
							WHERE T1.DESCEND_FLAG = ''Y'' AND T1.PERSON_ID = ''',AV_PERSON_ID,'''
							AND RIGHT_NAME IN (''VIEW_ADMIN_GROUP_COI'') 
                            )) ' );

        ELSEIF AV_TAB_TYPE = 'MY_REVIEWS'  THEN
        	SET LS_DYN_SQL = CONCAT('');

        ELSE

        	SET LS_DYN_SQL = CONCAT('WITH FCOI_ACCESS_TMP AS ( SELECT UNIT_NUMBER
        							FROM PERSON_ROLES T1
        							INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
        							INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID
        							WHERE T1.DESCEND_FLAG = ''N'' AND T1.PERSON_ID = ''',AV_PERSON_ID,'''
        							AND RIGHT_NAME IN (''MANAGE_FCOI_DISCLOSURE'', ''VIEW_FCOI_DISCLOSURE'')
        							UNION 
                                    SELECT UNIT_NUMBER
									FROM PERSON_ROLES T1
									INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
									INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
									WHERE T1.DESCEND_FLAG = ''N'' AND T1.PERSON_ID = ''',AV_PERSON_ID,'''
									AND RIGHT_NAME IN (''VIEW_ADMIN_GROUP_COI'') 							
									UNION
									SELECT CHILD_UNIT_NUMBER FROM UNIT_WITH_CHILDREN 
									WHERE UNIT_NUMBER IN (
									SELECT UNIT_NUMBER
									FROM PERSON_ROLES T1
									INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
									INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
									WHERE T1.DESCEND_FLAG = ''Y'' AND T1.PERSON_ID = ''',AV_PERSON_ID,'''
									AND RIGHT_NAME IN (''VIEW_ADMIN_GROUP_COI'') 
									)
        							UNION 
                                    SELECT CHILD_UNIT_NUMBER FROM UNIT_WITH_CHILDREN
        							WHERE UNIT_NUMBER IN ( SELECT UNIT_NUMBER
        							FROM PERSON_ROLES T1
        							INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
        							INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID
        							WHERE T1.DESCEND_FLAG = ''Y'' AND T1.PERSON_ID = ''',AV_PERSON_ID,'''
        							AND RIGHT_NAME IN (''MANAGE_FCOI_DISCLOSURE'', ''VIEW_FCOI_DISCLOSURE'')
                                    )),
        							PROJECT_ACCESS_TMP AS
        							( SELECT UNIT_NUMBER
        							FROM PERSON_ROLES T1
        							INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
        							INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID
        							WHERE T1.DESCEND_FLAG = ''N'' AND T1.PERSON_ID = ''',AV_PERSON_ID,'''
        							AND RIGHT_NAME IN (''MANAGE_PROJECT_DISCLOSURE'', ''VIEW_PROJECT_DISCLOSURE'')
        							UNION 
                                    SELECT UNIT_NUMBER
									FROM PERSON_ROLES T1
									INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
									INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
									WHERE T1.DESCEND_FLAG = ''N'' AND T1.PERSON_ID = ''',AV_PERSON_ID,'''
									AND RIGHT_NAME IN (''VIEW_ADMIN_GROUP_COI'') 							
									UNION
									SELECT CHILD_UNIT_NUMBER FROM UNIT_WITH_CHILDREN 
									WHERE UNIT_NUMBER IN (
									SELECT UNIT_NUMBER
									FROM PERSON_ROLES T1
									INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
									INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
									WHERE T1.DESCEND_FLAG = ''Y'' AND T1.PERSON_ID = ''',AV_PERSON_ID,'''
									AND RIGHT_NAME IN (''VIEW_ADMIN_GROUP_COI'') 
									)
        							UNION 
                                    SELECT CHILD_UNIT_NUMBER FROM UNIT_WITH_CHILDREN
        							WHERE UNIT_NUMBER IN (
        							SELECT UNIT_NUMBER
        							FROM PERSON_ROLES T1
        							INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
        							INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID
        							WHERE T1.DESCEND_FLAG = ''Y'' AND T1.PERSON_ID = ''',AV_PERSON_ID,'''
        							AND RIGHT_NAME IN (''MANAGE_PROJECT_DISCLOSURE'', ''VIEW_PROJECT_DISCLOSURE'')
                                    ))');
        END IF;

        IF AV_TAB_TYPE = 'ALL_DISCLOSURES' THEN

        				SET TAB_QUERY = CONCAT(TAB_QUERY,' AND T1.VERSION_STATUS != ''ARCHIVE''');

                        SET LS_ADMIN_GROUP_FCOI_CONDITION = CONCAT(' AND (T1.HOME_UNIT IN (SELECT DISTINCT UNIT_NUMBER FROM FCOI_ACCESS_TMP) OR ADMIN_PERSON_ID = ''', AV_PERSON_ID ,''') ');
        				SET LS_ADMIN_GROUP_PROJECT_CONDITION = CONCAT(' AND (T1.HOME_UNIT IN (SELECT DISTINCT UNIT_NUMBER FROM PROJECT_ACCESS_TMP) OR ADMIN_PERSON_ID = ''', AV_PERSON_ID ,''') ');

        ELSEIF AV_TAB_TYPE = 'NEW_SUBMISSIONS' THEN


        				SET TAB_QUERY = CONCAT(TAB_QUERY,' AND T1.VERSION_STATUS = ''PENDING'' AND T1.REVIEW_STATUS_CODE = 2 AND T1.CONFLICT_STATUS_CODE NOT IN (4,5,6)
        				AND T1.ADMIN_GROUP_ID IS NULL AND T1.ADMIN_PERSON_ID IS NULL ');

        				SET LS_ADMIN_GROUP_FCOI_CONDITION = CONCAT(' AND T1.HOME_UNIT IN (SELECT DISTINCT UNIT_NUMBER FROM FCOI_ACCESS_TMP) ');
        				SET LS_ADMIN_GROUP_PROJECT_CONDITION = CONCAT(' AND T1.HOME_UNIT IN (SELECT DISTINCT UNIT_NUMBER FROM PROJECT_ACCESS_TMP) ');

        ELSEIF AV_TAB_TYPE = 'NEW_SUBMISSIONS_WITHOUT_SFI' THEN

						IF AV_FILTER_TYPE IS NOT NULL AND AV_FILTER_TYPE <> '' THEN
							
                            IF AV_FILTER_TYPE = 'NO_CONFLICT_WITHOUT_ENGAGEMENTS' THEN
								SET TAB_QUERY = CONCAT(TAB_QUERY,' AND T1.VERSION_STATUS = ''PENDING'' AND T1.REVIEW_STATUS_CODE = 2 AND T1.CONFLICT_STATUS_CODE = 4
								AND T1.ADMIN_GROUP_ID IS NULL AND T1.ADMIN_PERSON_ID IS NULL ');
							ELSEIF AV_FILTER_TYPE = 'NO_CONFLICT_WITHOUT_PROJECTS' THEN
								SET TAB_QUERY = CONCAT(TAB_QUERY,' AND T1.VERSION_STATUS = ''PENDING'' AND T1.REVIEW_STATUS_CODE = 2 AND T1.CONFLICT_STATUS_CODE = 5
								AND T1.ADMIN_GROUP_ID IS NULL AND T1.ADMIN_PERSON_ID IS NULL ');
							ELSEIF AV_FILTER_TYPE = 'NO_CONFLICT_WITHOUT_PROJECTS_AND_ENGAGEMENTS' THEN
								SET TAB_QUERY = CONCAT(TAB_QUERY,' AND T1.VERSION_STATUS = ''PENDING'' AND T1.REVIEW_STATUS_CODE = 2 AND T1.CONFLICT_STATUS_CODE = 6
								AND T1.ADMIN_GROUP_ID IS NULL AND T1.ADMIN_PERSON_ID IS NULL ');
							ELSEIF AV_FILTER_TYPE = 'ALL' THEN
								SET TAB_QUERY = CONCAT(TAB_QUERY,' AND T1.VERSION_STATUS = ''PENDING'' AND T1.REVIEW_STATUS_CODE = 2 AND T1.CONFLICT_STATUS_CODE IN (4,5,6)
								AND T1.ADMIN_GROUP_ID IS NULL AND T1.ADMIN_PERSON_ID IS NULL ');
							END IF;
						END IF;
                        
        				SET LS_ADMIN_GROUP_FCOI_CONDITION = CONCAT(' AND T1.HOME_UNIT IN (SELECT DISTINCT UNIT_NUMBER FROM FCOI_ACCESS_TMP) ');
        				SET LS_ADMIN_GROUP_PROJECT_CONDITION = CONCAT(' AND T1.HOME_UNIT IN (SELECT DISTINCT UNIT_NUMBER FROM PROJECT_ACCESS_TMP) ');


        ELSEIF AV_TAB_TYPE = 'ALL_REVIEWS' THEN

        				SET TAB_QUERY = CONCAT(TAB_QUERY,' AND (T1.REVIEW_STATUS_CODE IN (4,7,8) AND T1.VERSION_STATUS IN (''PENDING'', ''ACTIVE'') 
					AND (''', AV_PERSON_ID, ''' IN (SELECT T34.ASSIGNEE_PERSON_ID WHERE T34.REVIEW_STATUS_TYPE_CODE = 2)))
					OR (T1.DISPOSITION_STATUS_CODE = 1 AND T1.REVIEW_STATUS_CODE IN (3,7,8) AND T1.VERSION_STATUS = ''PENDING''
					AND( T1.ADMIN_PERSON_ID = ''', AV_PERSON_ID ,'''
					OR (T1.HOME_UNIT IN (SELECT DISTINCT UNIT_NUMBER FROM ACCESS_TMP))))');

        ELSEIF AV_TAB_TYPE = 'MY_REVIEWS' THEN

        				SET TAB_QUERY = CONCAT(TAB_QUERY,' AND T1.REVIEW_STATUS_CODE IN (3,7,8)
        				AND ((''', AV_PERSON_ID ,''' IN (SELECT T34.ASSIGNEE_PERSON_ID WHERE T34.REVIEW_STATUS_TYPE_CODE IN (1,3)))
                        OR (''', AV_PERSON_ID ,''' =  T1.ADMIN_PERSON_ID ))
                        AND T1.VERSION_STATUS = ''PENDING'' ');

        END IF;

        SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' T.DISPOSITION_STATUS_CODE != ''2'' AND ');

        IF AV_TYPE ='A' THEN
        
        SET LS_FILTER_CONDITION = '';
        
		IF AV_TAB_TYPE = 'ALL_REVIEWS' THEN
			SET TAB_QUERY = '';
			SET TAB_QUERY = CONCAT(TAB_QUERY, ' AND ((''', AV_PERSON_ID, ''' IN (SELECT T34.ASSIGNEE_PERSON_ID) 
											  OR T1.ADMIN_PERSON_ID = ''', AV_PERSON_ID ,''' 
											  OR T1.HOME_UNIT IN (SELECT DISTINCT UNIT_NUMBER FROM ACCESS_TMP))
											 AND T1.VERSION_STATUS IN (''PENDING'',''ACTIVE''))');
                                             
        ELSEIF AV_TAB_TYPE = 'MY_REVIEWS' THEN
                        SET TAB_QUERY = '';
                        SET TAB_QUERY = CONCAT(TAB_QUERY, ' AND ((''', AV_PERSON_ID, ''' IN (SELECT T34.ASSIGNEE_PERSON_ID)) 
										OR (''', AV_PERSON_ID, ''' = T1.ADMIN_PERSON_ID)) AND T1.VERSION_STATUS IN (''PENDING'',''ACTIVE'') ');

        END IF;

        				IF AV_DISCLOSURE_NUMBER IS NOT NULL AND AV_DISCLOSURE_NUMBER <> '' THEN

        					SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' T.DISCLOSURE_NUMBER = ''',AV_DISCLOSURE_NUMBER,''' AND ');

        				END IF;

        				IF AV_DISCLOSURE_PERSON_ID IS NOT NULL AND AV_DISCLOSURE_PERSON_ID <> '' THEN

        					SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' T.PERSON_ID = ''',AV_DISCLOSURE_PERSON_ID,''' AND ');

        				END IF;

        				IF AV_HOME_UNIT IS NOT NULL AND AV_HOME_UNIT <> '' THEN

        					SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' T.HOME_UNIT = ''',AV_HOME_UNIT,''' AND ');

        				END IF;

        				IF AV_CONFLICT_STATUS_CODE IS NOT NULL  AND AV_CONFLICT_STATUS_CODE <> '' THEN

        					SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' T.CONFLICT_STATUS_CODE IN (',AV_CONFLICT_STATUS_CODE,') AND ');

        				END IF;

        				IF AV_DISPOSITION_STATUS_CODE IS NOT NULL  AND AV_DISPOSITION_STATUS_CODE <> '' THEN
        					SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' T.DISPOSITION_STATUS_CODE IN (',AV_DISPOSITION_STATUS_CODE,') AND ');
        				ELSE
        				    SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' T.DISPOSITION_STATUS_CODE != ''2'' AND ');
        				END IF;

                        IF AV_REVIEW_STATUS_CODE IS NOT NULL  AND AV_REVIEW_STATUS_CODE <> '' THEN
        					SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' T.REVIEW_STATUS_CODE IN (',AV_REVIEW_STATUS_CODE,') AND ');
        				END IF;

        				IF AV_DISCLOSURE_CATEOGORY_TYPE IS NOT NULL  AND AV_DISCLOSURE_CATEOGORY_TYPE <> '' THEN

        					SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' T.FCOI_TYPE_CODE IN (',AV_DISCLOSURE_CATEOGORY_TYPE,') AND ');

        				END IF;

        				 IF AV_START_DATE IS NOT NULL AND AV_START_DATE <> '' THEN

        					 SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' DATE(T.CREATE_TIMESTAMP) > ''', STR_TO_DATE(AV_START_DATE,'%Y-%m-%d'),''' AND ');

        				 END IF;

        				 IF AV_END_DATE IS NOT NULL AND AV_END_DATE <> '' THEN

        					 SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' DATE(T.EXPIRATION_DATE) = ''', STR_TO_DATE(AV_END_DATE,'%Y-%m-%d'),''' AND ');

        				 END IF;

        				IF AV_CERTIFICATION_DATE IS NOT NULL AND AV_CERTIFICATION_DATE <> '' THEN

        					SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' DATE(T.CERTIFIED_AT) = ''', STR_TO_DATE(AV_CERTIFICATION_DATE,'%Y-%m-%d'),''' AND ');

        				END IF;

        				IF AV_ENTITY_NAME IS NOT NULL  AND AV_ENTITY_NAME <> '' THEN

        					SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' T.ENTITY_NAMES LIKE ''%',AV_ENTITY_NAME, '%'' AND ');

        				END IF;

        				IF AV_ENTITY_COUNTRY IS NOT NULL  AND AV_ENTITY_COUNTRY <> '' THEN

        					SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' (T.ENTITY_COUNTRIES LIKE ''%,',AV_ENTITY_COUNTRY, ''' OR T.ENTITY_COUNTRIES LIKE ''',
        																			AV_ENTITY_COUNTRY, ',%'' OR T.ENTITY_COUNTRIES LIKE ''%,', AV_ENTITY_COUNTRY,
        																			',%'' OR T.ENTITY_COUNTRIES = ''', AV_ENTITY_COUNTRY, ''') AND ');

        				END IF;

        				IF AV_PROJECT_TYPE IS NOT NULL  AND AV_PROJECT_TYPE <> '' THEN

        					SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' (T.MODULE_CODES LIKE ''%,',AV_PROJECT_TYPE, ''' OR T.MODULE_CODES LIKE ''',
        																			AV_PROJECT_TYPE, ',%'' OR T.MODULE_CODES LIKE ''%,', AV_PROJECT_TYPE,
        																			',%'' OR T.MODULE_CODES = ''', AV_PROJECT_TYPE, ''') AND ');
        				END IF;

        				IF AV_HAS_SFI_FLAG IS NOT NULL AND AV_HAS_SFI_FLAG <> '' THEN

        						SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' T.HAS_SFI_FLAG = ''', AV_HAS_SFI_FLAG, ''' AND ');

        				END IF;
                        
                        IF AV_ADMINISTRATOR IS NOT NULL AND AV_ADMINISTRATOR <> '' THEN
								SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' T.ADMINISTRATOR_PERSON_ID IN (''',
								REPLACE(AV_ADMINISTRATOR, ',', ''','''),''') AND ');
						END IF;
                        
						SET @pn_pattern = NULL;
						SET @pt_pattern = NULL;
						SET @common_where = NULL;
						SET @dev_prop_where = NULL;
						SET @where_clause = '';

						IF AV_PROJECT_NUMBER IS NOT NULL AND AV_PROJECT_NUMBER <> '' THEN
							IF INSTR(AV_PROJECT_NUMBER, '*') > 0 THEN
								SET @pn_pattern = REPLACE(AV_PROJECT_NUMBER, '*', '%');
							ELSE
								SET @pn_pattern = CONCAT('%', AV_PROJECT_NUMBER, '%');
							END IF;
						END IF;

						IF AV_PROJECT_TITLE IS NOT NULL AND AV_PROJECT_TITLE <> '' THEN
							IF INSTR(AV_PROJECT_TITLE, '*') > 0 THEN
								SET @pt_pattern = REPLACE(AV_PROJECT_TITLE, '*', '%');
							ELSE
								SET @pt_pattern = CONCAT('%', AV_PROJECT_TITLE, '%');
							END IF;
						END IF;

						IF @pn_pattern IS NOT NULL AND @pt_pattern IS NOT NULL THEN
							SET @common_where = CONCAT('PROJECT_NUMBER LIKE ''', @pn_pattern, 
													''' AND TITLE LIKE ''', @pt_pattern, '''');
							SET @dev_prop_where = CONCAT('PROPOSAL_NUMBER LIKE ''', @pn_pattern, 
													''' AND TITLE LIKE ''', @pt_pattern, '''');
						ELSEIF @pt_pattern IS NOT NULL THEN
							SET @common_where = CONCAT('TITLE LIKE ''', @pt_pattern, '''');
							SET @dev_prop_where = @common_where;
						ELSEIF @pn_pattern IS NOT NULL THEN
							SET @common_where = CONCAT('PROJECT_NUMBER LIKE ''', @pn_pattern, '''');
							SET @dev_prop_where = CONCAT('PROPOSAL_NUMBER LIKE ''', @pn_pattern, '''');
						ELSE
							SET LS_PROP_PROJECT_FILTER_CONDITION = NULL;
							SET LS_AWARD_PROJECT_FILTER_CONDITION = NULL;
							SET LS_IP_PROJECT_FILTER_CONDITION   = NULL;    
						END IF;

						SET LS_PROP_PROJECT_FILTER_CONDITION =  CONCAT(' WHERE ', @dev_prop_where);
						SET LS_AWARD_PROJECT_FILTER_CONDITION =  CONCAT(' WHERE ', @common_where);
						SET LS_IP_PROJECT_FILTER_CONDITION = LS_AWARD_PROJECT_FILTER_CONDITION;

					 IF LS_PROP_PROJECT_FILTER_CONDITION IS NOT NULL 
						   AND LS_AWARD_PROJECT_FILTER_CONDITION IS NOT NULL 
						   AND LS_IP_PROJECT_FILTER_CONDITION IS NOT NULL THEN

						 IF AV_TAB_TYPE = 'MY_REVIEWS' THEN
							  SET LS_DYN_SQL = CONCAT(LS_DYN_SQL, 'WITH ');
						   ELSE
							  SET LS_DYN_SQL = CONCAT(LS_DYN_SQL, ', ');
						   END IF;
						   SET LS_DYN_SQL = CONCAT(LS_DYN_SQL,
								'PROJECT_FILTER_TEMP AS (',
									'SELECT DISTINCT DISCLOSURE_ID FROM COI_DISCL_PROJECTS WHERE MODULE_ITEM_KEY IN ',
									'(SELECT PROPOSAL_NUMBER FROM COI_INT_STAGE_DEV_PROPOSAL ', LS_PROP_PROJECT_FILTER_CONDITION, ') ',
									'UNION ALL ',
									'SELECT DISCLOSURE_ID FROM COI_DISCL_PROJECTS WHERE MODULE_ITEM_KEY IN ',
									'(SELECT PROJECT_NUMBER FROM COI_INT_STAGE_AWARD ', LS_AWARD_PROJECT_FILTER_CONDITION, ') ',
									'UNION ALL ',
									'SELECT DISCLOSURE_ID FROM COI_DISCL_PROJECTS WHERE MODULE_ITEM_KEY IN ',
									'(SELECT PROJECT_NUMBER FROM COI_INT_STAGE_PROPOSAL ', LS_IP_PROJECT_FILTER_CONDITION, ') ',
								') ');
						END IF;
        END IF;
		
		IF AV_TAB_TYPE = 'MY_REVIEWS' AND (AV_TYPE <> 'A' OR (LS_PROP_PROJECT_FILTER_CONDITION IS NULL AND LS_AWARD_PROJECT_FILTER_CONDITION IS NULL AND LS_IP_PROJECT_FILTER_CONDITION IS NULL)) THEN
			SET LS_DYN_SQL = CONCAT(LS_DYN_SQL, 'WITH ');
		ELSE 
			SET LS_DYN_SQL = CONCAT(LS_DYN_SQL, ', ');
		END IF;                       
		SET LS_DYN_SQL = CONCAT(LS_DYN_SQL,	'
				ACCESS_COMMENT AS (SELECT
					MAX(T3.RIGHT_NAME IN (''VIEW_COI_COMMENTS'',''MAINTAIN_COI_COMMENTS'',''VIEW_COI_PRIVATE_COMMENTS'',''MAINTAIN_COI_PRIVATE_COMMENTS'')) AS HAS_PROJ_COMMENT_ACCESS,
					MAX(T3.RIGHT_NAME IN (''VIEW_COI_PRIVATE_COMMENTS'',''MAINTAIN_COI_PRIVATE_COMMENTS'')) AS HAS_PRIVATE_COMMENT_ACCESS
					FROM PERSON_ROLES T1
					INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
					INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
					WHERE T1.PERSON_ID = ''',AV_PERSON_ID,'''), 
				PROJECT_COMMENTS AS (
					SELECT COUNT(CPC.COMMENT_ID) AS COMMENT_COUNT, DP.DISCLOSURE_ID
					FROM COI_PROJECT_COMMENT CPC
					JOIN COI_DISCL_PROJECTS DP ON DP.MODULE_CODE = CPC.MODULE_CODE AND DP.MODULE_ITEM_KEY = CPC.MODULE_ITEM_KEY
					WHERE CPC.COMMENT_TYPE_CODE = 1
					  AND CPC.PARENT_COMMENT_ID IS NULL
					  AND (
						 (SELECT HAS_PROJ_COMMENT_ACCESS FROM ACCESS_COMMENT) = 1
						  OR EXISTS (
							  SELECT 1 FROM COI_DISCLOSURE T1
							  WHERE DP.DISCLOSURE_ID = T1.DISCLOSURE_ID 
								AND T1.PERSON_ID = ''',AV_PERSON_ID,''' )
					  )
					GROUP BY DP.DISCLOSURE_ID),
				DISCL_COMMENTS AS (
					SELECT COUNT(COMMENT_ID) AS COMMENT_COUNT, MODULE_ITEM_KEY 
					FROM DISCL_COMMENT DC
					WHERE DC.MODULE_CODE = 8
					  AND DC.COMPONENT_TYPE_CODE IN (''2'',''3'',''4'',''5'',''6'',''8'',''9'',''10'',''11'',''12'',''13'',''14'')
					  AND DC.PARENT_COMMENT_ID IS NULL
					  AND (
							(SELECT HAS_PRIVATE_COMMENT_ACCESS FROM ACCESS_COMMENT) = 1
							OR (DC.IS_PRIVATE = ''N'' OR (DC.IS_PRIVATE = ''Y'' AND DC.COMMENT_BY_PERSON_ID = ''',AV_PERSON_ID,''') OR DC.MODULE_ITEM_KEY IN (
												SELECT DISCLOSURE_ID
												FROM COI_REVIEW CR 
												WHERE CR.ASSIGNEE_PERSON_ID = ''',AV_PERSON_ID,''')
						))
					GROUP BY MODULE_ITEM_KEY) 
                    ');
		
        IF AV_SORT_TYPE IS NULL THEN
                SET AV_SORT_TYPE =  CONCAT(' ORDER BY T.UPDATE_TIMESTAMP DESC ');
        ELSE
            SET AV_SORT_TYPE = CONCAT(' ORDER BY ',AV_SORT_TYPE);
        END IF;

        IF AV_UNLIMITED = TRUE THEN
                SET LS_OFFSET_CONDITION = '';
        ELSE
                SET LS_OFFSET_CONDITION = CONCAT(' LIMIT ',AV_LIMIT,' OFFSET ',LS_OFFSET);
        END IF;

        IF LS_FILTER_CONDITION <>'' THEN
                SET LS_FILTER_CONDITION = CONCAT(' WHERE ',LS_FILTER_CONDITION);
                SELECT TRIM(TRAILING 'AND ' FROM LS_FILTER_CONDITION) into LS_FILTER_CONDITION from dual;
        END IF;

        	IF AV_IS_COUNT = TRUE THEN
        		SET AV_SORT_TYPE = '';
        		SET LS_OFFSET_CONDITION = '';
        		SET LS_DYN_SQL = CONCAT(LS_DYN_SQL, ' SELECT COUNT(*)');
        	ELSE
        		SET LS_DYN_SQL = CONCAT(LS_DYN_SQL, ' SELECT * ');
        	END IF;
        	SET SELECTED_FIELD_LIST = CONCAT(
        									SELECTED_FIELD_LIST,
        									'T1.DISCLOSURE_ID,
        									T1.DISCLOSURE_NUMBER,
        									T1.VERSION_NUMBER,
        									T1.PERSON_ID,
        									T7.FULL_NAME AS DISCLOSURE_PERSON_FULL_NAME,
        									T1.HOME_UNIT,
        									T1.FCOI_TYPE_CODE,
        									T8.DESCRIPTION AS DISCLOSURE_CATEGORY_TYPE,
        									T1.CONFLICT_STATUS_CODE,
        									T2.DESCRIPTION AS DISCLOSURE_STATUS,
        									T1.DISPOSITION_STATUS_CODE,
        									T3.DESCRIPTION AS DISPOSITION_STATUS,
        									T1.REVIEW_STATUS_CODE,
        									T4.DESCRIPTION AS REVIEW_STATUS,
        									T1.VERSION_STATUS,
        									T1.CREATE_TIMESTAMP,
        									T1.CERTIFICATION_TEXT,
        									T1.CERTIFIED_AT,
        									T1.EXPIRATION_DATE,
        									T1.IS_EXTENDED,
        									T6.FULL_NAME AS UPDATE_USER_FULL_NAME,
        									T1.UPDATE_TIMESTAMP,
        									T11.VERSION_NUMBER AS LAST_APPROVED_VERSION,
        									T11.UPDATE_TIMESTAMP AS LAST_APPROVED_DATE,
        									T13.ENTITY_NAMES,
        									T13.ENTITY_COUNTRIES,
        	                                CONCAT(''['', TRIM(BOTH '','' FROM CONCAT(
                                                    CASE WHEN T18.DISCLOSURE_ID IS NOT NULL THEN CONCAT(''{'',
                                                    												''"projectType"'', '' : "'', T18.COI_PROJECT_TYPE, ''",'',
                                                    												''"projectCount"'', '' : "'', T18.NO_OF_PROPOSAL,''",'',
                                                    												''"moduleCode"'','' : '', 3, ''}'') ELSE '''' END,
                                                    CASE WHEN T18.DISCLOSURE_ID IS NOT NULL AND T19.DISCLOSURE_ID IS NOT NULL THEN '','' ELSE '''' END,
                                                    CASE WHEN T19.DISCLOSURE_ID IS NOT NULL THEN CONCAT(''{'',
                                                                                                    ''"projectType"'', '' : "'', T19.COI_PROJECT_TYPE, ''",'',
                                                                                                    ''"projectCount"'', '' : "'', T19.NO_OF_AWARD, ''",'',
                                                                                                    ''"moduleCode"'','' : '', 1,''}'') ELSE '''' END,
                                                    CASE WHEN T19.DISCLOSURE_ID IS NOT NULL AND T20.DISCLOSURE_ID IS NOT NULL THEN '','' ELSE '''' END,
                                                    CASE WHEN T20.DISCLOSURE_ID IS NOT NULL THEN CONCAT(''{'',
                                                                                                    ''"projectType"'', '' : "'', T20.COI_PROJECT_TYPE, ''",'',
                                                                                                    ''"projectCount"'', '' : "'', T20.NO_OF_INSTITUTE_PROPOSALS, ''",'',
                                                                                                    ''"moduleCode"'','' : '', 2,''}'') ELSE '''' END
                                                    )),'']'') AS PROJECT_COUNT,
        									CASE WHEN T1.FCOI_TYPE_CODE = 2 AND T50.PROJECT_SNAPSHOT IS NULL THEN
        									    COALESCE(T14.TITLE , T21.TITLE, T15.TITLE )
        									ELSE
        									    CASE WHEN T1.FCOI_TYPE_CODE = 2 AND T50.PROJECT_SNAPSHOT IS NOT NULL THEN
        									        T50.PROJECT_SNAPSHOT->>''$.PROJECT_TITLE'' 
        									    ELSE NULL END
        									END AS PROJECT_TITLE,
        									CASE WHEN T1.FCOI_TYPE_CODE = 2 AND T50.PROJECT_SNAPSHOT IS NULL THEN
        									    COALESCE(T14.PROPOSAL_NUMBER , T21.PROJECT_NUMBER , T15.PROJECT_NUMBER )
        									ELSE
        									    CASE WHEN T1.FCOI_TYPE_CODE = 2 AND T50.PROJECT_SNAPSHOT IS NOT NULL THEN
                                                    T50.PROJECT_SNAPSHOT->>''$.PROJECT_NUMBER''
                                                ELSE NULL END
                                            END AS PROJECT_NUMBER,
        									T22.BADGE_COLOR,
        									T22.PROJECT_ICON,
        									T22.DESCRIPTION AS COI_PROJECT_TYPE,
        									T1.COI_PROJECT_TYPE_CODE,
        									T16.MODULE_CODES,
        									T1.REVISION_COMMENT,
        									T17.NO_OF_SFI,
        									T30.UNIT_NAME AS HOME_UNIT_NAME,
        									T30.ORGANIZATION_ID,
        									T30.PARENT_UNIT_NUMBER,
        									T30.IS_ACTIVE,
        									T30.ACRONYM,
        									T30.IS_FUNDING_UNIT,
        									T31.ADMIN_GROUP_NAME,
        									T32.FULL_NAME AS ADMINISTRATOR,
                                            T32.PERSON_ID AS ADMINISTRATOR_PERSON_ID,
        									GROUP_CONCAT(
        										DISTINCT CASE
        											WHEN T34.ASSIGNEE_PERSON_ID IS NULL THEN CONCAT(T36.DESCRIPTION, " : ", "null", " : ", T35.DESCRIPTION, " : ", T35.REVIEW_STATUS_CODE)
        											ELSE CONCAT(T36.DESCRIPTION, " : ", T33.FULL_NAME, " : ", T35.DESCRIPTION, " : ", T35.REVIEW_STATUS_CODE)
        										END
        										SEPARATOR ";"
        									) AS REVIEWERS,
                                            (IFNULL(PC.COMMENT_COUNT, 0) + IFNULL(DC.COMMENT_COUNT, 0)) AS DISCLOSURE_COMMENT_COUNT,
											IFNULL(T64.DISCLOSURE_ATTACHMENT_COUNT, 0) AS DISCLOSURE_ATTACHMENT_COUNT'
        								);

        	SET JOIN_CONDITION = CONCAT(
        								' LEFT JOIN COI_CONFLICT_STATUS_TYPE T2 ON T2.CONFLICT_STATUS_CODE = T1.CONFLICT_STATUS_CODE
        								LEFT JOIN COI_DISPOSITION_STATUS_TYPE T3 ON T3.DISPOSITION_STATUS_CODE = T1.DISPOSITION_STATUS_CODE
        								LEFT JOIN COI_REVIEW_STATUS_TYPE T4 ON T4.REVIEW_STATUS_CODE = T1.REVIEW_STATUS_CODE
        								INNER JOIN PERSON T6 ON T6.PERSON_ID = T1.UPDATED_BY
        								INNER JOIN PERSON T7 ON T7.PERSON_ID = T1.PERSON_ID
        								LEFT JOIN COI_DISCLOSURE_FCOI_TYPE T8 ON T8.FCOI_TYPE_CODE = T1.FCOI_TYPE_CODE
        								LEFT JOIN (
        									SELECT DISCLOSURE_NUMBER, VERSION_NUMBER, UPDATE_TIMESTAMP FROM COI_DISCLOSURE
        									WHERE (DISCLOSURE_NUMBER, VERSION_NUMBER) IN (
        										SELECT S1.DISCLOSURE_NUMBER, MAX(S1.VERSION_NUMBER) FROM COI_DISCLOSURE S1
        										WHERE S1.VERSION_STATUS = ''ACTIVE'' GROUP BY S1.DISCLOSURE_NUMBER
        									)
        								) T11 ON T11.DISCLOSURE_NUMBER = T1.DISCLOSURE_NUMBER
        								LEFT JOIN (
        									SELECT T1.DISCLOSURE_ID, GROUP_CONCAT(DISTINCT(T4.PRIMARY_NAME) SEPARATOR ", ") AS ENTITY_NAMES,
        									GROUP_CONCAT(DISTINCT(T4.COUNTRY_CODE) SEPARATOR ",") AS ENTITY_COUNTRIES
        									FROM COI_DISCL_PROJECTS T1
        									INNER JOIN COI_DISCL_PROJECT_ENTITY_REL T2 ON T2.COI_DISCL_PROJECTS_ID = T1.COI_DISCL_PROJECTS_ID
        									INNER JOIN PERSON_ENTITY T3 ON T3.PERSON_ENTITY_ID = T2.PERSON_ENTITY_ID
        									INNER JOIN ENTITY T4 ON T4.ENTITY_ID = T3.ENTITY_ID
        									GROUP BY T1.DISCLOSURE_ID
        								) T13 ON T13.DISCLOSURE_ID = T1.DISCLOSURE_ID
        								LEFT JOIN COI_INT_STAGE_DEV_PROPOSAL T14 ON T14.PROPOSAL_NUMBER = T50.MODULE_ITEM_KEY AND  T1.COI_PROJECT_TYPE_CODE = ''3''
        								LEFT JOIN COI_INT_STAGE_AWARD T15 ON T15.PROJECT_NUMBER = T50.MODULE_ITEM_KEY AND T1.COI_PROJECT_TYPE_CODE = ''1''
        								LEFT JOIN COI_INT_STAGE_PROPOSAL T21 ON T21.PROJECT_NUMBER = T50.MODULE_ITEM_KEY AND  T1.COI_PROJECT_TYPE_CODE = ''2''
        								LEFT JOIN (
        									SELECT DISCLOSURE_ID, GROUP_CONCAT(DISTINCT(MODULE_CODE) SEPARATOR ",") AS MODULE_CODES
        									FROM COI_DISCL_PROJECTS GROUP BY DISCLOSURE_ID
        								) T16 ON T16.DISCLOSURE_ID = T1.DISCLOSURE_ID
        								LEFT JOIN UNIT T30 ON T30.UNIT_NUMBER = T1.HOME_UNIT
        								LEFT JOIN ADMIN_GROUP T31 ON T31.ADMIN_GROUP_ID = T1.ADMIN_GROUP_ID
        								LEFT JOIN PERSON T32 ON T32.PERSON_ID = T1.ADMIN_PERSON_ID
										LEFT JOIN (
											SELECT DISCLOSURE_ID, COUNT(DISTINCT ATTACHMENT_NUMBER) AS DISCLOSURE_ATTACHMENT_COUNT
											FROM DISCL_ATTACHMENT
											GROUP BY DISCLOSURE_ID
										) T64 ON T64.DISCLOSURE_ID = T1.DISCLOSURE_ID
        								LEFT JOIN COI_PROJECT_TYPE T22 ON T22.COI_PROJECT_TYPE_CODE = T1.COI_PROJECT_TYPE_CODE 
										LEFT JOIN PROJECT_COMMENTS PC ON PC.DISCLOSURE_ID = T1.DISCLOSURE_ID
										LEFT JOIN DISCL_COMMENTS DC ON DC.MODULE_ITEM_KEY = T1.DISCLOSURE_ID ', JOIN_CONDITION
        							);
                 
                 	IF LS_PROP_PROJECT_FILTER_CONDITION IS NOT NULL AND LS_AWARD_PROJECT_FILTER_CONDITION IS NOT NULL AND LS_IP_PROJECT_FILTER_CONDITION IS NOT NULL THEN
    IF LS_FILTER_CONDITION IS NULL OR LS_FILTER_CONDITION = '' THEN
        SET LS_FILTER_CONDITION = CONCAT('WHERE EXISTS (SELECT 1 FROM PROJECT_FILTER_TEMP PD WHERE PD.DISCLOSURE_ID = T.DISCLOSURE_ID) ');
    ELSE
        SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' AND EXISTS (SELECT 1 FROM PROJECT_FILTER_TEMP PD WHERE PD.DISCLOSURE_ID = T.DISCLOSURE_ID) ');
    END IF;
END IF;

                SET LS_DYN_SQL = CONCAT(LS_DYN_SQL, ' FROM(SELECT DISTINCT ',SELECTED_FIELD_LIST,'
        										FROM COI_DISCLOSURE T1
        										LEFT JOIN COI_DISCL_PROJECTS T50 ON T50.DISCLOSURE_ID = T1.DISCLOSURE_ID',
        										JOIN_CONDITION, ' WHERE T1.FCOI_TYPE_CODE IN (1,3)  ',LS_ADMIN_GROUP_FCOI_CONDITION, TAB_QUERY,
                                                ' GROUP BY T1.DISCLOSURE_ID
        										UNION
        										SELECT DISTINCT ',SELECTED_FIELD_LIST,'
        										FROM COI_DISCLOSURE T1
        										LEFT JOIN COI_DISCL_PROJECTS T50 ON T50.DISCLOSURE_ID = T1.DISCLOSURE_ID',
        										JOIN_CONDITION, ' WHERE T1.FCOI_TYPE_CODE = 2 ',LS_ADMIN_GROUP_PROJECT_CONDITION, TAB_QUERY,
                                                ' GROUP BY T1.DISCLOSURE_ID) T ',LS_FILTER_CONDITION,' ',AV_SORT_TYPE,' ',LS_OFFSET_CONDITION);
        SET @QUERY_STATEMENT = LS_DYN_SQL;
        PREPARE EXECUTABLE_STAEMENT FROM @QUERY_STATEMENT;
        EXECUTE EXECUTABLE_STAEMENT;

END
//
