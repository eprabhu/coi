DELIMITER //
CREATE PROCEDURE `COI_DISCL_PROJ_ENTITY_INSERTION`(
	AV_COI_DISCL_PROJECTS_ID          	INT,
	AV_DISCLOSURE_ID 					INT,
	AV_DISCLOSURE_NUMBER 				INT,
	AV_MODULE_CODE						INT,
	AV_MODULE_ITEM_KEY					VARCHAR(100),
	AV_PERSON_ID        				VARCHAR(40),
	AV_UPDATED_BY        				VARCHAR(40),
	AV_SFI_JSON_ARRAY      				JSON
    )
    BEGIN

    DECLARE i INT DEFAULT 0;
    DECLARE array_length INT DEFAULT JSON_LENGTH(AV_SFI_JSON_ARRAY);
    DECLARE LS_PROJECT_ENGAGEMENT_DETAILS VARCHAR(2000);
    DECLARE LS_PROJECT_CONFLICT_STATUS_CODE VARCHAR(10);
    DECLARE LS_UPDATE_USER VARCHAR(60);
    DECLARE LI_COI_DISCL_PROJECT_ENTITY_REL_ID INT;
    DECLARE LI_ENTITY_ID INT;
    DECLARE LI_PERSON_ENTITY_ID INT;
    DECLARE LI_PERSON_ENTITY_NUMBER VARCHAR(50);
    DECLARE done INT DEFAULT FALSE;
    DECLARE LI_COUNT, LI_COUNT_EXISTING, LI_PARENT_COMMENT_ID INT;
    DECLARE V_COMMENT TEXT;
    DECLARE V_COMPONENT_TYPE_CODE VARCHAR(10);
    DECLARE V_COMMENT_BY_PERSON_ID VARCHAR(40);
    DECLARE V_PARENT_COMMENT_ID INT;
    DECLARE V_IS_PRIVATE CHAR(1);
    DECLARE V_UPDATE_USER VARCHAR(40);
    DECLARE V_PREV_DISCLOSURE_ID INT;

    WHILE i < array_length DO
        SET @json_obj = JSON_EXTRACT(AV_SFI_JSON_ARRAY, CONCAT('$[', i, ']'));
        SET LI_ENTITY_ID = JSON_UNQUOTE(JSON_EXTRACT(@json_obj, '$.ENTITY_ID'));
        SET LI_PERSON_ENTITY_ID = JSON_UNQUOTE(JSON_EXTRACT(@json_obj, '$.PERSON_ENTITY_ID'));
        SET LI_PERSON_ENTITY_NUMBER = JSON_UNQUOTE(JSON_EXTRACT(@json_obj, '$.PERSON_ENTITY_NUMBER'));
        SET LI_COI_DISCL_PROJECT_ENTITY_REL_ID = NULL;
        SET @PROJECT_ENT_REL_ID = NULL;

	SELECT DISCLOSURE_ID
	INTO V_PREV_DISCLOSURE_ID
	FROM COI_DISCLOSURE
	WHERE DISCLOSURE_ID <> AV_DISCLOSURE_ID AND PERSON_ID = AV_PERSON_ID AND FCOI_TYPE_CODE <> 2
	ORDER BY DISCLOSURE_ID DESC
	LIMIT 1;

        -- Project details query
        SELECT T1.PROJECT_CONFLICT_STATUS_CODE, T1.PROJECT_ENGAGEMENT_DETAILS, T1.UPDATED_BY, T1.COI_DISCL_PROJECT_ENTITY_REL_ID
        INTO LS_PROJECT_CONFLICT_STATUS_CODE, LS_PROJECT_ENGAGEMENT_DETAILS, LS_UPDATE_USER, LI_COI_DISCL_PROJECT_ENTITY_REL_ID
        FROM COI_DISCL_PROJECT_ENTITY_REL T1
        INNER JOIN COI_DISCL_PROJECTS T2 ON T2.COI_DISCL_PROJECTS_ID = T1.COI_DISCL_PROJECTS_ID
        WHERE T1.PERSON_ENTITY_NUMBER = LI_PERSON_ENTITY_NUMBER AND T1.ENTITY_ID = LI_ENTITY_ID
          AND ((T2.MODULE_CODE = AV_MODULE_CODE AND T2.MODULE_ITEM_KEY = AV_MODULE_ITEM_KEY)
              OR T1.COI_DISCL_PROJECTS_ID IN (
                  SELECT T.COI_DISCL_PROJECTS_ID
                  FROM COI_DISCL_PROJECTS T
                  LEFT JOIN COI_PROJECT_INSTITUTE_PROPOSAL_V IP ON IP.LINKED_AWARD_PROJECT_NUMBER = AV_MODULE_ITEM_KEY AND T.MODULE_CODE = 2
                  LEFT JOIN COI_PROJECT_PROPOSAL_V PP ON PP.LINKED_IP_NUMBER = AV_MODULE_ITEM_KEY AND T.MODULE_CODE = 3
                  WHERE IP.PROPOSAL_NUMBER = T.MODULE_ITEM_KEY OR PP.PROPOSAL_NUMBER = T.MODULE_ITEM_KEY
              )
          )
        ORDER BY T1.UPDATE_TIMESTAMP DESC
        LIMIT 1;
		
        -- Check count from previous disclosure
        SELECT COUNT(*) INTO LI_COUNT
        FROM COI_DISCL_PROJECT_ENTITY_REL T1
        JOIN COI_DISCL_PROJECTS T2 ON T2.COI_DISCL_PROJECTS_ID = T1.COI_DISCL_PROJECTS_ID
        WHERE T2.DISCLOSURE_ID = V_PREV_DISCLOSURE_ID
          AND T1.PERSON_ENTITY_NUMBER = LI_PERSON_ENTITY_NUMBER
          AND T1.ENTITY_ID = LI_ENTITY_ID;

        -- Check count for current disclosure
        SELECT COUNT(*) INTO LI_COUNT_EXISTING
        FROM COI_DISCL_PROJECT_ENTITY_REL T1
        JOIN COI_DISCL_PROJECTS T2 ON T2.COI_DISCL_PROJECTS_ID = T1.COI_DISCL_PROJECTS_ID
        WHERE T2.DISCLOSURE_ID = AV_DISCLOSURE_ID
          AND T1.PERSON_ENTITY_NUMBER = LI_PERSON_ENTITY_NUMBER
          AND T1.ENTITY_ID = LI_ENTITY_ID
		  AND (
              (T2.MODULE_CODE = AV_MODULE_CODE AND T2.MODULE_ITEM_KEY = AV_MODULE_ITEM_KEY)
              OR T1.COI_DISCL_PROJECTS_ID IN (
                  SELECT T.COI_DISCL_PROJECTS_ID
                  FROM COI_DISCL_PROJECTS T
                  LEFT JOIN COI_PROJECT_INSTITUTE_PROPOSAL_V IP ON IP.LINKED_AWARD_PROJECT_NUMBER = AV_MODULE_ITEM_KEY AND T.MODULE_CODE = 2
                  LEFT JOIN COI_PROJECT_PROPOSAL_V PP ON PP.LINKED_IP_NUMBER = AV_MODULE_ITEM_KEY AND T.MODULE_CODE = 3
                  WHERE IP.PROPOSAL_NUMBER = T.MODULE_ITEM_KEY OR PP.PROPOSAL_NUMBER = T.MODULE_ITEM_KEY
              )
          );

        -- If no match in previous disclosure, reset conflict/status
        IF LI_COUNT = 0 THEN
            SET LS_PROJECT_CONFLICT_STATUS_CODE = NULL;
            SET LS_PROJECT_ENGAGEMENT_DETAILS = NULL;
        END IF;

        IF LI_COUNT_EXISTING = 0 THEN
		
            INSERT INTO COI_DISCL_PROJECT_ENTITY_REL (
                COI_DISCL_PROJECTS_ID, PERSON_ENTITY_ID, PERSON_ENTITY_NUMBER, ENTITY_ID,
                PROJECT_CONFLICT_STATUS_CODE, PROJECT_ENGAGEMENT_DETAILS, UPDATED_BY, UPDATE_TIMESTAMP)
            VALUES (
                AV_COI_DISCL_PROJECTS_ID, LI_PERSON_ENTITY_ID, LI_PERSON_ENTITY_NUMBER, LI_ENTITY_ID,
                LS_PROJECT_CONFLICT_STATUS_CODE, LS_PROJECT_ENGAGEMENT_DETAILS, LS_UPDATE_USER, UTC_TIMESTAMP());

            SET @PROJECT_ENT_REL_ID = LAST_INSERT_ID();

            IF EXISTS(SELECT 1 FROM DISCL_COMMENT C
					   LEFT JOIN DISCL_COMMENT PCOMMENT ON PCOMMENT.COMMENT_ID = C.PARENT_COMMENT_ID
					   WHERE C.COMPONENT_TYPE_CODE = '6'
						  AND C.MODULE_CODE = 8
						  AND C.SUB_MODULE_ITEM_KEY = LI_COI_DISCL_PROJECT_ENTITY_REL_ID
						  AND C.MODULE_ITEM_KEY = V_PREV_DISCLOSURE_ID) THEN 

				-- Copy Comments from previous disclosure entity
				INSERT INTO DISCL_COMMENT (
					COMMENT, MODULE_CODE, MODULE_ITEM_KEY, MODULE_ITEM_NUMBER, SUB_MODULE_ITEM_KEY,
					COMPONENT_TYPE_CODE, DOCUMENT_OWNER_PERSON_ID, COMMENT_BY_PERSON_ID, PARENT_COMMENT_ID,
					IS_PRIVATE, UPDATE_USER, UPDATE_TIMESTAMP)
				SELECT
					C.COMMENT, 8, AV_DISCLOSURE_ID, AV_DISCLOSURE_NUMBER, @PROJECT_ENT_REL_ID,
					C.COMPONENT_TYPE_CODE, AV_PERSON_ID, C.COMMENT_BY_PERSON_ID, NULL,
					C.IS_PRIVATE, C.UPDATE_USER, UTC_TIMESTAMP()
				FROM DISCL_COMMENT C
				WHERE C.COMPONENT_TYPE_CODE = '6'
				  AND C.MODULE_CODE = 8
				  AND C.SUB_MODULE_ITEM_KEY = LI_COI_DISCL_PROJECT_ENTITY_REL_ID
				  AND C.MODULE_ITEM_KEY = V_PREV_DISCLOSURE_ID;
                
				-- Updating parent comment Id (reply comment)
				UPDATE DISCL_COMMENT T1
				JOIN DISCL_COMMENT T2 ON T2.COMMENT = T1.COMMENT
					 AND T2.COMMENT_BY_PERSON_ID = T1.COMMENT_BY_PERSON_ID
					 AND T2.MODULE_ITEM_KEY = V_PREV_DISCLOSURE_ID
					 AND T2.SUB_MODULE_ITEM_KEY = LI_COI_DISCL_PROJECT_ENTITY_REL_ID
				JOIN DISCL_COMMENT T3 ON T2.PARENT_COMMENT_ID = T3.COMMENT_ID
				JOIN DISCL_COMMENT T4 ON T4.COMMENT = T3.COMMENT
					 AND T4.COMMENT_BY_PERSON_ID = T3.COMMENT_BY_PERSON_ID
					 AND T4.MODULE_ITEM_KEY = AV_DISCLOSURE_ID
					 AND T4.SUB_MODULE_ITEM_KEY = @PROJECT_ENT_REL_ID
				SET T1.PARENT_COMMENT_ID = T4.COMMENT_ID
				WHERE T1.MODULE_ITEM_KEY = AV_DISCLOSURE_ID
				  AND T1.PARENT_COMMENT_ID IS NULL
				  AND T1.COMPONENT_TYPE_CODE = '6';
				  
			END IF;
			
        END IF;

        SET i = i + 1;
    END WHILE;

    UPDATE COI_DISCLOSURE SET SYNC_NEEDED = 'N' WHERE DISCLOSURE_ID = AV_DISCLOSURE_ID;
END
//
