DELIMITER //
CREATE FUNCTION `FN_CHK_HAS_COMPENSATION_AMOUNT`(
    AV_PERSON_ENTITY_ID INT
) RETURNS varchar(8) CHARSET utf8mb4
    DETERMINISTIC
BEGIN
	DECLARE LS_EVALUATION_ENABLED VARCHAR(1) DEFAULT 'N';
	DECLARE LI_COUNT INT;
	DECLARE LI_VALID_COUNT INT;
    DECLARE LI_Q1_YES_COUNT INT;
    DECLARE LI_Q2_YES_COUNT INT;
    DECLARE LI_COMP_AMOUNT DECIMAL(18,2);
    
    -- Check if evaluation is enabled
    SELECT VALUE 
    INTO LS_EVALUATION_ENABLED
    FROM PARAMETER 
    WHERE PARAMETER_NAME = 'ENABLE_SIGNIFICANT_FIN_INTEREST_EVALUATION';
    
		IF LS_EVALUATION_ENABLED = 'N' THEN
			RETURN 'TRUE';
		END IF;

	-- Count of 'Yes' answers for Question 1
    SELECT COUNT(*) INTO LI_Q1_YES_COUNT
    FROM PER_ENT_MATRIX_ANSWER
    WHERE PERSON_ENTITY_ID = AV_PERSON_ENTITY_ID
      AND MATRIX_QUESTION_ID = 1
      AND UPPER(COLUMN_VALUE) = 'YES';

    -- Count of 'Yes' answers for Question 2
    SELECT COUNT(*) INTO LI_Q2_YES_COUNT
    FROM PER_ENT_MATRIX_ANSWER
    WHERE PERSON_ENTITY_ID = AV_PERSON_ENTITY_ID
      AND MATRIX_QUESTION_ID = 2
      AND UPPER(COLUMN_VALUE) = 'YES';

    SELECT COUNT(*) INTO LI_COUNT
    FROM PER_ENT_MATRIX_ANSWER
    WHERE PERSON_ENTITY_ID = AV_PERSON_ENTITY_ID
      AND MATRIX_QUESTION_ID NOT IN (1, 2)
      AND COLUMN_VALUE = '$5000 or more';

    IF LI_Q1_YES_COUNT = 0 AND LI_Q2_YES_COUNT = 0 AND LI_COUNT = 0 THEN
    
		SELECT COUNT(*) INTO LI_VALID_COUNT
		FROM PER_ENT_MATRIX_ANSWER
		WHERE PERSON_ENTITY_ID = AV_PERSON_ENTITY_ID
		AND MATRIX_QUESTION_ID NOT IN (1, 2)
		AND COLUMN_VALUE = '$1 to $4999';

		IF LI_VALID_COUNT > 0 THEN
        
			SELECT COMPENSATION_AMOUNT INTO LI_COMP_AMOUNT
			FROM PERSON_ENTITY
			WHERE PERSON_ENTITY_ID = AV_PERSON_ENTITY_ID;

			-- Return TRUE if present, FALSE if not
			IF LI_COMP_AMOUNT IS NOT NULL THEN
				RETURN 'TRUE';
			ELSE
				RETURN 'FALSE';
			END IF;
    END IF;
    
    END IF;

    -- Condition not met â†’ return TRUE
    RETURN 'TRUE';
END
//
