DELIMITER //
CREATE FUNCTION `FN_OPA_DISCLOSURE_REQUIRED`(
AV_LOGGED_IN_PERSON_ID   VARCHAR(40)
) RETURNS boolean
    DETERMINISTIC
BEGIN

DECLARE LI_OPA_PERSON_COUNT INT DEFAULT 0;

    SELECT COUNT(*) INTO LI_OPA_PERSON_COUNT FROM PERSON_DISCL_REQUIREMENT WHERE PERSON_ID = AV_LOGGED_IN_PERSON_ID AND VERSION_STATUS = 'ACTIVE' AND
        ((CAN_CREATE_OPA = 'Y' OR CREATE_OPA_ADMIN_FORCE_ALLOWED = 'Y') AND
            (OPA_EXEMPT_FROM_DATE IS NULL OR (UTC_TIMESTAMP() NOT BETWEEN OPA_EXEMPT_FROM_DATE AND OPA_EXEMPT_TO_DATE)));

    IF LI_OPA_PERSON_COUNT > 0 THEN
        RETURN true;
    END IF;
    RETURN false;

END
//
