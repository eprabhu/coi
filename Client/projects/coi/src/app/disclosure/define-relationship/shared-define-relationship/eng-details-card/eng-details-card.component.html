<div class="card coi-card-regular" id="project_relationship_card_{{projectSfiRelation?.personEntityId}}">
    <div class="card-body" [class.card-body-py-2]="!isCardExpanded">
        <!-- badge, conflict and comment -->
        <div class="d-flex align-items-start justify-content-between">
            <div class="d-flex align-items-center col gap-2">
                <h4 class="d-flex align-items-center col mb-0 coi-text-darker">
                    <!-- icon -->
                    <span class="coi-icon-bg me-2 fs-14 d-inline-flex"><mat-icon aria-hidden="true" class="coi-entity-icon-size coi-coloured-icons">domain</mat-icon></span>
                    <!-- Entity Name -->
                    <div class="d-flex flex-column">
                        <div class="d-flex align-items-center">
                            <a class="fs-6 link-primary" tabindex="0"
                                id="rel-eng-entity-{{projectSfiRelation.entityId}}"
                                (click)="viewEntityDetails()" (keyup.enter)="viewEntityDetails()"
                                [attr.aria-label]="'Click here to view details of ' + projectSfiRelation?.personEntity?.entityName"
                                [title]="'Click here to view details of ' + projectSfiRelation?.personEntity?.entityName">
                                <span class="text-slice">{{ projectSfiRelation?.personEntity?.entityName }}</span>
                            </a>
                            <ng-container *ngIf="projectSfiRelation?.personEntity?.entityIsForeign">
                                <app-common-foreign-flag [entityName]="projectSfiRelation?.personEntity?.entityName"></app-common-foreign-flag>
                            </ng-container>
                        </div>
                        <div class="d-none align-items-center">
                            <span aria-label="Relationship" class="coi-text-dark me-2">Relationship</span>
                            <div *ngIf="projectSfiRelation?.personEntity?.personEntityRelations?.length; else showNoData">
                                <div class="coi-relationship-pill-container">
                                    <ng-container *ngFor="let sfiRelations of projectSfiRelation?.personEntity?.personEntityRelations; let isFirst = first; let outerIndex = index;">
                                        <span class="coi-relationship-pill">
                                            <span class="d-flex align-items-center coi-relationship-pill-text fs-13">
                                                <!-- <mat-icon aria-hidden="true" class="flex-shrink-0 me-1">{{ ENGAGEMENT_TYPE_ICONS[sfiRelations?.relationshipType] }}</mat-icon> -->
                                                <span>{{ sfiRelations?.relationshipType }}</span>
                                                <ng-container *ngIf="!commonService?.isCompensatedFlow && sfiRelations?.relations?.length">
                                                    <span class="me-1 coi-text-light fs-13">:</span>
                                                    <ng-container *ngFor="let relation of sfiRelations.relations; let isLastRelation = last;">
                                                        <span class="fw-normal fs-13">{{ relation }}</span>
                                                        <span *ngIf="!isLastRelation" class="px-1 fs-13">/</span>
                                                    </ng-container>
                                                </ng-container>
                                            </span>
                                        </span>
                                        <span *ngIf="commonService.isSfiEvaluationEnabled && projectSfiRelation?.personEntity?.isSignificantFinInterest && ENGAGEMENT_LOCALIZE.TERM_FINANCIAL_FOR_REL_PILLS === sfiRelations?.relationshipType"
                                            class="coi-relationship-pill">
                                            <span class="d-flex coi-relationship-pill-text lh-sm fs-13">
                                                <!-- <img src="{{deployMap}}assets/images/sfi.svg" alt="{{ ENGAGEMENT_LOCALIZE.TERM_SFI_FOR_REL_PILLS }} Image" class="coi-sfi-icon me-2" aria-hidden="true"> -->
                                                <span>{{ ENGAGEMENT_LOCALIZE.TERM_SFI_FOR_REL_PILLS }}</span>
                                            </span>
                                        </span>
                                    </ng-container>
                                </div>
                            </div>
                            <ng-template #showNoData>--</ng-template>
                        </div>
                    </div>
                </h4>
            </div>
            <div class="d-flex align-items-center col-auto ms-3 gap-2 py-1 coi-me-n-10px">
                <!-- Conflict Status -->
                <div *ngIf="!defineRelationshipService.isEditMode && projectSfiRelation?.coiDisclEntProjDetails?.length" class="d-flex align-items-center">
                    <label class="coi-text-light me-2 fw-500 d-block d-lg-inline"
                        for="coi_project_relationship_conflict-status_{{projectSfiRelation?.personEntityId}}">Conflict Status:</label>
                    <span class="{{DISCLOSURE_CONFLICT_STATUS_BADGE[projectSfiRelation?.conflictStatusCode]}}"></span>
                    <span class="badgeFont" id="coi_project_relationship_conflict-status_{{projectSfiRelation?.personEntityId}}">{{projectSfiRelation?.conflictStatus}}</span>
                </div>
                <div *ngIf="isShowEngagementRisk" class="d-flex align-items-center fs-14 gap-1 me-2">
                    <span class="coi-text-lighter">Risk:</span>
                    <span id="coi-entity-risk-{{projectSfiRelation?.personEntityId}}" class="coi-text-light">
                        <app-no-data-label [valueToShow]="projectSfiRelation?.entityRiskLevelCode">
                            <span class="d-flex">
                                <mat-icon aria-hidden="true" class="flex-shrink-0 me-1"
                                    [ngClass]="riskIconColor[projectSfiRelation?.entityRiskLevelCode] || riskIconColor['NA']">warning</mat-icon>
                                <span class="coi-text-dark">{{ projectSfiRelation?.entityRiskLevel }}</span>
                            </span>
                        </app-no-data-label>
                    </span>
                </div>
                <!-- engagement view -->
                <button *ngIf="defineRelationshipService.currentRelationSwitch === 'ENGAGEMENTS'"
                    class="d-flex align-items-center btn btn-outline-grey coi-btn-sm fs-14 gap-1"
                    id="coi-engagement-view-btn-{{projectSfiRelation?.personEntityId}}"
                    (click)="openEngagementSlider(projectSfiRelation?.personEntityId)"
                    aria-label="Click here to view engagement" title="Click here to view engagement">
                    <mat-icon aria-hidden="true">visibility</mat-icon>
                </button>
                <!-- comments -->
                <button *ngIf="!defineRelationshipService.isEditMode && isShowCommentButton" 
                    id="coi_project_relationship_comment_{{projectSfiRelation?.personEntityId}}"
                    class="d-flex align-items-center btn btn-outline-grey coi-btn-sm fs-14 gap-1 position-relative"
                    title="Click here to open comment" aria-label="Click here to open comment"
                    (click)="openReviewerComment(projectSfiRelation)">
                    <mat-icon aria-hidden="true" class="flex-shrink-0 coi-comment-icon-size">rate_review</mat-icon>
                    <span *ngIf="relationshipCommentCount > 0"
                        [ngClass]="{'comment-count-icon-large':  relationshipCommentCount > 99, 'comment-count-icon':   relationshipCommentCount <= 99 }"
                        class="position-absolute bg-danger fs-10">{{ relationshipCommentCount > 99 ? '99+' : relationshipCommentCount }}</span>
                </button>
                <!-- previous next -->
                <div *ngIf="isShowPrevNextBtn" class="btn-group">
                    <!-- previous btn -->
                    <button id="coi_project_relationship_prev_{{projectSfiRelation?.personEntityId}}" (click)="navigateToPrevProject()"
                        class="d-flex align-items-center btn btn-sm fs-14 ps-1 rounded-start-5" [disabled]="previousIndex == null"
                        [ngClass]="previousIndex == null ? 'btn-secondary opacity-50' : 'btn-outline-grey'"
                        [title]="previousIndex == null ? '' : 'Click here to go to previous project'"
                        [attr.aria-label]="previousIndex == null ? '' : 'Click here to go to previous project'">
                        <mat-icon aria-hidden="true">navigate_before</mat-icon>
                        <span>Prev</span>
                    </button>
                    <!-- next btn -->
                    <button id="coi_project_relationship_next_{{projectSfiRelation?.personEntityId}}" (click)="navigateToNextProject()"
                        class="d-flex align-items-center btn btn-outline-grey btn-sm fs-14 pe-1 rounded-end-5" [disabled]="nextIndex == null"
                        [ngClass]="nextIndex == null ? 'btn-secondary opacity-50' : 'btn-outline-grey'"
                        [title]="nextIndex == null ? '' : 'Click here to go to next project'"
                        [attr.aria-label]="nextIndex == null ? '' : 'Click here to go to next project'">
                        <span>Next</span>
                        <mat-icon aria-hidden="true">navigate_next</mat-icon>
                    </button>
                </div>
                <!-- toggle -->
                <button (click)="expandCollapseProjectCard()" id="coi_project_relationship_toggle_{{projectSfiRelation?.personEntityId}}"
                    title="Click here to collapse / expand" aria-label="Click here to collapse / expand"
                    class="toggle-btn align-items-center border btn d-flex justify-content-center p-0 rounded-5 shadow-sm position-static">
                    <mat-icon aria-hidden="true" [ngClass]="isCardExpanded ? 'coi-rotate-180' : 'coi-rotate-0'">expand_more</mat-icon>
                </button>
            </div>
        </div>
        <!-- eng details -->
        <div *ngIf="isCardExpanded" class="row row-gap-2 pt-2">
            <!-- Country -->
            <div class="col-6 col-sm-4 col-md-3 col-lg-3 col-xl-3 col-xxl-3"
                [attr.aria-label]="'Country is ' + (projectSfiRelation?.personEntity?.countryName
                    ? projectSfiRelation?.personEntity?.countryName : 'empty')">
                <span class="coi-text-dark d-block text-nowrap">Country</span>
                <span class="text-slice"
                    [title]="projectSfiRelation?.personEntity?.countryName">
                    <app-no-data-label [valueToShow]="projectSfiRelation?.personEntity?.countryName"></app-no-data-label>
                </span>
            </div>
            <!-- Involvement Start Date -->
            <div class="col-6 col-sm-4 col-md-3 col-lg-3 col-xl-3 col-xxl-3"
                [attr.aria-label]="'Involvement Start Date is ' + (projectSfiRelation?.personEntity?.involvementStartDate
                    ? (projectSfiRelation?.personEntity?.involvementStartDate | dateFormatter) : 'empty')">
                <span class="coi-text-dark d-block text-nowrap">Involvement Start Date</span>
                <span class="text-slice"
                    [title]="projectSfiRelation?.personEntity?.involvementStartDate | dateFormatter">
                    <app-no-data-label [valueToShow]="projectSfiRelation?.personEntity?.involvementStartDate | dateFormatter"></app-no-data-label>
                </span>
            </div>
            <!-- Involvement Start Date -->
            <div class="col-6 col-sm-4 col-md-3 col-lg-3 col-xl-3 col-xxl-3"
                [attr.aria-label]="'Involvement End Date is ' + (projectSfiRelation?.personEntity?.involvementEndDate
                    ? (projectSfiRelation?.personEntity?.involvementEndDate | dateFormatter) : 'empty')">
                <span class="coi-text-dark d-block text-nowrap">Involvement End Date</span>
                <span class="text-slice"
                    [title]="projectSfiRelation?.personEntity?.involvementEndDate | dateFormatter">
                    <app-no-data-label [valueToShow]="projectSfiRelation?.personEntity?.involvementEndDate | dateFormatter"></app-no-data-label>
                </span>
            </div>
            <!-- Relationship -->
            <div class="d-flex align-items-center">
                <span aria-label="Relationship" class="coi-text-dark me-2">Relationship</span>
                <div *ngIf="projectSfiRelation?.personEntity?.personEntityRelations?.length; else showNoData">
                    <div class="coi-relationship-pill-container">
                        <ng-container *ngFor="let sfiRelations of projectSfiRelation?.personEntity?.personEntityRelations; let isFirst = first; let outerIndex = index;">
                            <span class="coi-relationship-pill">
                                <span class="d-flex align-items-center coi-relationship-pill-text fs-14">
                                    <mat-icon aria-hidden="true" class="flex-shrink-0 me-1">{{ ENGAGEMENT_TYPE_ICONS[sfiRelations?.relationshipType] }}</mat-icon>
                                    <span>{{ sfiRelations?.relationshipType }}</span>
                                    <ng-container *ngIf="!commonService?.isCompensatedFlow && sfiRelations?.relations?.length">
                                        <span class="me-1 coi-text-light fs-14">:</span>
                                        <ng-container *ngFor="let relation of sfiRelations.relations; let isLastRelation = last;">
                                            <span class="fw-normal fs-14">{{ relation }}</span>
                                            <span *ngIf="!isLastRelation" class="px-1 fs-14">/</span>
                                        </ng-container>
                                    </ng-container>
                                </span>
                            </span>
                            <span *ngIf="commonService.isSfiEvaluationEnabled && projectSfiRelation?.personEntity?.isSignificantFinInterest && ENGAGEMENT_LOCALIZE.TERM_FINANCIAL_FOR_REL_PILLS === sfiRelations?.relationshipType"
                                class="coi-relationship-pill">
                                <span class="d-flex coi-relationship-pill-text lh-sm fs-14">
                                    <img src="{{deployMap}}assets/images/sfi.svg" alt="{{ ENGAGEMENT_LOCALIZE.TERM_SFI_FOR_REL_PILLS }} Image" class="coi-sfi-icon me-2" aria-hidden="true">
                                    <span>{{ ENGAGEMENT_LOCALIZE.TERM_SFI_FOR_REL_PILLS }}</span>
                                </span>
                            </span>
                        </ng-container>
                    </div>
                </div>
                <ng-template #showNoData>--</ng-template>
            </div>
        </div>
    </div>
</div>
